<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/sholck2.jfif"><link rel="icon" type="image/png" sizes="32x32" href="/images/sholck2.jfif"><link rel="icon" type="image/png" sizes="16x16" href="/images/sholck2.jfif"><link rel="mask-icon" href="/images/sholck2.jfif" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Noto Serif SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"sholck.top",root:"/",scheme:"Muse",version:"7.8.0",exturl:!1,sidebar:{position:"right",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="程序分析利器perf简介全称为performance counter，是一个linux内核实现的框架来进行性能分析，覆盖了硬件CPU&#x2F;PMU和（软件计数器，监测点）之类的特性。 本文重点介绍perf的使用和实践，不对原理性知识进行讲解"><meta property="og:type" content="article"><meta property="og:title" content="程序分析利器perf"><meta property="og:url" content="http://sholck.top/archives/6.html"><meta property="og:site_name" content="Sholck"><meta property="og:description" content="程序分析利器perf简介全称为performance counter，是一个linux内核实现的框架来进行性能分析，覆盖了硬件CPU&#x2F;PMU和（软件计数器，监测点）之类的特性。 本文重点介绍perf的使用和实践，不对原理性知识进行讲解"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-03-29T16:00:00.000Z"><meta property="article:modified_time" content="2022-03-30T09:24:07.854Z"><meta property="article:author" content="Sholck"><meta property="article:tag" content="linux"><meta property="article:tag" content="稳定性"><meta property="article:tag" content="kernel-tool"><meta property="article:tag" content="程序调试"><meta property="article:tag" content="perf"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://sholck.top/archives/6.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>程序分析利器perf | Sholck</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="Sholck" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">Sholck</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">不积跬步,无以至千里.不积小流,无以成江海</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">50</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">4</span></a></li><li class="menu-item menu-item-project"><a href="/project/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>项目</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://sholck.top/archives/6.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="Sholck"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Sholck"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">程序分析利器perf</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-30 00:00:00 / 修改时间：17:24:07" itemprop="dateCreated datePublished" datetime="2022-03-30T00:00:00+08:00">2022-03-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>15k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>14 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="程序分析利器perf"><a href="#程序分析利器perf" class="headerlink" title="程序分析利器perf"></a>程序分析利器perf</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>全称为performance counter，是一个linux内核实现的框架来进行性能分析，覆盖了硬件CPU/PMU和（软件计数器，监测点）之类的特性。</p><p>本文重点介绍perf的使用和实践，不对原理性知识进行讲解</p><a id="more"></a><hr><h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><h3 id="硬件"><a href="#硬件" class="headerlink" title="硬件"></a>硬件</h3><h4 id="cpu流水线"><a href="#cpu流水线" class="headerlink" title="cpu流水线"></a>cpu流水线</h4><h4 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h4><h4 id="tick"><a href="#tick" class="headerlink" title="tick"></a>tick</h4><p>时钟周期，假设一台处理器的处理频率为2GHZ，那么时钟周期为2GHZ，一次tick的时间间隔为1/2ns</p><h3 id="软件"><a href="#软件" class="headerlink" title="软件"></a>软件</h3><h4 id="clock-tick"><a href="#clock-tick" class="headerlink" title="clock tick"></a>clock tick</h4><p>时钟滴答，在经过多个时钟周期后，机器内部会产生一次时钟滴答，即一次时钟中断，用来对任务进行管理。</p><h4 id="tracepoints"><a href="#tracepoints" class="headerlink" title="tracepoints"></a>tracepoints</h4><p>追踪点，由ftrace框架实现，一些函数在内核中被特殊标记，在运行到这些函数时进行函数记录并记录在内核环形缓冲区，消耗时间很小，并可以通过文件节点打印出来，详见<code>/sys/kernel/debug/tracing</code></p><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>perf通过进行事件采样来对性能进行分析，事件根据类型分为几类：</p><ol><li>Kernel PMU event</li><li>Hardware event 比如 branch-miss</li><li>Hardware cache event dTLB和iTLB相关，即数据转换后备缓存区和指令转换后备缓冲区</li><li>software event 比如 cpu-migrations</li><li>tracepoints</li></ol><h3 id="缩写"><a href="#缩写" class="headerlink" title="缩写"></a>缩写</h3><ol><li>IPC：每个时钟周期内的指令数</li><li>PMU：performance monitoring units</li></ol><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install perf-tools-unstable</span><br></pre></td></tr></table></figure><h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h4><p>常用的参数如下：</p><ol><li>-e 指定事件</li><li>-p 指定pid</li></ol><h4 id="perf-help"><a href="#perf-help" class="headerlink" title="perf help"></a>perf help</h4><p>通过<code>perf --help</code>打印全部的命令，perf 的全部选项命令如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">bench           General framework for benchmark suites   基准测试</span><br><span class="line">test            Runs sanity tests.  检查系统是否支持perf的全部功能</span><br><span class="line"></span><br><span class="line">list            List all symbolic event types</span><br><span class="line">top             System profiling tool.    实时热点事件分析</span><br><span class="line">stat            Run a command and gather performance counter statistics</span><br><span class="line">record          Run a command and record its profile into perf.data</span><br><span class="line">report          Read perf.data (created by perf record) and display the profile</span><br><span class="line">probe           Define new dynamic tracepoints   动态追踪点</span><br><span class="line"></span><br><span class="line">trace           strace inspired tool            同strace功能</span><br><span class="line">kmem            Tool to trace/measure kernel memory properties  kernel内存       </span><br><span class="line">lock            Analyze lock events          </span><br><span class="line">mem             Profile memory accesses</span><br><span class="line">sched           Tool to trace/measure scheduler properties (latencies)     调度子系统</span><br><span class="line">kvm             Tool to trace/measure kvm guest os</span><br><span class="line"></span><br><span class="line">timechart       Tool to visualize total system behavior during a workload</span><br><span class="line">evlist          List the event names in a perf.data file  列出record文件的所有事件</span><br></pre></td></tr></table></figure><h4 id="perf-bench"><a href="#perf-bench" class="headerlink" title="perf bench"></a>perf bench</h4><p>系统基准测试，通过对4个子系统的运行来评估系统性能</p><h5 id="sched"><a href="#sched" class="headerlink" title="sched"></a>sched</h5><p>包括进程调度和IPC进程通信（socket和pipe）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kernel_tool_test_C/ $ perf bench sched all                                                 # Running sched/messaging benchmark...      &gt;&gt;20个进程对通信</span><br><span class="line"><span class="meta">#</span><span class="bash"> 20 sender and receiver processes per group</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 10 groups == 400 processes run</span></span><br><span class="line"></span><br><span class="line">     Total time: 0.031 [sec]</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Running <span class="built_in">sched</span>/pipe benchmark...</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Executed 1000000 pipe operations between two processes  </span></span><br><span class="line"></span><br><span class="line">     Total time: 6.182 [sec]</span><br><span class="line"></span><br><span class="line">       6.182868 usecs/op</span><br><span class="line">         161737 ops/sec</span><br></pre></td></tr></table></figure><h5 id="mem"><a href="#mem" class="headerlink" title="mem"></a>mem</h5><p>内存copy性能评估，包括两种方式memcpy和memset，结果显示为吞吐率</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kernel_tool_test_C/ $ perf bench mem all                                                             # Running mem/memcpy benchmark...</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">function</span> <span class="string">&#x27;default&#x27;</span> (Default memcpy() provided by glibc)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Copying 1MB bytes ...</span></span><br><span class="line"></span><br><span class="line">      25.699013 GB/sec</span><br></pre></td></tr></table></figure><h5 id="futex"><a href="#futex" class="headerlink" title="futex"></a>futex</h5><p>锁压力评估</p><h4 id="perf-list"><a href="#perf-list" class="headerlink" title="perf  list"></a>perf list</h4><p>打印系统支持的事件 <code>sudo perf list</code>, 之后在 perf 的其他命令中可以-e 指定事件</p><p>这些事件中hw，PMU， cache属于硬件， sw属于内核计数器，Tracepoints event属于ftrace捕捉的内核追踪点</p><h5 id="软件evnet"><a href="#软件evnet" class="headerlink" title="软件evnet"></a>软件evnet</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">alignment-faults                                   [Software event]</span><br><span class="line">bpf-output                                         [Software event]</span><br><span class="line">context-switches OR cs                             [Software event]</span><br><span class="line">cpu-clock                                          [Software event]</span><br><span class="line">cpu-migrations OR migrations                       [Software event]</span><br><span class="line">dummy                                              [Software event]</span><br><span class="line">emulation-faults                                   [Software event]</span><br><span class="line">major-faults                                       [Software event]</span><br><span class="line">minor-faults                                       [Software event]</span><br><span class="line">page-faults OR faults                              [Software event]</span><br><span class="line">task-clock                                         [Software event]</span><br></pre></td></tr></table></figure><h5 id="硬件event"><a href="#硬件event" class="headerlink" title="硬件event"></a>硬件event</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">branch-instructions OR branches                    [Hardware event]</span><br><span class="line">branch-misses                                      [Hardware event]</span><br><span class="line">bus-cycles                                         [Hardware event]</span><br><span class="line">cache-misses                                       [Hardware event]</span><br><span class="line">cache-references                                   [Hardware event]</span><br><span class="line">cpu-cycles OR cycles                               [Hardware event]</span><br><span class="line">instructions                                       [Hardware event]</span><br><span class="line">ref-cycles                                         [Hardware event]</span><br></pre></td></tr></table></figure><h5 id="cache-evnet"><a href="#cache-evnet" class="headerlink" title="cache evnet"></a>cache evnet</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">L1-dcache-load-misses                              [Hardware cache event]</span><br><span class="line">L1-dcache-loads                                    [Hardware cache event]</span><br><span class="line">L1-dcache-stores                                   [Hardware cache event]</span><br><span class="line">L1-icache-load-misses                              [Hardware cache event]</span><br><span class="line">LLC-load-misses                                    [Hardware cache event]</span><br><span class="line">LLC-loads                                          [Hardware cache event]</span><br><span class="line">LLC-store-misses                                   [Hardware cache event]</span><br><span class="line">LLC-stores                                         [Hardware cache event]</span><br><span class="line">branch-load-misses                                 [Hardware cache event]</span><br><span class="line">branch-loads                                       [Hardware cache event]</span><br><span class="line">dTLB-load-misses                                   [Hardware cache event]</span><br><span class="line">dTLB-loads                                         [Hardware cache event]</span><br><span class="line">dTLB-store-misses                                  [Hardware cache event]</span><br><span class="line">dTLB-stores                                        [Hardware cache event]</span><br><span class="line">iTLB-load-misses                                   [Hardware cache event]</span><br><span class="line">iTLB-loads                                         [Hardware cache event]</span><br><span class="line">node-load-misses                                   [Hardware cache event]</span><br><span class="line">node-loads                                         [Hardware cache event]</span><br><span class="line">node-store-misses                                  [Hardware cache event]</span><br><span class="line">node-stores                                        [Hardware cache event]</span><br></pre></td></tr></table></figure><h5 id="PMU-event"><a href="#PMU-event" class="headerlink" title="PMU event"></a>PMU event</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">branch-instructions OR cpu/branch-instructions/    [Kernel PMU event]</span><br><span class="line">branch-misses OR cpu/branch-misses/                [Kernel PMU event]</span><br><span class="line">bus-cycles OR cpu/bus-cycles/                      [Kernel PMU event]</span><br><span class="line">cache-misses OR cpu/cache-misses/                  [Kernel PMU event]</span><br><span class="line">cache-references OR cpu/cache-references/          [Kernel PMU event]</span><br><span class="line">cpu-cycles OR cpu/cpu-cycles/                      [Kernel PMU event]</span><br><span class="line">cycles-ct OR cpu/cycles-ct/                        [Kernel PMU event]</span><br><span class="line">cycles-t OR cpu/cycles-t/                          [Kernel PMU event]</span><br><span class="line">el-abort OR cpu/el-abort/                          [Kernel PMU event]</span><br><span class="line">el-capacity OR cpu/el-capacity/                    [Kernel PMU event]</span><br><span class="line">el-commit OR cpu/el-commit/                        [Kernel PMU event]</span><br><span class="line">el-conflict OR cpu/el-conflict/                    [Kernel PMU event]</span><br><span class="line">el-start OR cpu/el-start/                          [Kernel PMU event]</span><br><span class="line">instructions OR cpu/instructions/                  [Kernel PMU event]</span><br><span class="line">intel_bts//                                        [Kernel PMU event]</span><br><span class="line">intel_cqm/llc_occupancy/                           [Kernel PMU event]</span><br><span class="line">intel_cqm/local_bytes/                             [Kernel PMU event]</span><br><span class="line">intel_cqm/total_bytes/                             [Kernel PMU event]</span><br><span class="line">intel_pt//                                         [Kernel PMU event]</span><br><span class="line">mem-loads OR cpu/mem-loads/                        [Kernel PMU event]</span><br><span class="line">mem-stores OR cpu/mem-stores/                      [Kernel PMU event]</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h5 id="tracepoint-evnet"><a href="#tracepoint-evnet" class="headerlink" title="tracepoint evnet"></a>tracepoint evnet</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alarmtimer:alarmtimer_cancel                       [Tracepoint event]</span><br><span class="line">alarmtimer:alarmtimer_fired                        [Tracepoint event]</span><br><span class="line">alarmtimer:alarmtimer_start                        [Tracepoint event]</span><br><span class="line">alarmtimer:alarmtimer_suspend                      [Tracepoint event]</span><br><span class="line">block:block_bio_backmerge                          [Tracepoint event]</span><br></pre></td></tr></table></figure><h4 id="perf-top"><a href="#perf-top" class="headerlink" title="perf top"></a>perf top</h4><h5 id="打印说明"><a href="#打印说明" class="headerlink" title="打印说明"></a>打印说明</h5><p>可以实时生成和显示系统中事件计数的函数排名，新版内核可以查看函数对应的汇编指令</p><ol><li><p>第一列 Overhead指事件比例</p></li><li><p>第二列 DOS (Dynamic Shared Object) 可以为kernel，应用程序perf，动态链接库libc-2.23.so，模块</p></li><li><p>第三列 DOS类型 [k]表示对象属于内核或者模块， [.]表示对象为二进制程序，为应用程序或者动态链接库</p></li><li><p>第四列 符号名，没有symbols的显示为地址</p></li></ol><p>ubuntu服务器上执行如下，默认为cycles，即cpu周期占用比例</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Samples: 2K of event &#x27;cycles&#x27;, Event count (approx.): 507514780</span><br><span class="line">Overhead  Shared Object            Symbol</span><br><span class="line">   4.11%  [kernel]                 [k] delay_tsc</span><br><span class="line">   2.78%  [kernel]                 [k] kstat_irqs</span><br><span class="line">   2.51%  perf                     [.] 0x00000000000a4784</span><br><span class="line">   2.32%  libc-2.23.so             [.] _int_malloc</span><br><span class="line">   2.03%  [kernel]                 [k] _find_next_bit.part.0</span><br><span class="line">   1.84%  [kernel]                 [k] ixgbe_read_reg</span><br><span class="line">   1.52%  [kernel]                 [k] vsnprintf</span><br><span class="line">   1.31%  [kernel]                 [k] kallsyms_expand_symbol.constprop.1</span><br><span class="line">   1.31%  [kernel]                 [k] update_blocked_averages</span><br><span class="line">   1.28%  [kernel]                 [k] format_decode</span><br><span class="line">   1.25%  perf                     [.] 0x0000000000099837</span><br></pre></td></tr></table></figure><p>手机上执行如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> PerfTop:     418 irqs/sec  kernel:72.2%  exact:  0.0% [4000Hz cycles:ppp],  (all, 8 CPUs)   </span><br><span class="line">---------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">  14.42%  [kernel]          [k] 0xffffff8008bcb854         &gt;&gt;地址                                  </span><br><span class="line">   9.80%  [kernel]          [k] 0xffffff8008fc6acc                                           </span><br><span class="line">   9.08%  [kernel]          [k] 0xffffff8008fc6a68                                           </span><br><span class="line">   1.90%  [kernel]          [k] 0xffffff80080820a8                                           </span><br><span class="line">   0.94%  [kernel]          [k] 0xffffff8008301c00                                           </span><br><span class="line">   0.84%  perf              [.] 0x0000000000088250                                           </span><br><span class="line">   0.75%  [kernel]          [k] 0xffffff8008bf9928                                           </span><br><span class="line">   0.63%  [kernel]          [k] 0xffffff8008fa5550                                           </span><br><span class="line">   0.55%  perf              [.] 0x00000000000d87b8                                           </span><br></pre></td></tr></table></figure><p>因为权限设置，无法获取symbols，因为无法将地址转化为函数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Failed to open [kernel.kallsyms], continuing without symbols</span><br><span class="line">Warning:</span><br><span class="line">Kernel address maps (/proc/&#123;kallsyms,modules&#125;) are restricted.</span><br><span class="line"></span><br><span class="line">Check /proc/sys/kernel/kptr_restrict.</span><br><span class="line"></span><br><span class="line">Kernel samples will not be resolved.</span><br></pre></td></tr></table></figure><h5 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h5><table><thead><tr><th align="center">参数</th><th align="left">说明</th></tr></thead><tbody><tr><td align="center">-e</td><td align="left">指定事件</td></tr><tr><td align="center">-d</td><td align="left">指定屏幕刷新间隔</td></tr><tr><td align="center">-K</td><td align="left">不显示内核或者模块对象</td></tr><tr><td align="center">-U</td><td align="left">不显示上层应用或者动态链接库</td></tr><tr><td align="center">-p</td><td align="left">对指定的进程和其创建的线程采样</td></tr></tbody></table><h4 id="perf-stat"><a href="#perf-stat" class="headerlink" title="perf stat"></a>perf stat</h4><p>对一个命令或者程序进行事件统计</p><h5 id="打印说明-1"><a href="#打印说明-1" class="headerlink" title="打印说明"></a>打印说明</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kernel_tool_test_C/ $ sudo perf stat ./test-run</span><br><span class="line">.....</span><br><span class="line"> Performance counter stats for &#x27;./test-run&#x27;:</span><br><span class="line"></span><br><span class="line">          1.206903      task-clock (msec)         #    0.000 CPUs utilized   &gt;&gt;CPU利用率</span><br><span class="line">                 4      context-switches          #    0.003 M/sec           &gt;&gt;上下文切换</span><br><span class="line">                 1      cpu-migrations            #    0.829 K/sec           &gt;&gt;CPU调度迁移</span><br><span class="line">               119      page-faults               #    0.099 M/sec           &gt;&gt;缺页异常</span><br><span class="line">         2,804,835      cycles                    #    2.324 GHz             &gt;&gt;处理器周期数</span><br><span class="line">         1,627,455      instructions              #    0.58  insn per cycle   &gt;&gt;指令数</span><br><span class="line">           338,915      branches                  #  280.814 M/sec            &gt;&gt;分支指令数</span><br><span class="line">            14,436      branch-misses             #    4.26% of all branches   &gt;&gt;预测错误的分支指令数</span><br><span class="line"></span><br><span class="line">      12.012281176 seconds time elapsed</span><br></pre></td></tr></table></figure><h5 id="常用命令-1"><a href="#常用命令-1" class="headerlink" title="常用命令"></a>常用命令</h5><p>-e和-p为通用选项</p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>-r</td><td>重复指定命令n次，结果显示标准偏差和期望的比值</td></tr><tr><td>-d</td><td>打印更多信息，包括L1和LLC（L3，三级缓存，数据共享）数据缓存</td></tr><tr><td>-d -d</td><td>打印更多信息， 包括dTLB和iTLB</td></tr></tbody></table><h4 id="perf-record"><a href="#perf-record" class="headerlink" title="perf record"></a>perf record</h4><p>运行命令并将其事件记录在per.data中，之后通过perf report来展示。一般需要加上-g参数来进行函数调用显示</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">:kernel_tool_test_C/ $ sudo perf record -g ls </span><br><span class="line"></span><br><span class="line">[11:39:23] Makefile  perf.data  perf.data.old  README.md  src  test-run</span><br><span class="line">[ perf record: Woken up 1 times to write data ]</span><br><span class="line">[ perf record: Captured and wrote 0.013 MB perf.data (1 samples) ]</span><br></pre></td></tr></table></figure><h4 id="perf-report"><a href="#perf-report" class="headerlink" title="perf report"></a>perf report</h4><p>读取per.data文件并给出分析显示，可以看出函数的调用逻辑顺序</p><h4 id="perf-probe"><a href="#perf-probe" class="headerlink" title="perf probe"></a>perf probe</h4><p>perf probe可针对内核和ELF进行动态 tracepoint的追踪，更加详细见 <code>man perf-probe</code></p><h5 id="增加动态追踪点"><a href="#增加动态追踪点" class="headerlink" title="增加动态追踪点"></a>增加动态追踪点</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kernel_tool_test_C/ $ sudo perf probe -x test-run test_blk                                           Added new event:</span><br><span class="line">  probe_test:test_blk  (on test_blk in /work/chejian/test/kernel_tool_test_C/test-run)</span><br></pre></td></tr></table></figure><h5 id="抓取动态追踪点"><a href="#抓取动态追踪点" class="headerlink" title="抓取动态追踪点"></a>抓取动态追踪点</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo perf record -e probe_test:test_blk -gaR ./test-run</span><br></pre></td></tr></table></figure><h5 id="删除动态追踪点"><a href="#删除动态追踪点" class="headerlink" title="删除动态追踪点"></a>删除动态追踪点</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kernel_tool_test_C/ $ sudo perf probe -d test_blk                                                     Removed event: probe_test:test_blk</span><br></pre></td></tr></table></figure><h5 id="列出动态追踪点"><a href="#列出动态追踪点" class="headerlink" title="列出动态追踪点"></a>列出动态追踪点</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kernel_tool_test_C/ $ sudo perf probe -l                                                             </span><br><span class="line">  probe:schedule       (on schedule)    &gt;&gt;内核</span><br><span class="line">  probe_test:test_blk  (on test_blk@src/modules/strace/strace.c in /work/chejian/test/kernel_tool_test_C/test-run)   &gt;&gt;ELF程序</span><br></pre></td></tr></table></figure><h4 id="perf-trace"><a href="#perf-trace" class="headerlink" title="perf trace"></a>perf trace</h4><p>同strace，包含抓取syscall的功能</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo perf trace -o output.txt  ./test-run</span><br><span class="line"></span><br><span class="line"> 11993.175 ( 0.003 ms): test-run/267526 rt_sigaction(sig: CHLD, act: 0x7ffc7d5ad570, oact: 0x7ffc7d5ad610, sigsetsize: 8) = 0</span><br><span class="line"> 11993.180 ( 0.012 ms): test-run/267526 open(filename: 0x6031c0, flags: RDWR                                  ) = 4</span><br><span class="line"> 11993.195 ( 0.005 ms): test-run/267526 stat(filename: 0x6031c0, statbuf: 0x7ffc7d5ad828                      ) = 0</span><br><span class="line"> </span><br><span class="line"> 11993.203 ( 0.023 ms): test-run/267526 mmap(len: 32, prot: READ|WRITE, flags: SHARED, fd: 4                  ) = 0x7fdbf0da0000   &gt;&gt;共享内存映射地址， fd为 4</span><br><span class="line"></span><br><span class="line"> 11995.233 ( 0.002 ms): test-run/267526 close(fd: 4                                                           ) = 0</span><br><span class="line"> 11995.239 ( 0.009 ms): test-run/267526 munmap(addr: 0x7fdbf0da0000, len: 32                                  ) = 0</span><br></pre></td></tr></table></figure><p><code>-s</code>和<code>-S</code>选项和strace 下的 <code>-c -w</code>功能类似，都是对调用次数和消耗时间的统计</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> Summary of events:</span><br><span class="line"></span><br><span class="line"> test-run (269586), 8 events, 3.0%</span><br><span class="line"></span><br><span class="line">   syscall            calls    total       min       avg       max      stddev</span><br><span class="line">                               (msec)    (msec)    (msec)    (msec)        (%)</span><br><span class="line"></span><br><span class="line">--------------- -------- --------- --------- --------- ---------     ------</span><br><span class="line"></span><br><span class="line">   nanosleep              1  4995.994  4995.994  4995.994  4995.994      0.00%</span><br><span class="line">   write                  2     0.020     0.008     0.010     0.012     18.33%</span><br><span class="line">   clone                  1     0.000     0.000     0.000     0.000      0.00%</span><br></pre></td></tr></table></figure><p>但是发现write时的字符串参数没有具体打印是啥，只是显示了一个地址，因此strace的write参数可以更好的确定源代码位置</p><h4 id="perf-kmem"><a href="#perf-kmem" class="headerlink" title="perf kmem"></a>perf kmem</h4><p>内核内存的分配统计，一般为slab和page存取两类，操作为record和stat搭配使用</p><h5 id="slab"><a href="#slab" class="headerlink" title="slab"></a>slab</h5><p>slab的解析分为两部分，一部分为<code>--caller</code>导致的Callsite部分，一部分为–alloc导致的Alloc Ptr地址打印部分，具体的打印解释如下：</p><ol><li>Callsite，表示谁调用了kmalloc来进行slab申请</li><li>Total_alloc/Per 表示调用者一共分配的内存和每次平均分配的内存</li><li>Total_req/Per 表示调用者一共申请的内存和每次平均申请的内存</li><li>Hit 表示调用者调用kmalloc的次数</li><li>Ping-pong 多cpu架构kfree和kmalloc的共享内存对应的cpu不同，这看做是一次ping-pong，理想是越小越好。</li><li>Frag 碎片率，为（实际分配-申请）/实际分配</li><li>Alloc Ptr 为申请的地址</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kernel_tool_test_C/ $ sudo perf kmem record --slab ls                                                 </span><br><span class="line"></span><br><span class="line">Makefile  output.svg  output.txt  output.txt.old  perf.data  perf.data.old  README.md  src  test-run</span><br><span class="line">[ perf record: Woken up 0 times to write data ]</span><br><span class="line">[ perf record: Captured and wrote 2.225 MB perf.data (12859 samples) ]</span><br><span class="line"></span><br><span class="line">kernel_tool_test_C/ $ sudo perf kmem --alloc --caller --slab stat</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line"> Callsite                           | Total_alloc/Per | Total_req/Per   | Hit      | Ping-pong | Frag</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line"> proc_reg_open+32                   |        64/64    |        40/40    |        1 |         0 | 37.500%</span><br><span class="line"> apparmor_file_alloc_security+5c    |       608/32    |       456/24    |       19 |         0 | 25.000%</span><br><span class="line"> ext4_readdir+91e                   |        64/64    |        48/48    |        1 |         0 | 25.000%</span><br><span class="line"> ext4_htree_store_dirent+3e         |       800/66    |       698/58    |       12 |         0 | 12.750%</span><br><span class="line"> ....</span><br><span class="line"> </span><br><span class="line"> ---------------------------------------------------------------------------------------------------------</span><br><span class="line"> Alloc Ptr                          | Total_alloc/Per | Total_req/Per   | Hit      | Ping-pong | Frag</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line"> 0xffff995a4bb4c000                 |      1024/1024  |       640/640   |        1 |         0 | 37.500%</span><br><span class="line"> 0xffff995b83910f80                 |       128/64    |        88/44    |        2 |         0 | 31.250%</span><br><span class="line"> 0xffff995c561c3ec0                 |        96/32    |        72/24    |        3 |         0 | 25.000%</span><br></pre></td></tr></table></figure><h5 id="page-to-do"><a href="#page-to-do" class="headerlink" title="page(to do)"></a>page(to do)</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">kernel_tool_test_C/ $ sudo perf kmem record --page --live ls</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> GFP flags</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ---------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 002152c0: I|F|NWR|NR|C|NMA|NT: __GFP_IO|__GFP_FS|__GFP_NOWARN|__GFP_NORETRY|__GFP_COMP|__GFP_NOMEMALLOC|__GFP_NOTRACK</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 01000200:              NW|NWR: GFP_NOWAIT|__GFP_NOWARN</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 014000c0:                   K: GFP_KERNEL</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 014200ca:                 HUM: GFP_HIGHUSER_MOVABLE</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 014280ca:               HUM|Z: GFP_HIGHUSER_MOVABLE|__GFP_ZERO</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 015080c0:               KAC|Z: GFP_KERNEL_ACCOUNT|__GFP_ZERO</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 015200c2:               HU|AC: GFP_HIGHUSER|__GFP_ACCOUNT</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 017080c0:            KAC|Z|NT: GFP_KERNEL_ACCOUNT|__GFP_ZERO|__GFP_NOTRACK</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 01c200ca:              HUM|WR: GFP_HIGHUSER_MOVABLE|__GFP_WRITE</span></span><br><span class="line"></span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line"> Total alloc (KB) | Hits      | Order | Mig.type | GFP flags           | Callsite</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line">              120 |        30 |     0 | UNMOVABL | KAC|Z|NT            | pte_alloc_one</span><br><span class="line">               84 |        21 |     0 |  RECLAIM | HUM|Z               | handle_mm_fault</span><br><span class="line">               40 |        10 |     0 |  RECLAIM | HUM                 | wp_page_copy</span><br><span class="line">               32 |         8 |     0 |  RECLAIM | HUM                 | handle_mm_fault</span><br><span class="line">               20 |         5 |     0 | UNMOVABL | NW|NWR              | tlb_next_batch.isra.42</span><br><span class="line">               20 |         5 |     0 | UNMOVABL | KAC|Z               | __pmd_alloc</span><br><span class="line">               12 |         3 |     0 | UNMOVABL | K                   | __pollwait</span><br><span class="line">                8 |         2 |     0 | UNMOVABL | KAC|Z               | __pud_alloc</span><br><span class="line">                8 |         1 |     1 | UNMOVABL | I|F|NWR|NR|C|NMA|NT | new_slab</span><br><span class="line">                4 |         1 |     0 | UNMOVABL | KAC|Z|NT            | pgd_alloc</span><br><span class="line">                4 |         1 |     0 |  RECLAIM | HUM|WR              | __page_cache_alloc</span><br><span class="line">                4 |         1 |     0 |  RECLAIM | HUM|Z               | wp_page_copy</span><br><span class="line">                4 |         1 |     0 | UNMOVABL | HU|AC               | pipe_write</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line"> PFN              | Total alloc (KB) | Hits      | Order | Mig.type | GFP flags           | Callsite</span><br><span class="line">---------------------------------------------------------------------------------------------------------</span><br><span class="line">         23073150 |                8 |         2 |     0 | UNMOVABL | KAC|Z               | __pmd_alloc</span><br><span class="line">         28346272 |                8 |         1 |     1 | UNMOVABL | I|F|NWR|NR|C|NMA|NT | new_slab</span><br><span class="line">         17327464 |                4 |         1 |     0 | UNMOVABL | KAC|Z|NT            | pte_alloc_one</span><br></pre></td></tr></table></figure><h4 id="perf-lock（todo）"><a href="#perf-lock（todo）" class="headerlink" title="perf lock（todo）"></a>perf lock（todo）</h4><p>内核锁事件分析</p><p>使用：<code>perf lock &#123;record|report|script|info&#125;</code></p><p>条件： 内核需要使能CONFIG_LOCKDEP和CONFIG_LOCK_STAT</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo perf lock record ls                                                                             tracepoint lock:lock_acquire is not enabled. Are CONFIG_LOCKDEP and CONFIG_LOCK_STAT enabled?</span><br></pre></td></tr></table></figure><h4 id="perf-mem"><a href="#perf-mem" class="headerlink" title="perf mem"></a>perf mem</h4><p>内存访问分析，内存操作分为两类，为load和store，对应取和存，对应的事件为<code>cpu/mem-loads,ldlat=30/P</code>和<code>cpu/mem-stores/P</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kernel_tool_test_C/ $ sudo perf mem record ./test-run</span><br><span class="line"></span><br><span class="line">Samples: 22  of event &#x27;cpu/mem-loads,ldlat=30/P&#x27;, Event count (approx.): 4449</span><br><span class="line">Overhead       Samples  Local Weight  Memory access             Symbol                          Shared Object      Data Symbol                      Data Object        Snoop         TLB access              Locked</span><br><span class="line">  12.00%             1  534           LFB hit                   [k] filemap_map_pages           [kernel.kallsyms]  [k] 0xffffd75181feaaa0           [kernel.kallsyms]  None          L1 or L2 hit            No</span><br><span class="line">  11.80%             1  525           LFB hit                   [k] filemap_map_pages           [kernel.kallsyms]  [k] 0xffffd751809b0888           [kernel.kallsyms]  None          L1 or L2 hit            No</span><br><span class="line">   9.78%             1  435           L3 miss                   [k] tty_write                   [kernel.kallsyms]  [k] 0xffff995caac199c0           [kernel.kallsyms]  N/A           L1 or L2 hit            No</span><br><span class="line">   9.44%             1  420           LFB hit                   [k] unmap_page_range            [kernel.kallsyms]  [k] 0xffffd7518094fca0           [kernel.kallsyms]  None          L1 or L2 hit            No</span><br><span class="line">   9.42%             1  419           L1 hit                    [k] page_add_file_rmap          [kernel.kallsyms]  [k] 0xffffd75181fe0d58           [kernel.kallsyms]  None          L1 or L2 hit            Yes</span><br></pre></td></tr></table></figure><h4 id="perf-sched"><a href="#perf-sched" class="headerlink" title="perf sched"></a>perf sched</h4><p>调度器分析</p><p>使用：<code>perf sched &#123;record|latency|map|replay|script&#125;</code></p><h5 id="抓取调度相关事件"><a href="#抓取调度相关事件" class="headerlink" title="抓取调度相关事件"></a>抓取调度相关事件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kernel_tool_test_C/ $ sudo perf sched record ./test-run</span><br></pre></td></tr></table></figure><h5 id="查看调度延迟"><a href="#查看调度延迟" class="headerlink" title="查看调度延迟"></a>查看调度延迟</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kernel_tool_test_C/ $sudo perf sched latency -s runtime</span><br><span class="line"> ----------------------------------------------------------------------------------------------------</span><br><span class="line">  Task  |   Runtime ms  | Switches | Average delay ms | Maximum delay ms | Maximum delay at       |</span><br><span class="line"> ----------------------------------------------------------------------------------------------------</span><br><span class="line"> test-run:(3)          |      1.436 ms |        7 | avg:    0.020 ms | max:    0.068 ms | max at: 9477856.501406 s</span><br></pre></td></tr></table></figure><p>各列的含义如下：</p><ol><li>Task 进程名</li><li>Runtime ms 运行时间</li><li>Switches 进程切换次数</li><li>Average delay 调度平均延迟</li><li>Maximum delay ms 调度最大延迟，是影响较大的因素</li><li>Maximum delay at 调度延迟发生时间点</li></ol><h5 id="打印抓取的调度事件"><a href="#打印抓取的调度事件" class="headerlink" title="打印抓取的调度事件"></a>打印抓取的调度事件</h5><p>各列的含义为：进程名， 进程号， 所在的cpu，时间戳， 调度事件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kernel_tool_test_C/ $ sudo perf sched script</span><br><span class="line">  swapper     0 [005] 9477854.475353:       sched:sched_switch: prev_comm=swapper/5 prev_pid=0 prev_prio=120 prev_state=R ==&gt; next_comm=rcu_sched next_pid=8 next_prio=120</span><br><span class="line">  rcu_sched     8 [005] 9477854.475357:       sched:sched_switch: prev_comm=rcu_sched prev_pid=8 prev_prio=120 prev_state=S ==&gt; next_comm=swapper/5 next_pid=0 next_prio=120</span><br></pre></td></tr></table></figure><h5 id="复现调度场景"><a href="#复现调度场景" class="headerlink" title="复现调度场景"></a>复现调度场景</h5><p>重放record文件中的调度场景，但是当进程有sleep函数时重现就会卡主</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kernel_tool_test_C/ $ sudo perf sched replay    &gt;&gt;复现调度打印卡住，暂无发现实践意义</span><br></pre></td></tr></table></figure><h5 id="调度迁移（上下文切换）"><a href="#调度迁移（上下文切换）" class="headerlink" title="调度迁移（上下文切换）"></a>调度迁移（上下文切换）</h5><p><code>perf sched map</code>可以打印任务在cpu之间直观的调度状态</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kernel_tool_test_C/ $ sudo perf sched map -f</span><br><span class="line">   D0  A0  H0  G0 *R0  L0  .</span><br><span class="line">   D0  A0  H0  G0  R0  L0  .  *S0</span><br><span class="line">   D0  A0  H0  G0  R0  L0 *T0  S0</span><br><span class="line">   D0  A0  H0  G0  R0  L0  T0 *.4</span><br><span class="line">   D0  A0  H0 *P0  R0  L0  T0  .</span><br><span class="line">   D0  A0  H0  P0  R0  L0  T0 *S0</span><br><span class="line">   D0  A0  H0  P0  R0  L0 *.   S0</span><br><span class="line">   D0 *U0  H0  P0  R0  L0  .   S0</span><br><span class="line">  *Q0  U0  H0  P0  R0  L0  .   S0</span><br><span class="line">   Q0  U0  H0 *G0  R0  L0  .   S0</span><br><span class="line">   Q0  U0 *.   G0  R0  L0  .   S0</span><br><span class="line">   Q0  U0  .   G0  R0 *V0  .   S0</span><br><span class="line">   Q0 *A0  .   G0  R0  V0  .   S0</span><br><span class="line">   Q0  A0  .   G0  R0  V0 *W0  S0</span><br></pre></td></tr></table></figure><p>*标示调度事件发生所在的cpu，.表示CPU处于IDEL状态 ，一个正常的map可以显示一个任务的调度会尽力给到闲置的cpu，而不是忙碌的cpu</p><h4 id="perf-evlist"><a href="#perf-evlist" class="headerlink" title="perf evlist"></a>perf evlist</h4><p>显示record文件中的events</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kernel_tool_test_C/ $ sudo perf evlist                                                               sched:sched_switch</span><br><span class="line">sched:sched_stat_wait</span><br><span class="line">sched:sched_stat_sleep</span><br><span class="line">sched:sched_stat_iowait</span><br><span class="line">sched:sched_stat_runtime</span><br><span class="line">sched:sched_process_fork</span><br><span class="line">sched:sched_wakeup</span><br><span class="line">sched:sched_wakeup_new</span><br><span class="line">sched:sched_migrate_task</span><br></pre></td></tr></table></figure><h4 id="perf-timechart"><a href="#perf-timechart" class="headerlink" title="perf timechart"></a>perf timechart</h4><p>一个通过抓取事件转化为直观的视图svg文件来显示调度器，CPU， IO等事件的工具</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kernel_tool_test_C/ $ sudo perf timechart record -I -T ./test-run   </span><br><span class="line">kernel_tool_test_C/ $ sudo perf timechart -p test-run                                                 Written 12.0 seconds of trace to output.svg.   &gt;&gt;需要将文件拖入到浏览器</span><br></pre></td></tr></table></figure></div><div class="popular-posts-header">推荐文章</div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/15.html" rel="bookmark">gdb调试linux内核&驱动模块</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/3.html" rel="bookmark">程序分析利器gdb</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/5.html" rel="bookmark">程序分析利器strace</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/16.html" rel="bookmark">Kbuild-Makefile学习</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/13.html" rel="bookmark">linux-likely学习</a></div></li></ul><footer class="post-footer"><div class="post-tags"><a href="/tags/linux/" rel="tag"># linux</a> <a href="/tags/%E7%A8%B3%E5%AE%9A%E6%80%A7/" rel="tag"># 稳定性</a> <a href="/tags/kernel-tool/" rel="tag"># kernel-tool</a> <a href="/tags/%E7%A8%8B%E5%BA%8F%E8%B0%83%E8%AF%95/" rel="tag"># 程序调试</a> <a href="/tags/perf/" rel="tag"># perf</a></div><div class="post-nav"><div class="post-nav-item"><a href="/archives/5.html" rel="prev" title="程序分析利器strace"><i class="fa fa-chevron-left"></i> 程序分析利器strace</a></div><div class="post-nav-item"><a href="/archives/3.html" rel="next" title="程序分析利器gdb">程序分析利器gdb <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%88%A9%E5%99%A8perf"><span class="nav-number">1.</span> <span class="nav-text">程序分析利器perf</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">1.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86"><span class="nav-number">1.2.</span> <span class="nav-text">背景知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A1%AC%E4%BB%B6"><span class="nav-number">1.2.1.</span> <span class="nav-text">硬件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#cpu%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">cpu流水线</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cache"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">cache</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tick"><span class="nav-number">1.2.1.3.</span> <span class="nav-text">tick</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%AF%E4%BB%B6"><span class="nav-number">1.2.2.</span> <span class="nav-text">软件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#clock-tick"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">clock tick</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tracepoints"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">tracepoints</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-number">1.2.3.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%A9%E5%86%99"><span class="nav-number">1.2.4.</span> <span class="nav-text">缩写</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">1.3.</span> <span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">1.3.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4"><span class="nav-number">1.3.2.</span> <span class="nav-text">命令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E6%95%B0"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#perf-help"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">perf help</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#perf-bench"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">perf bench</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#sched"><span class="nav-number">1.3.2.3.1.</span> <span class="nav-text">sched</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mem"><span class="nav-number">1.3.2.3.2.</span> <span class="nav-text">mem</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#futex"><span class="nav-number">1.3.2.3.3.</span> <span class="nav-text">futex</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#perf-list"><span class="nav-number">1.3.2.4.</span> <span class="nav-text">perf list</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BD%AF%E4%BB%B6evnet"><span class="nav-number">1.3.2.4.1.</span> <span class="nav-text">软件evnet</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%A1%AC%E4%BB%B6event"><span class="nav-number">1.3.2.4.2.</span> <span class="nav-text">硬件event</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#cache-evnet"><span class="nav-number">1.3.2.4.3.</span> <span class="nav-text">cache evnet</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PMU-event"><span class="nav-number">1.3.2.4.4.</span> <span class="nav-text">PMU event</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#tracepoint-evnet"><span class="nav-number">1.3.2.4.5.</span> <span class="nav-text">tracepoint evnet</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#perf-top"><span class="nav-number">1.3.2.5.</span> <span class="nav-text">perf top</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E8%AF%B4%E6%98%8E"><span class="nav-number">1.3.2.5.1.</span> <span class="nav-text">打印说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-number">1.3.2.5.2.</span> <span class="nav-text">常用命令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#perf-stat"><span class="nav-number">1.3.2.6.</span> <span class="nav-text">perf stat</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E8%AF%B4%E6%98%8E-1"><span class="nav-number">1.3.2.6.1.</span> <span class="nav-text">打印说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-1"><span class="nav-number">1.3.2.6.2.</span> <span class="nav-text">常用命令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#perf-record"><span class="nav-number">1.3.2.7.</span> <span class="nav-text">perf record</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#perf-report"><span class="nav-number">1.3.2.8.</span> <span class="nav-text">perf report</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#perf-probe"><span class="nav-number">1.3.2.9.</span> <span class="nav-text">perf probe</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E5%8A%A8%E6%80%81%E8%BF%BD%E8%B8%AA%E7%82%B9"><span class="nav-number">1.3.2.9.1.</span> <span class="nav-text">增加动态追踪点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8A%93%E5%8F%96%E5%8A%A8%E6%80%81%E8%BF%BD%E8%B8%AA%E7%82%B9"><span class="nav-number">1.3.2.9.2.</span> <span class="nav-text">抓取动态追踪点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E5%8A%A8%E6%80%81%E8%BF%BD%E8%B8%AA%E7%82%B9"><span class="nav-number">1.3.2.9.3.</span> <span class="nav-text">删除动态追踪点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%97%E5%87%BA%E5%8A%A8%E6%80%81%E8%BF%BD%E8%B8%AA%E7%82%B9"><span class="nav-number">1.3.2.9.4.</span> <span class="nav-text">列出动态追踪点</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#perf-trace"><span class="nav-number">1.3.2.10.</span> <span class="nav-text">perf trace</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#perf-kmem"><span class="nav-number">1.3.2.11.</span> <span class="nav-text">perf kmem</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#slab"><span class="nav-number">1.3.2.11.1.</span> <span class="nav-text">slab</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#page-to-do"><span class="nav-number">1.3.2.11.2.</span> <span class="nav-text">page(to do)</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#perf-lock%EF%BC%88todo%EF%BC%89"><span class="nav-number">1.3.2.12.</span> <span class="nav-text">perf lock（todo）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#perf-mem"><span class="nav-number">1.3.2.13.</span> <span class="nav-text">perf mem</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#perf-sched"><span class="nav-number">1.3.2.14.</span> <span class="nav-text">perf sched</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8A%93%E5%8F%96%E8%B0%83%E5%BA%A6%E7%9B%B8%E5%85%B3%E4%BA%8B%E4%BB%B6"><span class="nav-number">1.3.2.14.1.</span> <span class="nav-text">抓取调度相关事件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E8%B0%83%E5%BA%A6%E5%BB%B6%E8%BF%9F"><span class="nav-number">1.3.2.14.2.</span> <span class="nav-text">查看调度延迟</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E6%8A%93%E5%8F%96%E7%9A%84%E8%B0%83%E5%BA%A6%E4%BA%8B%E4%BB%B6"><span class="nav-number">1.3.2.14.3.</span> <span class="nav-text">打印抓取的调度事件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A4%8D%E7%8E%B0%E8%B0%83%E5%BA%A6%E5%9C%BA%E6%99%AF"><span class="nav-number">1.3.2.14.4.</span> <span class="nav-text">复现调度场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E5%BA%A6%E8%BF%81%E7%A7%BB%EF%BC%88%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2%EF%BC%89"><span class="nav-number">1.3.2.14.5.</span> <span class="nav-text">调度迁移（上下文切换）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#perf-evlist"><span class="nav-number">1.3.2.15.</span> <span class="nav-text">perf evlist</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#perf-timechart"><span class="nav-number">1.3.2.16.</span> <span class="nav-text">perf timechart</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">Sholck</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">16</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">50</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/xiaer1921" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiaer1921" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:xiaer1921@aliyun.com" title="E-Mail → mailto:xiaer1921@aliyun.com" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/sholck222" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;sholck222" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa-fw"></i>CSDN</a></span></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://hackret.com/" title="https:&#x2F;&#x2F;hackret.com&#x2F;" rel="noopener external nofollow noreferrer" target="_blank">RedHat Kairui</a></li><li class="links-of-blogroll-item"><a href="https://linux-kernel-labs.github.io/refs/heads/master/index.html#" title="https:&#x2F;&#x2F;linux-kernel-labs.github.io&#x2F;refs&#x2F;heads&#x2F;master&#x2F;index.html#" rel="noopener external nofollow noreferrer" target="_blank">Linux Kernel Teaching</a></li><li class="links-of-blogroll-item"><a href="https://tding.top/" title="https:&#x2F;&#x2F;tding.top&#x2F;" rel="noopener external nofollow noreferrer" target="_blank">小丁</a></li><li class="links-of-blogroll-item"><a href="https://xiaozhou.net/" title="https:&#x2F;&#x2F;xiaozhou.net&#x2F;" rel="noopener external nofollow noreferrer" target="_blank">iTimpthy</a></li><li class="links-of-blogroll-item"><a href="https://consen.github.io/" title="https:&#x2F;&#x2F;consen.github.io&#x2F;" rel="noopener external nofollow noreferrer" target="_blank">Consen</a></li></ul></div><div><canvas id="canvas" style="width:60%">当前浏览器不支持canvas，请更换浏览器后再试</canvas></div><script>!function(){var o,a,r,f,t,i=[[[0,0,1,1,1,0,0],[0,1,1,0,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,0,1,1,0],[0,0,1,1,1,0,0]],[[0,0,0,1,1,0,0],[0,1,1,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[1,1,1,1,1,1,1]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,1,1,0,0,0],[0,1,1,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,0,0,1,1],[1,1,1,1,1,1,1]],[[1,1,1,1,1,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,1,1,0],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,0,0,0,1,1,0],[0,0,0,1,1,1,0],[0,0,1,1,1,1,0],[0,1,1,0,1,1,0],[1,1,0,0,1,1,0],[1,1,1,1,1,1,1],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,1,1,1,1]],[[1,1,1,1,1,1,1],[1,1,0,0,0,0,0],[1,1,0,0,0,0,0],[1,1,1,1,1,1,0],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,0,0,0,1,1,0],[0,0,1,1,0,0,0],[0,1,1,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[1,1,1,1,1,1,1],[1,1,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,1,1,0,0,0,0]],[[0,0,0,0,0,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,0,0,0]]],e=document.getElementById("canvas");function h(t,e){for(var n=[1,2,3],l=["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"],o=0;o<i[e].length;o++)for(var a,h=0;h<i[e][o].length;h++){1==i[e][o][h]&&(a={x:14*(f+2)*t+2*h*(f+1)+(f+1),y:2*o*(f+1)+(f+1),stepX:Math.floor(4*Math.random()-2),stepY:-2*n[Math.floor(Math.random()*n.length)],color:l[Math.floor(Math.random()*l.length)],disY:1},r.push(a))}}function n(){e.height=100;for(var t=0;t<a.length;t++)!function(t,e){for(var n=0;n<i[e].length;n++)for(var l=0;l<i[e][n].length;l++)1==i[e][n][l]&&(o.beginPath(),o.arc(14*(f+2)*t+2*l*(f+1)+(f+1),2*n*(f+1)+(f+1),f,0,2*Math.PI),o.closePath(),o.fill())}(t,a[t]);for(t=0;t<r.length;t++)o.beginPath(),o.arc(r[t].x,r[t].y,f,0,2*Math.PI),o.fillStyle=r[t].color,o.closePath(),o.fill()}e.getContext&&(o=e.getContext("2d"),e.height=100,e.width=700,o.fillStyle="#f00",o.fillRect(10,10,50,50),a=[],r=[],f=e.height/20-1,t=/(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date),a.push(t[1],t[2],10,t[3],t[4],10,t[5],t[6]),clearInterval(void 0),setInterval(function(){!function(){var t=[],e=/(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date),n=[];n.push(e[1],e[2],10,e[3],e[4],10,e[5],e[6]);for(var l=a.length-1;0<=l;l--)n[l]!==a[l]&&t.push(l+"_"+(Number(a[l])+1)%10);for(l=0;l<t.length;l++)h.apply(this,t[l].split("_"));a=n.concat()}(),function(){for(var t=0;t<r.length;t++)r[t].stepY+=r[t].disY,r[t].x+=r[t].stepX,r[t].y+=r[t].stepY,(r[t].x>700+f||r[t].y>100+f)&&(r.splice(t,1),t--)}(),n()},50))}()</script><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-history fa-" aria-hidden="true"></i> 近期文章</div><ul class="links-of-blogroll-list"><li><a href="/archives/16.html" title="Kbuild-Makefile学习" target="_blank">Kbuild-Makefile学习</a></li><li><a href="/archives/14.html" title="crash库的开源提交" target="_blank">crash库的开源提交</a></li><li><a href="/archives/15.html" title="gdb调试linux内核&驱动模块" target="_blank">gdb调试linux内核&驱动模块</a></li><li><a href="/archives/13.html" title="linux-likely学习" target="_blank">linux-likely学习</a></li><li><a href="/archives/12.html" title="linux-通知链notifier学习" target="_blank">linux-通知链notifier学习</a></li></ul></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2020 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="user"></i> </span><span class="author" itemprop="copyrightHolder">Sholck</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-chart-area"></i> </span><span class="post-meta-item-text">站点总字数：</span> <span title="站点总字数">149k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">2:15</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener external nofollow noreferrer" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener external nofollow noreferrer" target="_blank">NexT.Muse</a> 强力驱动</div><script src="/lib/mermaid/mermaid.min.js"></script><script>window.mermaid&&mermaid.initialize({theme:"forest"})</script></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><script async src="/js/cursor/fireworks.js"></script><script src="/js/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,document.body.addEventListener("input",POWERMODE)</script></body></html>