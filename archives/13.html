<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/sholck2.jfif"><link rel="icon" type="image/png" sizes="32x32" href="/images/sholck2.jfif"><link rel="icon" type="image/png" sizes="16x16" href="/images/sholck2.jfif"><link rel="mask-icon" href="/images/sholck2.jfif" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Noto Serif SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"sholck.top",root:"/",scheme:"Muse",version:"7.8.0",exturl:!1,sidebar:{position:"right",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="linux-likely学习背景在日常的工作和学习中，经常发现likely和unlikely的使用，在通知链节点注册时，有如下函数 1234567891011121314151617static int notifier_chain_register(struct notifier_block **nl,"><meta property="og:type" content="article"><meta property="og:title" content="linux-likely学习"><meta property="og:url" content="http://sholck.top/archives/13.html"><meta property="og:site_name" content="Sholck"><meta property="og:description" content="linux-likely学习背景在日常的工作和学习中，经常发现likely和unlikely的使用，在通知链节点注册时，有如下函数 1234567891011121314151617static int notifier_chain_register(struct notifier_block **nl,"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-04-14T16:00:00.000Z"><meta property="article:modified_time" content="2022-04-27T08:55:22.185Z"><meta property="article:author" content="Sholck"><meta property="article:tag" content="linux"><meta property="article:tag" content="gdb"><meta property="article:tag" content="objdump"><meta property="article:tag" content="nm"><meta property="article:tag" content="likely"><meta property="article:tag" content="内建函数"><meta property="article:tag" content="gcc"><meta property="article:tag" content="编译优化"><meta property="article:tag" content="汇编"><meta property="article:tag" content="模块编译"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://sholck.top/archives/13.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>linux-likely学习 | Sholck</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="Sholck" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">Sholck</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">不积跬步,无以至千里.不积小流,无以成江海</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">55</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">4</span></a></li><li class="menu-item menu-item-project"><a href="/project/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>项目</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://sholck.top/archives/13.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="Sholck"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Sholck"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">linux-likely学习</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-04-15 00:00:00" itemprop="dateCreated datePublished" datetime="2022-04-15T00:00:00+08:00">2022-04-15</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-04-27 16:55:22" itemprop="dateModified" datetime="2022-04-27T16:55:22+08:00">2022-04-27</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>18k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>17 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="linux-likely学习"><a href="#linux-likely学习" class="headerlink" title="linux-likely学习"></a>linux-likely学习</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在日常的工作和学习中，经常发现likely和unlikely的使用，在通知链节点注册时，有如下函数</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">notifier_chain_register</span><span class="params">(struct notifier_block **nl,                                                                                                                                                      </span></span></span><br><span class="line"><span class="function"><span class="params">                                   struct notifier_block *n)</span>    </span></span><br><span class="line"><span class="function"></span>&#123;                                                                  </span><br><span class="line">        <span class="keyword">while</span> ((*nl) != <span class="literal">NULL</span>) &#123;                                     </span><br><span class="line">                <span class="keyword">if</span> (unlikely((*nl) == n)) &#123;                               </span><br><span class="line">                        WARN(<span class="number">1</span>, <span class="string">&quot;notifier callback %ps already registered&quot;</span>,    </span><br><span class="line">                             n-&gt;notifier_call);                               </span><br><span class="line">                        <span class="keyword">return</span> -EEXIST;                          </span><br><span class="line">                &#125;                                                </span><br><span class="line">                <span class="keyword">if</span> (n-&gt;priority &gt; (*nl)-&gt;priority)               </span><br><span class="line">                        <span class="keyword">break</span>;                                   </span><br><span class="line">                nl = &amp;((*nl)-&gt;next);                                        </span><br><span class="line">        &#125;                                                        </span><br><span class="line">        n-&gt;next = *nl;                                        </span><br><span class="line">        rcu_assign_pointer(*nl, n);                           </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里通过遍历节点和插入节点地址对比，防止程序运行时重复插入通知链节点。当然，重复插入这种情况下是非常少见的，因此编译器针对此进行了性能优化。</p><a id="more"></a><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//include/linux/compiler.h</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> likely(x)      __builtin_expect(!!(x), 1)    </span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> unlikely(x)    __builtin_expect(!!(x), 0)</span></span><br></pre></td></tr></table></figure><p>内核未见<code>__builtin_expect</code>的实现，为编译器实现，称为内建函数，最后深入研究</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>处理器的流水线处理，处理器在取指，执行等都是并行执行的，提前取指可以提高性能，但是提前取指是一个预测的过程，如果预测错误，会导致branch miss，需要重新取指(属于跳转取指，但是跳转取指是比较耗时的)，这种情况反而会导致性能降低。</p><p>编译器可以针对代码情况进行取指优化，如果大部分情况都是A，即(likely(A))，那么将A情况下的指令取指提前到条件指令后面，如果大部分都不是A，即(unlikely(A)), 那么将其他情况的指令提前到条件指令后面。</p><h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><p>通过代码汇编指令对比检查优化逻辑，汇编有两种方式：</p><ol><li>通过objdump进行汇编</li><li>gdb通过disassemble指令进行汇编</li></ol><h3 id="编译环境"><a href="#编译环境" class="headerlink" title="编译环境"></a>编译环境</h3><p>需要确定kernel的编译环境打开了编译器优化</p><p>可以发现编译器优化等级为-O2</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;Makefile</span><br><span class="line">$(info KBUILD_CFLAGS is $(KBUILD_CFLAGS))</span><br><span class="line"></span><br><span class="line">➜  2-likely git:(master) ✗ make </span><br><span class="line">KBUILD_CFLAGS is -Wall  ...  -std&#x3D;gnu89 ...  -O2 ... -g -gdwarf-4</span><br></pre></td></tr></table></figure><p>修改编译优化等级有两种方式</p><ol><li>修改linux Makefile编译方式</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Makefile</span></span><br><span class="line">ifdef CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE   &gt;&gt;默认                                                                                                                                                                           </span><br><span class="line">KBUILD_CFLAGS += -O2     </span><br><span class="line"><span class="keyword">else</span> ifdef CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE_O3     </span><br><span class="line">KBUILD_CFLAGS += -O3     </span><br><span class="line"><span class="keyword">else</span> ifdef CONFIG_CC_OPTIMIZE_FOR_SIZE     </span><br><span class="line">KBUILD_CFLAGS += -Os</span><br></pre></td></tr></table></figure><ol start="2"><li>增加模块编译参数</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//驱动模块下Makefile</span></span><br><span class="line">EXTRA_CFLAGS = -Wall -g -O2</span><br></pre></td></tr></table></figure><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>在代码设计时，要注意三点</p><ol><li>确保变量不能是定值，比如<code>a = 1; if(likely(a == 1))</code>，因此选择使用进程号</li><li>要确保不同条件下的指令有明显差异，不能都是printk,不然只能看到汇编流程上je和jne的差异，因此选择a++和a–。</li><li>因为使用gdb通过disassemble指令进行汇编，因此需要汇编的函数需要导出symbol，可以通过<code>nm</code>确认</li></ol><details><summary>test-A.c</summary><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Makefile</span></span><br><span class="line">MODULE_SRCS += likely.c</span><br><span class="line"></span><br><span class="line">MODULE_OBJS += $(wildcard *.o) \</span><br><span class="line">              $(wildcard *.ko) \</span><br><span class="line">              $(wildcard *.mod) \</span><br><span class="line">              $(wildcard *.mod.c)</span><br><span class="line"></span><br><span class="line">OUT_FILES += modules.order \</span><br><span class="line">             Module.symvers</span><br><span class="line"></span><br><span class="line">#$(info <span class="string">&quot;OBJS is $(MODULE_OBJS)&quot;</span>)</span><br><span class="line"></span><br><span class="line">obj-m += likely.o</span><br><span class="line"><span class="keyword">module</span>-objs := likely.o</span><br><span class="line">#EXTRA_CFLAGS = -Wall -g -O2  &gt;&gt;这里也可以设置编译器优化等级</span><br><span class="line"></span><br><span class="line">#The path of kernel code</span><br><span class="line">KDIR := /github/linux</span><br><span class="line">PWD ?= $(shell pwd)</span><br><span class="line"></span><br><span class="line">build: kernel_modules</span><br><span class="line">kernel_modules:</span><br><span class="line">	make -C $(KDIR) M=$(PWD) modules</span><br><span class="line"></span><br><span class="line">#$(info EXTRA_CFLAGS is $(EXTRA_CFLAGS))</span><br><span class="line">$(info KBUILD_CFLAGS is $(KBUILD_CFLAGS))</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">	rm -rf $(MODULE_OBJS)</span><br><span class="line">	rm -rf $(OUT_FILES)</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//likely.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;Dual BSD/GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">p</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>((p-&gt;pid % <span class="number">2</span> ) == <span class="number">0</span>) &#123;</span><br><span class="line">                a++;</span><br><span class="line">          <span class="comment">//      printk(KERN_ALERT &quot;pid is even\n&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">                a--;</span><br><span class="line">            <span class="comment">//    printk(KERN_ALERT &quot;pid is odd\n&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(test);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test_likely</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(likely((p-&gt;pid % <span class="number">2</span>) == <span class="number">0</span>)) &#123;</span><br><span class="line">                a++;</span><br><span class="line">              <span class="comment">//  printk(KERN_ALERT &quot;pid is even\n&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">                a--;</span><br><span class="line">                <span class="comment">//printk(KERN_ALERT &quot;pid is odd\n&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(test_likely);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test_unlikely</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(unlikely((p-&gt;pid % <span class="number">2</span>) == <span class="number">0</span>)) &#123;</span><br><span class="line">                a++;</span><br><span class="line">                <span class="comment">//printk(KERN_ALERT &quot;pid is even\n&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">                a--;</span><br><span class="line">                <span class="comment">//printk(KERN_ALERT &quot;pid is odd\n&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(test_unlikely);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">likely_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    p = current;</span><br><span class="line">    printk(KERN_ALERT <span class="string">&quot;Hello, world\n&quot;</span>);</span><br><span class="line">    test();</span><br><span class="line">    test_likely();</span><br><span class="line">    test_unlikely();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">likely_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_ALERT <span class="string">&quot;Goodbey, cruel world\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(likely_init);</span><br><span class="line">module_exit(likely_exit);</span><br></pre></td></tr></table></figure></details><h3 id="objdump汇编"><a href="#objdump汇编" class="headerlink" title="objdump汇编"></a>objdump汇编</h3><p>objdump汇编检查差异</p><h4 id="O2"><a href="#O2" class="headerlink" title="-O2"></a>-O2</h4><p>-O2优化的情况下，unlikely将else的指令提前到条件指令后边</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">//-O2</span><br><span class="line">➜  2-likely git:(master) ✗ objdump -d likely.ko</span><br><span class="line"></span><br><span class="line">likely.ko：     文件格式 elf64-x86-64</span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;test_likely&gt;:</span><br><span class="line">   0:	e8 00 00 00 00       	callq  5 &lt;test_likely+0x5&gt;</span><br><span class="line">   5:	48 8b 05 00 00 00 00 	mov    0x0(%rip),%rax        <span class="comment"># c &lt;test_likely+0xc&gt;</span></span><br><span class="line">   c:	f6 80 c0 05 00 00 01 	testb  <span class="variable">$0x1</span>,0x5c0(%rax)</span><br><span class="line">  13:	75 08                	jne    1d &lt;test_likely+0x1d&gt;  如果不相等，那么跳转到1d, 即a--</span><br><span class="line">  15:	83 05 00 00 00 00 01 	addl   <span class="variable">$0x1</span>,0x0(%rip)        <span class="comment"># 1c &lt;test_likely+0x1c&gt;    &gt;&gt;addl指令在前面</span></span><br><span class="line">  1c:	c3                   	retq   </span><br><span class="line">  1d:	83 2d 00 00 00 00 01 	subl   <span class="variable">$0x1</span>,0x0(%rip)        <span class="comment"># 24 &lt;test_likely+0x24&gt;</span></span><br><span class="line">  24:	c3                   	retq   </span><br><span class="line">  25:	90                   	nop</span><br><span class="line">  26:	66 2e 0f 1f 84 00 00 	nopw   %cs:0x0(%rax,%rax,1)</span><br><span class="line">  2d:	00 00 00 </span><br><span class="line"></span><br><span class="line">0000000000000030 &lt;test_unlikely&gt;:</span><br><span class="line">  30:	e8 00 00 00 00       	callq  35 &lt;test_unlikely+0x5&gt;</span><br><span class="line">  35:	48 8b 05 00 00 00 00 	mov    0x0(%rip),%rax        <span class="comment"># 3c &lt;test_unlikely+0xc&gt;</span></span><br><span class="line">  3c:	f6 80 c0 05 00 00 01 	testb  <span class="variable">$0x1</span>,0x5c0(%rax)</span><br><span class="line">  43:	74 08                	je     4d &lt;test_unlikely+0x1d&gt;  如果相等，那么跳转到4d, 即a++</span><br><span class="line">  45:	83 2d 00 00 00 00 01 	subl   <span class="variable">$0x1</span>,0x0(%rip)        <span class="comment"># 4c &lt;test_unlikely+0x1c&gt;  &gt;&gt;subl指令在前面</span></span><br><span class="line">  4c:	c3                   	retq   </span><br><span class="line">  4d:	83 05 00 00 00 00 01 	addl   <span class="variable">$0x1</span>,0x0(%rip)        <span class="comment"># 54 &lt;test_unlikely+0x24&gt;</span></span><br><span class="line">  54:	c3                   	retq   </span><br><span class="line">  55:	90                   	nop</span><br><span class="line">  56:	66 2e 0f 1f 84 00 00 	nopw   %cs:0x0(%rax,%rax,1)</span><br><span class="line">  5d:	00 00 00 </span><br><span class="line"></span><br><span class="line">0000000000000060 &lt;<span class="built_in">test</span>&gt;:</span><br><span class="line">  60:	e8 00 00 00 00       	callq  65 &lt;<span class="built_in">test</span>+0x5&gt;</span><br><span class="line">  65:	48 8b 05 00 00 00 00 	mov    0x0(%rip),%rax        <span class="comment"># 6c &lt;test+0xc&gt;</span></span><br><span class="line">  6c:	f6 80 c0 05 00 00 01 	testb  <span class="variable">$0x1</span>,0x5c0(%rax)</span><br><span class="line">  73:	74 08                	je     7d &lt;<span class="built_in">test</span>+0x1d&gt;</span><br><span class="line">  75:	83 2d 00 00 00 00 01 	subl   <span class="variable">$0x1</span>,0x0(%rip)        <span class="comment"># 7c &lt;test+0x1c&gt; &gt;&gt;为假subl</span></span><br><span class="line">  7c:	c3                   	retq   </span><br><span class="line">  7d:	83 05 00 00 00 00 01 	addl   <span class="variable">$0x1</span>,0x0(%rip)        <span class="comment"># 84 &lt;test+0x24&gt;  &gt;&gt;为真addl</span></span><br><span class="line">  84:	c3                   	retq   </span><br><span class="line">  85:	90                   	nop</span><br><span class="line">  86:	66 2e 0f 1f 84 00 00 	nopw   %cs:0x0(%rax,%rax,1)</span><br><span class="line">  8d:	00 00 00 </span><br><span class="line"> </span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><h4 id="O0"><a href="#O0" class="headerlink" title="-O0"></a>-O0</h4><p>不开默认编译优化的情况下，发现指令数目明显增多</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">000000000000002f</span> &lt;test&gt;:</span><br><span class="line">  <span class="number">2f</span>:	e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">34</span> &lt;test+<span class="number">0x5</span>&gt;</span><br><span class="line">  <span class="number">34</span>:	<span class="number">55</span>                   	push   %rbp</span><br><span class="line">  <span class="number">35</span>:	<span class="number">48</span> <span class="number">89</span> e5             	mov    %rsp,%rbp</span><br><span class="line">  <span class="number">38</span>:	<span class="number">48</span> <span class="number">8b</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(%rip),%rax        # <span class="number">3f</span> &lt;test+<span class="number">0x10</span>&gt;</span><br><span class="line">  <span class="number">3f</span>:	<span class="number">8b</span> <span class="number">80</span> c0 <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x5c0</span>(%rax),%eax</span><br><span class="line">  <span class="number">45</span>:	<span class="number">83</span> e0 <span class="number">01</span>             	<span class="keyword">and</span>    $<span class="number">0x1</span>,%eax</span><br><span class="line">  <span class="number">48</span>:	<span class="number">85</span> c0                	test   %eax,%eax</span><br><span class="line">  <span class="number">4</span>a:	<span class="number">75</span> <span class="number">11</span>                	jne    <span class="number">5</span>d &lt;test+<span class="number">0x2e</span>&gt;   &gt;&gt;为假跳到<span class="number">5</span>d</span><br><span class="line">  <span class="number">4</span>c:	<span class="number">8b</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x0</span>(%rip),%eax        # <span class="number">52</span> &lt;test+<span class="number">0x23</span>&gt;  &gt;&gt;为真add</span><br><span class="line">  <span class="number">52</span>:	<span class="number">83</span> c0 <span class="number">01</span>             	add    $<span class="number">0x1</span>,%eax</span><br><span class="line">  <span class="number">55</span>:	<span class="number">89</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    %eax,<span class="number">0x0</span>(%rip)        # <span class="number">5b</span> &lt;test+<span class="number">0x2c</span>&gt;</span><br><span class="line">  <span class="number">5b</span>:	eb <span class="number">0f</span>                	jmp    <span class="number">6</span>c &lt;test+<span class="number">0x3d</span>&gt;</span><br><span class="line">  <span class="number">5</span>d:	<span class="number">8b</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x0</span>(%rip),%eax        # <span class="number">63</span> &lt;test+<span class="number">0x34</span>&gt;  </span><br><span class="line">  <span class="number">63</span>:	<span class="number">83</span> e8 <span class="number">01</span>             	sub    $<span class="number">0x1</span>,%eax &gt;&gt;为假sub</span><br><span class="line">  <span class="number">66</span>:	<span class="number">89</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    %eax,<span class="number">0x0</span>(%rip)        # <span class="number">6</span>c &lt;test+<span class="number">0x3d</span>&gt;</span><br><span class="line">  <span class="number">6</span>c:	<span class="number">90</span>                   	nop</span><br><span class="line">  <span class="number">6</span>d:	<span class="number">5</span>d                   	pop    %rbp</span><br><span class="line">  <span class="number">6</span>e:	c3                   	retq   </span><br><span class="line"></span><br><span class="line"><span class="number">000000000000006f</span> &lt;test_likely&gt;:</span><br><span class="line">  <span class="number">6f</span>:	e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">74</span> &lt;test_likely+<span class="number">0x5</span>&gt;</span><br><span class="line">  <span class="number">74</span>:	<span class="number">55</span>                   	push   %rbp</span><br><span class="line">  <span class="number">75</span>:	<span class="number">48</span> <span class="number">89</span> e5             	mov    %rsp,%rbp</span><br><span class="line">  <span class="number">78</span>:	<span class="number">48</span> <span class="number">8b</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(%rip),%rax        # <span class="number">7f</span> &lt;test_likely+<span class="number">0x10</span>&gt;</span><br><span class="line">  <span class="number">7f</span>:	<span class="number">8b</span> <span class="number">80</span> c0 <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x5c0</span>(%rax),%eax</span><br><span class="line">  <span class="number">85</span>:	<span class="number">83</span> e0 <span class="number">01</span>             	<span class="keyword">and</span>    $<span class="number">0x1</span>,%eax</span><br><span class="line">  <span class="number">88</span>:	<span class="number">85</span> c0                	test   %eax,%eax</span><br><span class="line">  <span class="number">8</span>a:	<span class="number">0f</span> <span class="number">94</span> c0             	sete   %al</span><br><span class="line">  <span class="number">8</span>d:	<span class="number">0f</span> b6 c0             	movzbl %al,%eax</span><br><span class="line">  <span class="number">90</span>:	<span class="number">48</span> <span class="number">85</span> c0             	test   %rax,%rax</span><br><span class="line">  <span class="number">93</span>:	<span class="number">74</span> <span class="number">11</span>                	je     a6 &lt;test_likely+<span class="number">0x37</span>&gt;</span><br><span class="line">  <span class="number">95</span>:	<span class="number">8b</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x0</span>(%rip),%eax        # <span class="number">9b</span> &lt;test_likely+<span class="number">0x2c</span>&gt;</span><br><span class="line">  <span class="number">9b</span>:	<span class="number">83</span> c0 <span class="number">01</span>             	add    $<span class="number">0x1</span>,%eax</span><br><span class="line">  <span class="number">9</span>e:	<span class="number">89</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    %eax,<span class="number">0x0</span>(%rip)        # a4 &lt;test_likely+<span class="number">0x35</span>&gt;</span><br><span class="line">  a4:	eb <span class="number">0f</span>                	jmp    b5 &lt;test_likely+<span class="number">0x46</span>&gt;</span><br><span class="line">  a6:	<span class="number">8b</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x0</span>(%rip),%eax        <span class="meta"># ac <span class="meta-string">&lt;test_likely+0x3d&gt;</span></span></span><br><span class="line">  ac:	<span class="number">83</span> e8 <span class="number">01</span>             	sub    $<span class="number">0x1</span>,%eax</span><br><span class="line">  af:	<span class="number">89</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    %eax,<span class="number">0x0</span>(%rip)        # b5 &lt;test_likely+<span class="number">0x46</span>&gt;</span><br><span class="line">  b5:	<span class="number">90</span>                   	nop</span><br><span class="line">  b6:	<span class="number">5</span>d                   	pop    %rbp</span><br><span class="line">  b7:	c3                   	retq   </span><br><span class="line"></span><br><span class="line"><span class="number">00000000000000b</span>8 &lt;test_unlikely&gt;:</span><br><span class="line">  b8:	e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	callq  bd &lt;test_unlikely+<span class="number">0x5</span>&gt;</span><br><span class="line">  bd:	<span class="number">55</span>                   	push   %rbp</span><br><span class="line">  be:	<span class="number">48</span> <span class="number">89</span> e5             	mov    %rsp,%rbp</span><br><span class="line">  c1:	<span class="number">48</span> <span class="number">8b</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(%rip),%rax        # c8 &lt;test_unlikely+<span class="number">0x10</span>&gt;</span><br><span class="line">  c8:	<span class="number">8b</span> <span class="number">80</span> c0 <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x5c0</span>(%rax),%eax</span><br><span class="line">  ce:	<span class="number">83</span> e0 <span class="number">01</span>             	<span class="keyword">and</span>    $<span class="number">0x1</span>,%eax</span><br><span class="line">  d1:	<span class="number">85</span> c0                	test   %eax,%eax</span><br><span class="line">  d3:	<span class="number">0f</span> <span class="number">94</span> c0             	sete   %al</span><br><span class="line">  d6:	<span class="number">0f</span> b6 c0             	movzbl %al,%eax</span><br><span class="line">  d9:	<span class="number">48</span> <span class="number">85</span> c0             	test   %rax,%rax</span><br><span class="line">  dc:	<span class="number">74</span> <span class="number">11</span>                	je     ef &lt;test_unlikely+<span class="number">0x37</span>&gt;</span><br><span class="line">  de:	<span class="number">8b</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x0</span>(%rip),%eax        # e4 &lt;test_unlikely+<span class="number">0x2c</span>&gt;</span><br><span class="line">  e4:	<span class="number">83</span> c0 <span class="number">01</span>             	add    $<span class="number">0x1</span>,%eax</span><br><span class="line">  e7:	<span class="number">89</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    %eax,<span class="number">0x0</span>(%rip)        <span class="meta"># ed <span class="meta-string">&lt;test_unlikely+0x35&gt;</span></span></span><br><span class="line">  ed:	eb <span class="number">0f</span>                	jmp    fe &lt;test_unlikely+<span class="number">0x46</span>&gt;</span><br><span class="line">  ef:	<span class="number">8b</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x0</span>(%rip),%eax        # f5 &lt;test_unlikely+<span class="number">0x3d</span>&gt;</span><br><span class="line">  f5:	<span class="number">83</span> e8 <span class="number">01</span>             	sub    $<span class="number">0x1</span>,%eax</span><br><span class="line">  f8:	<span class="number">89</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    %eax,<span class="number">0x0</span>(%rip)        <span class="meta"># fe <span class="meta-string">&lt;test_unlikely+0x46&gt;</span></span></span><br><span class="line">  fe:	<span class="number">90</span>                   	nop</span><br><span class="line">  ff:	<span class="number">5</span>d                   	pop    %rbp</span><br><span class="line"> <span class="number">100</span>:	c3                   	retq   </span><br></pre></td></tr></table></figure><h4 id="O1"><a href="#O1" class="headerlink" title="-O1"></a>-O1</h4><p>-O1 的情况下指令明显变少，同时发现和-O2的打印基本一致，思考为什么？</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">likely.ko：     文件格式 elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000000</span> &lt;test&gt;:hui bian</span><br><span class="line">   <span class="number">0</span>:	e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">5</span> &lt;test+<span class="number">0x5</span>&gt;</span><br><span class="line">   <span class="number">5</span>:	<span class="number">48</span> <span class="number">8b</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(%rip),%rax        <span class="meta"># c <span class="meta-string">&lt;test+0xc&gt;</span></span></span><br><span class="line">   c:	f6 <span class="number">80</span> c0 <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> 	testb  $<span class="number">0x1</span>,<span class="number">0x5c0</span>(%rax)</span><br><span class="line">  <span class="number">13</span>:	<span class="number">74</span> <span class="number">08</span>                	je     <span class="number">1</span>d &lt;test+<span class="number">0x1d</span>&gt;</span><br><span class="line">  <span class="number">15</span>:	<span class="number">83</span> <span class="number">2</span>d <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> 	subl   $<span class="number">0x1</span>,<span class="number">0x0</span>(%rip)        # <span class="number">1</span>c &lt;test+<span class="number">0x1c</span>&gt;</span><br><span class="line">  <span class="number">1</span>c:	c3                   	retq   </span><br><span class="line">  <span class="number">1</span>d:	<span class="number">83</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> 	addl   $<span class="number">0x1</span>,<span class="number">0x0</span>(%rip)        # <span class="number">24</span> &lt;test+<span class="number">0x24</span>&gt;</span><br><span class="line">  <span class="number">24</span>:	c3                   	retq   </span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000025</span> &lt;test_likely&gt;:</span><br><span class="line">  <span class="number">25</span>:	e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">2</span>a &lt;test_likely+<span class="number">0x5</span>&gt;</span><br><span class="line">  <span class="number">2</span>a:	<span class="number">48</span> <span class="number">8b</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(%rip),%rax        # <span class="number">31</span> &lt;test_likely+<span class="number">0xc</span>&gt;</span><br><span class="line">  <span class="number">31</span>:	f6 <span class="number">80</span> c0 <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> 	testb  $<span class="number">0x1</span>,<span class="number">0x5c0</span>(%rax)</span><br><span class="line">  <span class="number">38</span>:	<span class="number">75</span> <span class="number">08</span>                	jne    <span class="number">42</span> &lt;test_likely+<span class="number">0x1d</span>&gt;</span><br><span class="line">  <span class="number">3</span>a:	<span class="number">83</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> 	addl   $<span class="number">0x1</span>,<span class="number">0x0</span>(%rip)        # <span class="number">41</span> &lt;test_likely+<span class="number">0x1c</span>&gt;</span><br><span class="line">  <span class="number">41</span>:	c3                   	retq   </span><br><span class="line">  <span class="number">42</span>:	<span class="number">83</span> <span class="number">2</span>d <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> 	subl   $<span class="number">0x1</span>,<span class="number">0x0</span>(%rip)        # <span class="number">49</span> &lt;test_likely+<span class="number">0x24</span>&gt;</span><br><span class="line">  <span class="number">49</span>:	c3                   	retq   </span><br><span class="line"></span><br><span class="line"><span class="number">000000000000004</span>a &lt;test_unlikely&gt;:</span><br><span class="line">  <span class="number">4</span>a:	e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">4f</span> &lt;test_unlikely+<span class="number">0x5</span>&gt;</span><br><span class="line">  <span class="number">4f</span>:	<span class="number">48</span> <span class="number">8b</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(%rip),%rax        # <span class="number">56</span> &lt;test_unlikely+<span class="number">0xc</span>&gt;</span><br><span class="line">  <span class="number">56</span>:	f6 <span class="number">80</span> c0 <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> 	testb  $<span class="number">0x1</span>,<span class="number">0x5c0</span>(%rax)</span><br><span class="line">  <span class="number">5</span>d:	<span class="number">74</span> <span class="number">08</span>                	je     <span class="number">67</span> &lt;test_unlikely+<span class="number">0x1d</span>&gt;</span><br><span class="line">  <span class="number">5f</span>:	<span class="number">83</span> <span class="number">2</span>d <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> 	subl   $<span class="number">0x1</span>,<span class="number">0x0</span>(%rip)        # <span class="number">66</span> &lt;test_unlikely+<span class="number">0x1c</span>&gt;</span><br><span class="line">  <span class="number">66</span>:	c3                   	retq   </span><br><span class="line">  <span class="number">67</span>:	<span class="number">83</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> 	addl   $<span class="number">0x1</span>,<span class="number">0x0</span>(%rip)        # <span class="number">6</span>e &lt;test_unlikely+<span class="number">0x24</span>&gt;</span><br><span class="line">  <span class="number">6</span>e:	c3                   	retq   </span><br></pre></td></tr></table></figure><h3 id="gdb查看汇编"><a href="#gdb查看汇编" class="headerlink" title="gdb查看汇编"></a>gdb查看汇编</h3><p>使用gdb来查看-O2下的模块汇编，同objdump显示一致</p><figure class="highlight plain"><figcaption><span>disassemble test</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disassemble test</span><br><span class="line">Dump of assembler code for function test:</span><br><span class="line">   0x0000000000000090 &lt;+0&gt;:     callq  0x95 &lt;test+5&gt;</span><br><span class="line">   0x0000000000000095 &lt;+5&gt;:     mov    0x0(%rip),%rax        # 0x9c &lt;test+12&gt;</span><br><span class="line">   0x000000000000009c &lt;+12&gt;:    testb  $0x1,0x5c0(%rax)</span><br><span class="line">   0x00000000000000a3 &lt;+19&gt;:    je     0xad &lt;test+29&gt;</span><br><span class="line">   0x00000000000000a5 &lt;+21&gt;:    subl   $0x1,0x0(%rip)        # 0xac &lt;test+28&gt;</span><br><span class="line">   0x00000000000000ac &lt;+28&gt;:    retq   </span><br><span class="line">   0x00000000000000ad &lt;+29&gt;:    addl   $0x1,0x0(%rip)        # 0xb4 &lt;test+36&gt;</span><br><span class="line">   0x00000000000000b4 &lt;+36&gt;:    retq   </span><br><span class="line">End of assembler dump.</span><br><span class="line">(gdb) disassemble test_likely</span><br><span class="line">Dump of assembler code for function test_likely:</span><br><span class="line">   0x0000000000000030 &lt;+0&gt;:     callq  0x35 &lt;test_likely+5&gt;</span><br><span class="line">   0x0000000000000035 &lt;+5&gt;:     mov    0x0(%rip),%rax        # 0x3c &lt;test_likely+12&gt;</span><br><span class="line">   0x000000000000003c &lt;+12&gt;:    testb  $0x1,0x5c0(%rax)</span><br><span class="line">   0x0000000000000043 &lt;+19&gt;:    jne    0x4d &lt;test_likely+29&gt;</span><br><span class="line">   0x0000000000000045 &lt;+21&gt;:    addl   $0x1,0x0(%rip)        # 0x4c &lt;test_likely+28&gt;</span><br><span class="line">   0x000000000000004c &lt;+28&gt;:    retq   </span><br><span class="line">   0x000000000000004d &lt;+29&gt;:    subl   $0x1,0x0(%rip)        # 0x54 &lt;test_likely+36&gt;</span><br><span class="line">   0x0000000000000054 &lt;+36&gt;:    retq   </span><br><span class="line">End of assembler dump.</span><br><span class="line">(gdb) disassemble test_unlikely</span><br><span class="line">Dump of assembler code for function test_unlikely:</span><br><span class="line">   0x0000000000000060 &lt;+0&gt;:     callq  0x65 &lt;test_unlikely+5&gt;</span><br><span class="line">   0x0000000000000065 &lt;+5&gt;:     mov    0x0(%rip),%rax        # 0x6c &lt;test_unlikely+12&gt;</span><br><span class="line">   0x000000000000006c &lt;+12&gt;:    testb  $0x1,0x5c0(%rax)</span><br><span class="line">   0x0000000000000073 &lt;+19&gt;:    je     0x7d &lt;test_unlikely+29&gt;</span><br><span class="line">   0x0000000000000075 &lt;+21&gt;:    subl   $0x1,0x0(%rip)        # 0x7c &lt;test_unlikely+28&gt;</span><br><span class="line">   0x000000000000007c &lt;+28&gt;:    retq   </span><br><span class="line">   0x000000000000007d &lt;+29&gt;:    addl   $0x1,0x0(%rip)        # 0x84 &lt;test_unlikely+36&gt;</span><br><span class="line">   0x0000000000000084 &lt;+36&gt;:    retq   </span><br><span class="line">End of assembler dump.</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>注意，gdb disassemble显示的都是symbol，需要EXPORT_SYMBOL导出，可以通过nm确认</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="number">2</span>-likely git:(master) ✗ nm likely.ko                                                </span><br><span class="line"><span class="number">0000000000000000</span> b a</span><br><span class="line"><span class="number">00000000000000</span>d0 T cleanup_module</span><br><span class="line">                 U current_task</span><br><span class="line">                 U __fentry__</span><br><span class="line"><span class="number">0000000000000090</span> T init_module</span><br><span class="line"><span class="number">0000000000000005</span> r __kstrtabns_test</span><br><span class="line"><span class="number">0000000000000012</span> r __kstrtabns_test_likely</span><br><span class="line"><span class="number">0000000000000021</span> r __kstrtabns_test_unlikely</span><br><span class="line"><span class="number">0000000000000000</span> r __kstrtab_test</span><br><span class="line"><span class="number">0000000000000006</span> r __kstrtab_test_likely</span><br><span class="line"><span class="number">0000000000000013</span> r __kstrtab_test_unlikely</span><br><span class="line"><span class="number">0000000000000000</span> r __ksymtab_test</span><br><span class="line"><span class="number">000000000000000</span>c r __ksymtab_test_likely</span><br><span class="line"><span class="number">0000000000000018</span> r __ksymtab_test_unlikely</span><br><span class="line"><span class="number">00000000000000</span>d0 t likely_exit</span><br><span class="line"><span class="number">0000000000000090</span> t likely_init</span><br><span class="line"><span class="number">0000000000000018</span> r _note_8</span><br><span class="line"><span class="number">0000000000000000</span> r _note_9</span><br><span class="line"><span class="number">0000000000000008</span> b p</span><br><span class="line">                 U _printk</span><br><span class="line"><span class="number">0000000000000060</span> T test</span><br><span class="line"><span class="number">0000000000000000</span> T test_likely</span><br><span class="line"><span class="number">0000000000000030</span> T test_unlikely</span><br><span class="line"><span class="number">0000000000000000</span> D __this_module</span><br><span class="line"><span class="number">0000000000000038</span> r __UNIQUE_ID_depends121</span><br><span class="line"><span class="number">0000000000000000</span> r __UNIQUE_ID_license172</span><br><span class="line"><span class="number">000000000000004</span>d r __UNIQUE_ID_name119</span><br><span class="line"><span class="number">0000000000000041</span> r __UNIQUE_ID_retpoline120</span><br><span class="line"><span class="number">0000000000000015</span> r __UNIQUE_ID_srcversion122</span><br><span class="line"><span class="number">0000000000000059</span> r __UNIQUE_ID_vermagic118</span><br></pre></td></tr></table></figure><h2 id="深入"><a href="#深入" class="headerlink" title="深入"></a>深入</h2><h3 id="gcc内建函数的实现流程"><a href="#gcc内建函数的实现流程" class="headerlink" title="gcc内建函数的实现流程"></a>gcc内建函数的实现流程</h3><p>既然要追踪gcc内建函数的实现，可是对gcc架构并不熟悉，因此想通过gdb来调试。但是本地的gcc是不带symbol的，gcc源代码默认编译方式是-g</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  bin file /usr/bin/x86_64-linux-gnu-gcc<span class="number">-6</span></span><br><span class="line">/usr/bin/x86_64-linux-gnu-gcc<span class="number">-6</span>: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">3</span>d6f4ce69fccf03dec42b3eea2fbc14a23b10ea3, stripped</span><br></pre></td></tr></table></figure><p>下载最新的gcc编译替代本地后调试发现如下异常，应该是不影响gcc编译过程调试的</p><p>怀疑内建函数使用中 有用到<code>add_builtin_function--&gt;build_builtin_function</code>，因此在此处设置断点</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="number">2</span>-likely git:(master) ✗ gdb</span><br><span class="line">(gdb) file /usr/local/bin/lto-dump</span><br><span class="line">Reading symbols from /usr/local/bin/lto-dump...done.</span><br><span class="line">...</span><br><span class="line">(gdb) b add_builtin_function</span><br><span class="line">Breakpoint <span class="number">1</span> at <span class="number">0x9d0280</span>: file ../../gcc/langhooks.cc, line <span class="number">735.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(gdb) make  &gt;&gt;没有在断点处暂停，原因未知，继续追踪研究</span><br><span class="line">KBUILD_CFLAGS is </span><br><span class="line">make -C /github/linux M=/github/linux-driver/<span class="number">2</span>-likely modules</span><br><span class="line">make[1]: Entering directory &#x27;/github/linux&#x27;</span><br><span class="line">warning: the compiler differs from the one used to build the kernel</span><br><span class="line">  The kernel was built by: gcc (Ubuntu <span class="number">6.5</span><span class="number">.0</span><span class="number">-2u</span>buntu1~<span class="number">16.04</span>) <span class="number">6.5</span><span class="number">.0</span> <span class="number">20181026</span></span><br><span class="line">  You are <span class="keyword">using</span>:           gcc (GCC) <span class="number">12.0</span><span class="number">.1</span> <span class="number">20220406</span> (experimental)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果去匹配，那么需要重新用新的gcc来编译内核(同时也应该去编译模块)，但是gcc版本太高也应该有问题，内核编译会失败，因此下载gcc 6.5.0版本编译带symbol的执行文件</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="comment">//ftp.gnu.org/gnu/gcc/gcc-6.5.0/gcc-6.5.0.tar.xz</span></span><br><span class="line">xz -d gcc<span class="number">-6.5</span><span class="number">.0</span>.tar.xz </span><br><span class="line">tar -xvf gcc<span class="number">-6.5</span><span class="number">.0</span>.tar</span><br><span class="line">./contrib/download_prerequisites &gt;&gt;安装依赖</span><br><span class="line">mkdir gcc-build</span><br><span class="line">cd gcc-build</span><br><span class="line">../configure -enable-languages=c,c++ -disable-multilib -enable-checking=release</span><br><span class="line">make install &gt;&gt;默认安装在/usr/local下，生成新的/usr/local/bin/gcc</span><br><span class="line">rm -rf /usr/bin/gcc 删除旧的软链接，可删可不删， which gcc都会指向新的</span><br></pre></td></tr></table></figure><p>思考？gcc编译什么时会触发我设置的内建断点？编译模块likely.c生成likely.o吗？还是编译内核？或者还是gcc本身编译呢(不太可能，编译时内建代码部分？)</p><p>通过make编译模块没有触发断点，嗯…想办法直接执行对应的gcc命令</p><h4 id="make编译模块生成-o"><a href="#make编译模块生成-o" class="headerlink" title="make编译模块生成.o"></a>make编译模块生成.o</h4><p>动态模块中make主要部分如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -C $(KDIR) M=$(PWD) modules</span><br></pre></td></tr></table></figure><p>等价于在linux 下执行</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  linux git:(master) ✗ make  M=/github/linux-driver/<span class="number">2</span>-likely modules</span><br></pre></td></tr></table></figure><p>根据依赖规则，找到对应的实际生成likely.o的gcc编译部分,调试时将S(Q)去掉，这样可以打印make语句</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Makefile in kernel</span></span><br><span class="line">modules: modules_check     </span><br><span class="line">        $(Q)$(MAKE) -f $(srctree)/scripts/Makefile.modpost                                                                                                                                                          </span><br><span class="line">     </span><br><span class="line">PHONY += modules_check     </span><br><span class="line">modules_check: $(MODORDER)     </span><br><span class="line">        $(Q)$(CONFIG_SHELL) $(srctree)/scripts/modules-check.sh $&lt;</span><br><span class="line">        </span><br><span class="line">&gt;&gt;依赖$(MODORDER)， 这个是什么？</span><br><span class="line"><span class="keyword">export</span> extmod_prefix = $(<span class="keyword">if</span> $(KBUILD_EXTMOD),$(KBUILD_EXTMOD)/)     </span><br><span class="line"><span class="keyword">export</span> MODORDER := $(extmod_prefix)modules.order </span><br><span class="line">&gt;&gt;$(MODORDER)是/github/linux-driver/<span class="number">2</span>-likely/modules.order，但是这个文件没有？这个依赖什么？</span><br><span class="line">$(MODORDER): descend                                                                                                                                                                                                </span><br><span class="line">        @:</span><br><span class="line"></span><br><span class="line">descend: $(build-dirs)                                                                                                                                                                                              </span><br><span class="line">$(build-dirs): prepare</span><br><span class="line">        $(info chejian make is $(MAKE) build is $(build)  | $@)</span><br><span class="line">        $(MAKE) $(build)=$@ \                               </span><br><span class="line">        single-build=$(<span class="keyword">if</span> $(filter-out $@/, $(filter $@/%, $(KBUILD_SINGLE_TARGETS))),<span class="number">1</span>) \</span><br><span class="line">        need-builtin=<span class="number">1</span> need-modorder=<span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">&gt;&gt;打印为make -f ./scripts/Makefile.build obj=/github/linux-driver/<span class="number">2</span>-likely \</span><br><span class="line">single-build= \</span><br><span class="line">need-builtin=<span class="number">1</span> need-modorder=<span class="number">1</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt;&gt;进入scripts/Makefile.build执行编译，查找第一个目标</span><br><span class="line">__build: $(<span class="keyword">if</span> $(KBUILD_BUILTIN), $(targets-<span class="keyword">for</span>-builtin)) \                                                                                                                                                          </span><br><span class="line">         $(<span class="keyword">if</span> $(KBUILD_MODULES), $(targets-<span class="keyword">for</span>-modules)) \    </span><br><span class="line">         $(subdir-ym) $(always-y)                  </span><br><span class="line">        $(info sholck test <span class="number">2</span> $(KBUILD_BUILTIN) | $(targets-<span class="keyword">for</span>-builtin) | $(KBUILD_MODULES) | $(targets-<span class="keyword">for</span>-modules) | $(subdir-ym)| $(always-y))    </span><br><span class="line">        @:                           </span><br><span class="line">                         </span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt;&gt;打印确认只有$(targets-<span class="keyword">for</span>-modules)这个依赖不为空</span><br><span class="line">targets-<span class="keyword">for</span>-modules := $(patsubst %.o, %.mod, $(filter %.o, $(obj-m)))</span><br><span class="line">&gt;&gt;确认targets-<span class="keyword">for</span>-modules为/github/linux-driver/<span class="number">2</span>-likely/likely.mod</span><br><span class="line"></span><br><span class="line">&gt;&gt;查找.mod的依赖</span><br><span class="line">$(obj)/%.mod: $(obj)/%$(mod-prelink-ext).o FORCE    </span><br><span class="line">        $(call if_changed,mod) </span><br><span class="line"></span><br><span class="line">&gt;&gt;查找.o的依赖</span><br><span class="line"># Built-in <span class="keyword">and</span> composite <span class="keyword">module</span> parts                       </span><br><span class="line">$(obj)/%.o: $(src)/%.c $(recordmcount_source) FORCE                                                                                                                                                                 </span><br><span class="line">        $(<span class="keyword">if</span> $(<span class="keyword">if</span>-changed-cond),$(rule_cc_o_c),@:) </span><br><span class="line">        $(call if_changed_rule,cc_o_c)</span><br><span class="line">        $(info lynx <span class="keyword">if</span>-changed-cond is $(<span class="keyword">if</span>-changed-cond))  &gt;&gt;增加打印  </span><br><span class="line">        $(info lynx rule_cc_o_c is $(rule_cc_o_c))  &gt;&gt;增加打印</span><br><span class="line">        $(call cmd,force_checksrc) </span><br><span class="line">&gt;&gt;函数调用，检查打印if_changed_rule函数实现</span><br><span class="line">if_changed_rule = $(<span class="keyword">if</span> $(<span class="keyword">if</span>-changed-cond),$(rule_$(<span class="number">1</span>)),@:) </span><br><span class="line"></span><br><span class="line">&gt;&gt;确定实际的gcc命令为</span><br><span class="line">gcc -Wp,-MMD,/github/linux-driver/2-likely/.likely.o.d  -nostdinc -I./arch/x86/include -I./arch/x86/include/generated  -I./include -I./arch/x86/include/uapi -I./arch/x86/include/generated/uapi -I./include/uapi -I./include/generated/uapi -include ./include/linux/compiler-version.h -include ./include/linux/kconfig.h -include ./include/linux/compiler_types.h -D__KERNEL__ -Wall -Wundef -Werror=strict-prototypes -Wno-trigraphs -fno-strict-aliasing -fno-common -fshort-wchar -fno-PIE -Werror=implicit-function-declaration -Werror=implicit-int -Werror=return-type -Wno-format-security -std=gnu11 -mno-sse -mno-mmx -mno-sse2 -mno-3dnow -mno-avx -m64 -falign-jumps=1 -falign-loops=1 -mno-80387 -mno-fp-ret-in-387 -mpreferred-stack-boundary=3 -mskip-rax-setup -mtune=generic -mno-red-zone -mcmodel=kernel -Wno-sign-compare -fno-asynchronous-unwind-tables -mindirect-branch=thunk-extern -mindirect-branch-register -fno-jump-tables -fno-delete-null-pointer-checks -Wno-frame-address -O2 --param=allow-store-data-races=0 -Wframe-larger-than=1024 -fstack-protector-strong -Wno-main -Wno-unused-but-set-variable -Wno-unused-const-variable -pg -mrecord-mcount -mfentry -DCC_USING_FENTRY -Wdeclaration-after-statement -Wvla -Wno-pointer-sign -Wno-maybe-uninitialized -fno-strict-overflow -fno-stack-check -fconserve-stack -Werror=date-time -Werror=incompatible-pointer-types -Werror=designated-init -g -gdwarf-4 -Wall -g  -DMODULE  -DKBUILD_BASENAME=&#x27;&quot;likely&quot;&#x27; -DKBUILD_MODNAME=&#x27;&quot;likely&quot;&#x27; -D__KBUILD_MODNAME=kmod_likely -c -o /github/linux-driver/2-likely/likely.o /github/linux-driver/2-likely/likely.c </span><br></pre></td></tr></table></figure><p>gdb 调试gcc中运行该命令未见内建中断触发</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  linux git:(master) ✗ gdb</span><br><span class="line">(gdb) file gcc</span><br><span class="line">Reading symbols from gcc...done.</span><br><span class="line">(gdb) add-symbol-file /github/package/gcc<span class="number">-6.5</span><span class="number">.0</span>/gcc-build/gcc/langhooks.o</span><br><span class="line">add symbol table from file <span class="string">&quot;/github/package/gcc-6.5.0/gcc-build/gcc/langhooks.o&quot;</span></span><br><span class="line">(y <span class="keyword">or</span> n) y</span><br><span class="line">Reading symbols from /github/package/gcc<span class="number">-6.5</span><span class="number">.0</span>/gcc-build/gcc/langhooks.o...done.</span><br><span class="line">(gdb) b add_builtin_function</span><br><span class="line">...</span><br><span class="line">(gdb) run -Wp,-MMD,/github/linux-driver/2-likely/.likely.o.d  -nostdinc -I./arch/x86/include -I./arch/x86/include/generated  -I./include -I./arch/x86/include/uapi -I./arch/x86/include/generated/uapi -I./include/uapi -I./include/generated/uapi -include ./include/linux/compiler-version.h -include ./include/linux/kconfig.h -include ./include/linux/compiler_types.h -D__KERNEL__ -Wall -Wundef -Werror=strict-prototypes -Wno-trigraphs -fno-strict-aliasing -fno-common -fshort-wchar -fno-PIE -Werror=implicit-function-declaration -Werror=implicit-int -Werror=return-type -Wno-format-security -std=gnu11 -mno-sse -mno-mmx -mno-sse2 -mno-3dnow -mno-avx -m64 -falign-jumps=1 -falign-loops=1 -mno-80387 -mno-fp-ret-in-387 -mpreferred-stack-boundary=3 -mskip-rax-setup -mtune=generic -mno-red-zone -mcmodel=kernel -Wno-sign-compare -fno-asynchronous-unwind-tables -mindirect-branch=thunk-extern -mindirect-branch-register -fno-jump-tables -fno-delete-null-pointer-checks -Wno-frame-address -O2 --param=allow-store-data-races=0 -Wframe-larger-than=1024 -fstack-protector-strong -Wno-main -Wno-unused-but-set-variable -Wno-unused-const-variable -pg -mrecord-mcount -mfentry -DCC_USING_FENTRY -Wdeclaration-after-statement -Wvla -Wno-pointer-sign -Wno-maybe-uninitialized -fno-strict-overflow -fno-stack-check -fconserve-stack -Werror=date-time -Werror=incompatible-pointer-types -Werror=designated-init -g -gdwarf-4 -Wall -g  -DMODULE  -DKBUILD_BASENAME=&#x27;&quot;likely&quot;&#x27; -DKBUILD_MODNAME=&#x27;&quot;likely&quot;&#x27; -D__KBUILD_MODNAME=kmod_likely -c -o /github/linux-driver/2-likely/likely.o /github/linux-driver/2-likely/likely.c </span><br><span class="line">...</span><br><span class="line">[Inferior <span class="number">1</span> (process <span class="number">26045</span>) exited normally] &gt;&gt;正常退出未见触发</span><br></pre></td></tr></table></figure><h4 id="测试编译内核-modules"><a href="#测试编译内核-modules" class="headerlink" title="测试编译内核/modules"></a>测试编译内核/modules</h4><p>编译内核和动态模块未见触发断点</p></div><div class="popular-posts-header">推荐文章</div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/15.html" rel="bookmark">gdb调试linux内核&驱动模块</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/14.html" rel="bookmark">crash库的开源提交</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/3.html" rel="bookmark">程序分析利器gdb</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/17.html" rel="bookmark">linux模块初始化分析</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/16.html" rel="bookmark">Kbuild-Makefile学习</a></div></li></ul><footer class="post-footer"><div class="post-tags"><a href="/tags/linux/" rel="tag"># linux</a> <a href="/tags/gdb/" rel="tag"># gdb</a> <a href="/tags/objdump/" rel="tag"># objdump</a> <a href="/tags/nm/" rel="tag"># nm</a> <a href="/tags/likely/" rel="tag"># likely</a> <a href="/tags/%E5%86%85%E5%BB%BA%E5%87%BD%E6%95%B0/" rel="tag"># 内建函数</a> <a href="/tags/gcc/" rel="tag"># gcc</a> <a href="/tags/%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96/" rel="tag"># 编译优化</a> <a href="/tags/%E6%B1%87%E7%BC%96/" rel="tag"># 汇编</a> <a href="/tags/%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91/" rel="tag"># 模块编译</a></div><div class="post-nav"><div class="post-nav-item"><a href="/archives/12.html" rel="prev" title="linux-通知链notifier学习"><i class="fa fa-chevron-left"></i> linux-通知链notifier学习</a></div><div class="post-nav-item"><a href="/archives/15.html" rel="next" title="gdb调试linux内核&驱动模块">gdb调试linux内核&驱动模块 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#linux-likely%E5%AD%A6%E4%B9%A0"><span class="nav-number">1.</span> <span class="nav-text">linux-likely学习</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%83%8C%E6%99%AF"><span class="nav-number">1.1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.2.</span> <span class="nav-text">实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-number">1.3.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.4.</span> <span class="nav-text">实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83"><span class="nav-number">1.4.1.</span> <span class="nav-text">编译环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81"><span class="nav-number">1.4.2.</span> <span class="nav-text">代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#objdump%E6%B1%87%E7%BC%96"><span class="nav-number">1.4.3.</span> <span class="nav-text">objdump汇编</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#O2"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">-O2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#O0"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">-O0</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#O1"><span class="nav-number">1.4.3.3.</span> <span class="nav-text">-O1</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gdb%E6%9F%A5%E7%9C%8B%E6%B1%87%E7%BC%96"><span class="nav-number">1.4.4.</span> <span class="nav-text">gdb查看汇编</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%B1%E5%85%A5"><span class="nav-number">1.5.</span> <span class="nav-text">深入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#gcc%E5%86%85%E5%BB%BA%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B"><span class="nav-number">1.5.1.</span> <span class="nav-text">gcc内建函数的实现流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#make%E7%BC%96%E8%AF%91%E6%A8%A1%E5%9D%97%E7%94%9F%E6%88%90-o"><span class="nav-number">1.5.1.1.</span> <span class="nav-text">make编译模块生成.o</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8-modules"><span class="nav-number">1.5.1.2.</span> <span class="nav-text">测试编译内核&#x2F;modules</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">Sholck</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">17</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">55</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/xiaer1921" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiaer1921" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:xiaer1921@aliyun.com" title="E-Mail → mailto:xiaer1921@aliyun.com" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/sholck222" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;sholck222" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa-fw"></i>CSDN</a></span></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://hackret.com/" title="https:&#x2F;&#x2F;hackret.com&#x2F;" rel="noopener external nofollow noreferrer" target="_blank">RedHat Kairui</a></li><li class="links-of-blogroll-item"><a href="https://linux-kernel-labs.github.io/refs/heads/master/index.html#" title="https:&#x2F;&#x2F;linux-kernel-labs.github.io&#x2F;refs&#x2F;heads&#x2F;master&#x2F;index.html#" rel="noopener external nofollow noreferrer" target="_blank">Linux Kernel Teaching</a></li><li class="links-of-blogroll-item"><a href="https://tding.top/" title="https:&#x2F;&#x2F;tding.top&#x2F;" rel="noopener external nofollow noreferrer" target="_blank">小丁</a></li><li class="links-of-blogroll-item"><a href="https://xiaozhou.net/" title="https:&#x2F;&#x2F;xiaozhou.net&#x2F;" rel="noopener external nofollow noreferrer" target="_blank">iTimpthy</a></li><li class="links-of-blogroll-item"><a href="https://consen.github.io/" title="https:&#x2F;&#x2F;consen.github.io&#x2F;" rel="noopener external nofollow noreferrer" target="_blank">Consen</a></li></ul></div><div><canvas id="canvas" style="width:60%">当前浏览器不支持canvas，请更换浏览器后再试</canvas></div><script>!function(){var o,a,r,f,t,i=[[[0,0,1,1,1,0,0],[0,1,1,0,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,0,1,1,0],[0,0,1,1,1,0,0]],[[0,0,0,1,1,0,0],[0,1,1,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[1,1,1,1,1,1,1]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,1,1,0,0,0],[0,1,1,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,0,0,1,1],[1,1,1,1,1,1,1]],[[1,1,1,1,1,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,1,1,0],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,0,0,0,1,1,0],[0,0,0,1,1,1,0],[0,0,1,1,1,1,0],[0,1,1,0,1,1,0],[1,1,0,0,1,1,0],[1,1,1,1,1,1,1],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,1,1,1,1]],[[1,1,1,1,1,1,1],[1,1,0,0,0,0,0],[1,1,0,0,0,0,0],[1,1,1,1,1,1,0],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,0,0,0,1,1,0],[0,0,1,1,0,0,0],[0,1,1,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[1,1,1,1,1,1,1],[1,1,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,1,1,0,0,0,0]],[[0,0,0,0,0,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,0,0,0]]],e=document.getElementById("canvas");function h(t,e){for(var n=[1,2,3],l=["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"],o=0;o<i[e].length;o++)for(var a,h=0;h<i[e][o].length;h++){1==i[e][o][h]&&(a={x:14*(f+2)*t+2*h*(f+1)+(f+1),y:2*o*(f+1)+(f+1),stepX:Math.floor(4*Math.random()-2),stepY:-2*n[Math.floor(Math.random()*n.length)],color:l[Math.floor(Math.random()*l.length)],disY:1},r.push(a))}}function n(){e.height=100;for(var t=0;t<a.length;t++)!function(t,e){for(var n=0;n<i[e].length;n++)for(var l=0;l<i[e][n].length;l++)1==i[e][n][l]&&(o.beginPath(),o.arc(14*(f+2)*t+2*l*(f+1)+(f+1),2*n*(f+1)+(f+1),f,0,2*Math.PI),o.closePath(),o.fill())}(t,a[t]);for(t=0;t<r.length;t++)o.beginPath(),o.arc(r[t].x,r[t].y,f,0,2*Math.PI),o.fillStyle=r[t].color,o.closePath(),o.fill()}e.getContext&&(o=e.getContext("2d"),e.height=100,e.width=700,o.fillStyle="#f00",o.fillRect(10,10,50,50),a=[],r=[],f=e.height/20-1,t=/(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date),a.push(t[1],t[2],10,t[3],t[4],10,t[5],t[6]),clearInterval(void 0),setInterval(function(){!function(){var t=[],e=/(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date),n=[];n.push(e[1],e[2],10,e[3],e[4],10,e[5],e[6]);for(var l=a.length-1;0<=l;l--)n[l]!==a[l]&&t.push(l+"_"+(Number(a[l])+1)%10);for(l=0;l<t.length;l++)h.apply(this,t[l].split("_"));a=n.concat()}(),function(){for(var t=0;t<r.length;t++)r[t].stepY+=r[t].disY,r[t].x+=r[t].stepX,r[t].y+=r[t].stepY,(r[t].x>700+f||r[t].y>100+f)&&(r.splice(t,1),t--)}(),n()},50))}()</script><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-history fa-" aria-hidden="true"></i> 近期文章</div><ul class="links-of-blogroll-list"><li><a href="/archives/17.html" title="linux模块初始化分析" target="_blank">linux模块初始化分析</a></li><li><a href="/archives/16.html" title="Kbuild-Makefile学习" target="_blank">Kbuild-Makefile学习</a></li><li><a href="/archives/14.html" title="crash库的开源提交" target="_blank">crash库的开源提交</a></li><li><a href="/archives/15.html" title="gdb调试linux内核&驱动模块" target="_blank">gdb调试linux内核&驱动模块</a></li><li><a href="/archives/13.html" title="linux-likely学习" target="_blank">linux-likely学习</a></li></ul></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2020 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="user"></i> </span><span class="author" itemprop="copyrightHolder">Sholck</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-chart-area"></i> </span><span class="post-meta-item-text">站点总字数：</span> <span title="站点总字数">172k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">2:36</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener external nofollow noreferrer" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener external nofollow noreferrer" target="_blank">NexT.Muse</a> 强力驱动</div><script src="/lib/mermaid/mermaid.min.js"></script><script>window.mermaid&&mermaid.initialize({theme:"forest"})</script></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><script async src="/js/cursor/fireworks.js"></script><script src="/js/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,document.body.addEventListener("input",POWERMODE)</script></body></html>