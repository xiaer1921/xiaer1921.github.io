<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/sholck2.jfif"><link rel="icon" type="image/png" sizes="32x32" href="/images/sholck2.jfif"><link rel="icon" type="image/png" sizes="16x16" href="/images/sholck2.jfif"><link rel="mask-icon" href="/images/sholck2.jfif" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Noto Serif SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"sholck.top",root:"/",scheme:"Muse",version:"7.8.0",exturl:!1,sidebar:{position:"right",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="linux-assembly入门学习学习目的 应用：kernel底层有着大量的汇编语言，包括机器启动强相关的header.s 和原子性函数实现等内嵌汇编 需求：应用coredump，内核转储，内存分析都需要了解汇编才能更深入分析dump现场 提升：根据汇编分析寄存器变化，对堆栈分配，寻址方式等机器运行方式，了解架构机器真正运作的方式"><meta property="og:type" content="article"><meta property="og:title" content="linux-assembly入门学习"><meta property="og:url" content="http://sholck.top/archives/19.html"><meta property="og:site_name" content="Sholck"><meta property="og:description" content="linux-assembly入门学习学习目的 应用：kernel底层有着大量的汇编语言，包括机器启动强相关的header.s 和原子性函数实现等内嵌汇编 需求：应用coredump，内核转储，内存分析都需要了解汇编才能更深入分析dump现场 提升：根据汇编分析寄存器变化，对堆栈分配，寻址方式等机器运行方式，了解架构机器真正运作的方式"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-05-15T16:00:00.000Z"><meta property="article:modified_time" content="2022-06-16T18:45:45.790Z"><meta property="article:author" content="Sholck"><meta property="article:tag" content="汇编"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://sholck.top/archives/19.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>linux-assembly入门学习 | Sholck</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="Sholck" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">Sholck</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">不积跬步,无以至千里.不积小流,无以成江海</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">61</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">6</span></a></li><li class="menu-item menu-item-project"><a href="/project/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>项目</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://sholck.top/archives/19.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="Sholck"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Sholck"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">linux-assembly入门学习</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-05-16 00:00:00" itemprop="dateCreated datePublished" datetime="2022-05-16T00:00:00+08:00">2022-05-16</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-06-17 02:45:45" itemprop="dateModified" datetime="2022-06-17T02:45:45+08:00">2022-06-17</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux-assembly/" itemprop="url" rel="index"><span itemprop="name">linux-assembly</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>16k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>15 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="linux-assembly入门学习"><a href="#linux-assembly入门学习" class="headerlink" title="linux-assembly入门学习"></a>linux-assembly入门学习</h1><h2 id="学习目的"><a href="#学习目的" class="headerlink" title="学习目的"></a>学习目的</h2><ol><li>应用：kernel底层有着大量的汇编语言，包括机器启动强相关的header.s 和原子性函数实现等内嵌汇编</li><li>需求：应用coredump，内核转储，内存分析都需要了解汇编才能更深入分析dump现场</li><li>提升：根据汇编分析寄存器变化，对堆栈分配，寻址方式等机器运行方式，了解架构机器真正运作的方式</li></ol><a id="more"></a><h2 id="汇编特点"><a href="#汇编特点" class="headerlink" title="汇编特点"></a>汇编特点</h2><ol><li>汇编和机器架构硬件的强相关性，能最大发挥硬件特性，比如借助硬件中断, lock等</li><li>不受编译器(gcc)影响，和libc没有直接关系(没有用到库函数)</li><li>关键代码控制，比如保持代码的原子性，通过lock指令进行lock锁总线</li><li>性能优化，虽然锁总线影响性能，但是锁缓存是不是也比mutex快很多(todo)</li></ol><h2 id="汇编介绍"><a href="#汇编介绍" class="headerlink" title="汇编介绍"></a>汇编介绍</h2><p>一种架构强相关，硬件强相关的底层语言，以人类可读的语言在汇编为二进制的机器指令码后控制机器的运行</p><h3 id="汇编语法"><a href="#汇编语法" class="headerlink" title="汇编语法"></a>汇编语法</h3><p>汇编 是根据架构区分的，目前接触的是 AT&amp;T， Inter, arm(需要找个ardroid机器实践)，linux下用的是AT&amp;T，包括header.s和内嵌汇编</p><p>不同架构的汇编语法不同</p><ol><li><p>操作数位置：AT&amp;T和Intel的源操作数，目的操作数位置是相反的</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AT&amp;T语法：源操作数，目的操作数   cmpxchg %ecx, %ebx；如果EAX与EBX相等，则ECX送EBX且ZF置<span class="number">1</span>；否则EBX送EAX，且ZF清<span class="number">0</span></span><br><span class="line">Intel语法: 目的操作数，源操作数   CMPXCHG ebx, ecx ；如果EAX与EBX相等，则ECX送EBX且ZF置<span class="number">1</span>；否则EBX送EAX，且ZF清<span class="number">0</span></span><br></pre></td></tr></table></figure></li><li><p>语法前缀：汇编根据架构，语法前缀也是不同的</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AT&amp;T: 操作数和立即数都是有前缀的。  操作数：%作为前缀 %eax 立即数： $作为前缀  $<span class="number">1</span></span><br><span class="line">Inter:  操作数和立即数无前缀的。    操作数： eax            立即数： <span class="number">1</span></span><br></pre></td></tr></table></figure></li><li><p>操作数字长：操作符去表示操作数字长的方式也不同：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AT&amp;T 由操作符的后缀表示操作数字长： b 单字节   w 双字节   l <span class="number">4</span>字节  q <span class="number">8</span>字节(<span class="number">64b</span>it)， 比如</span><br><span class="line">        movb (%rbx), %al  将rbx指向的地址的首字节复制给al</span><br><span class="line">        movb $<span class="number">10</span>, <span class="number">-1</span>(%rbx)  将<span class="number">10</span>复制给 rbx指向的地址的前一个字节</span><br><span class="line">Intel 通过操作数前面加前缀表示：  比如 byte ptr ， word ptr</span><br></pre></td></tr></table></figure></li><li><p>内存寻址，首先需要了解基本的寻址方式有哪些</p></li></ol><h3 id="汇编工具"><a href="#汇编工具" class="headerlink" title="汇编工具"></a>汇编工具</h3><h4 id="汇编器"><a href="#汇编器" class="headerlink" title="汇编器"></a>汇编器</h4><p>汇编器有as和nasm，可以将汇编代码翻译为二进制的机器码。linux使用的是as，也gcc依赖的汇编器</p><p>as一般的使用和选项如下：</p><pre><code><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-g 汇编时带上行相关信息</span><br><span class="line">-o 指定目标</span><br><span class="line"><span class="params">--32</span> i386架构</span><br><span class="line"><span class="params">--64</span> x86_64架构</span><br><span class="line"><span class="string">//as</span> <span class="params">--gstabs</span> <span class="params">--32</span> -o args.o args.s</span><br></pre></td></tr></table></figure></code></pre><h4 id="链接器"><a href="#链接器" class="headerlink" title="链接器"></a>链接器</h4><p>用来将多个目标代码链接为一个可执行的程序，linux使用的是ld</p><p>ld一般的使用和选项如下：</p><pre><code><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-m emulation模拟仿真器链接 -V 可以查看所有支持的仿真器</span><br><span class="line">-T 指定链接脚本</span><br><span class="line">–script=scriptfile 使用该脚本代替ld默认链接脚本</span><br><span class="line">-o output 指定链接结果</span><br><span class="line">–whole-archive file 将归档文件中的路径的库的符号都链接起来，后面需要跟–no-whole-archive代表界限</span><br><span class="line">-s 删除symbol信息，不利于调试</span><br><span class="line"><span class="comment">//ld -m elf_i386 -o args args.o</span></span><br></pre></td></tr></table></figure></code></pre><p>linux下的链接见：<a href="https://sholck.top/archives/16.html">Kbuild-Makefile学习</a></p><h4 id="调试器"><a href="#调试器" class="headerlink" title="调试器"></a>调试器</h4><p>常用的是gdb, 也有其他的调试器比如ddd, ald，但是调试基本语法都是一致的。</p><h2 id="汇编实践"><a href="#汇编实践" class="headerlink" title="汇编实践"></a>汇编实践</h2><h3 id="实践前提-系统调用的理解"><a href="#实践前提-系统调用的理解" class="headerlink" title="实践前提-系统调用的理解"></a>实践前提-系统调用的理解</h3><p>在应用层可以通过sycall()来进行系统调用，其实是通过libc中的库接口将其转化为汇编语言，要求一般是带系统调用的number和其需要的参数。<br>syscall()库接口针对不同的架构在汇编中调用不同的指令并将参数copy到对应的寄存器，比如在i386和X86_64中如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">arch/ABI   instruction          syscall <span class="meta">#   retval</span></span><br><span class="line">──────────────────────────────────────────────────</span><br><span class="line">arm/OABI   swi NR               -           a1</span><br><span class="line">arm/EABI   swi <span class="number">0x0</span>              r7          r0</span><br><span class="line">arm64      svc #<span class="number">0</span>               x8          x0</span><br><span class="line">i386       <span class="keyword">int</span> $<span class="number">0x80</span>            eax         eax</span><br><span class="line">x86_64     syscall              rax         rax </span><br></pre></td></tr></table></figure><p>汇编调用指令并将系统调用number和调用返回值设置在对应的寄存器中，比如eax或者rax</p><p>不同的架构参数需要copy到不同的寄存器</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">arch/ABI      arg1  arg2  arg3  arg4  arg5  arg6  arg7</span><br><span class="line">──────────────────────────────────────────────────────</span><br><span class="line">arm/OABI      a1    a2    a3    a4    v1    v2    v3</span><br><span class="line">arm/EABI      r0    r1    r2    r3    r4    r5    r6</span><br><span class="line">arm64         x0    x1    x2    x3    x4    x5    -</span><br><span class="line">i386          ebx   ecx   edx   esi   edi   ebp   -</span><br><span class="line">x86_64        rdi   rsi   rdx   r10   r8    r9    -</span><br></pre></td></tr></table></figure><p>针对以上三个平台，我们需要在进行指令调用前将参数按顺序copy到对于的寄存器</p><p>对于不同的架构，系统调用的number编号可能也是不同的，比如linux对符号表的定义如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//arch/x86/entry/syscalls/syscall_32.tbl</span></span><br><span class="line"><span class="number">1</span>       i386    <span class="built_in">exit</span>                    sys_exit</span><br><span class="line"><span class="number">4</span>       i386    write                   sys_write</span><br><span class="line"><span class="comment">//arch/x86/entry/syscalls/syscall_64.tbl</span></span><br><span class="line"><span class="number">1</span>       common  write                   sys_write</span><br><span class="line"><span class="number">60</span>      common  <span class="built_in">exit</span>                    sys_exit</span><br></pre></td></tr></table></figure><p>再编译时通过Makefile处理之后，生成out和uapi两部分</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//arch/x86/entry/syscalls/Makefile</span></span><br><span class="line">out := arch/$(SRCARCH)/include/generated/<span class="keyword">asm</span></span><br><span class="line">uapi := arch/$(SRCARCH)/include/generated/uapi/<span class="keyword">asm</span></span><br></pre></td></tr></table></figure><h3 id="hello-world"><a href="#hello-world" class="headerlink" title="hello-world"></a>hello-world</h3><p>打印hello-world其实就是调用write将”hello world”写到标准输出</p><details><summary>32位汇编打印hello-world</summary><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#hello.s</span></span><br><span class="line">.data</span><br><span class="line">        msg : .<span class="built_in">string</span> <span class="string">&quot;Hello, world!\n&quot;</span></span><br><span class="line">        len = . - msg</span><br><span class="line">.text</span><br><span class="line">.global _start</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">        movl $len, %edx</span><br><span class="line">        movl $msg, %ecx</span><br><span class="line">        movl $<span class="number">1</span>, %ebx</span><br><span class="line">        movl $<span class="number">4</span>, %eax</span><br><span class="line">        <span class="keyword">int</span> $<span class="number">0x80</span></span><br><span class="line"></span><br><span class="line">        movl $<span class="number">0</span>, %ebx</span><br><span class="line">        movl $<span class="number">1</span>, %eax</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> $<span class="number">0x80</span> </span><br></pre></td></tr></table></figure></details><p>编译验证如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不指定架构</span></span><br><span class="line">➜  <span class="number">0</span>-hello-world git:(master) ✗ as -g -o hello.o hello.s </span><br><span class="line">➜  <span class="number">0</span>-hello-world git:(master) ✗ ld -o hello hello.o </span><br><span class="line">➜  <span class="number">0</span>-hello-world git:(master) ✗ file hello</span><br><span class="line">hello: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), statically linked, <span class="keyword">not</span> stripped</span><br><span class="line">➜  <span class="number">0</span>-hello-world git:(master) ✗ ./hello</span><br><span class="line">Hello, world!</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定架构32位</span></span><br><span class="line">➜  <span class="number">0</span>-hello-world git:(master) ✗ as -<span class="number">-32</span> -g -o hello.o hello.s</span><br><span class="line">➜  <span class="number">0</span>-hello-world git:(master) ✗ ld -m elf_i386 -o hello hello.o</span><br><span class="line">➜  <span class="number">0</span>-hello-world git:(master) ✗ ./hello</span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure><h3 id="解析命令行参数"><a href="#解析命令行参数" class="headerlink" title="解析命令行参数"></a>解析命令行参数</h3><h4 id="32位汇编代码"><a href="#32位汇编代码" class="headerlink" title="32位汇编代码"></a>32位汇编代码</h4><p>Linux 汇编语言开发指南上的实例代码无法正常运行，搞了好久，发现需要指定平台进行链接和汇编</p><details><summary>解析命令行参数-32位汇编</summary><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># args.s</span></span><br><span class="line">#.code32</span><br><span class="line">#<span class="number">32</span>位汇编，链接和汇编时需要指定处理器架构</span><br><span class="line">.text</span><br><span class="line">.global _start</span><br><span class="line"></span><br><span class="line">_start: </span><br><span class="line">        popl %ecx    <span class="meta">#argc出栈</span></span><br><span class="line"></span><br><span class="line">vnext: </span><br><span class="line">        popl %ecx   #参数地址出栈</span><br><span class="line">        test %ecx, %ecx   #是否栈为空，栈空时为ecx 为<span class="number">0</span></span><br><span class="line">        jz <span class="built_in">exit</span>      # 栈为空就推出</span><br><span class="line"></span><br><span class="line">        movl %ecx, %ebx  <span class="meta"># ebx作为syscall write的地址部分，所以传递给ebx</span></span><br><span class="line">        xorl %edx, %edx  <span class="meta"># edx目的是为单个参数长度计数，每次都需要置0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">strlen</span>:</span><br><span class="line">        movb (%ebx), %al  #将参数的第一个值传给al</span><br><span class="line">        inc %edx          #长度计数器+<span class="number">1</span></span><br><span class="line">        inc %ebx          #指向参数的第二个值</span><br><span class="line">        test %al, %al     # 如果参数字符为`<span class="number">0</span>`，那么参数长度解析完毕</span><br><span class="line">        jnz <span class="built_in">strlen</span>        # 如果参数没解析完，继续解析</span><br><span class="line">        movb $<span class="number">10</span>, <span class="number">-1</span>(%ebx)  #将`<span class="number">0</span>`字符换位`\n`字符</span><br><span class="line"></span><br><span class="line">        movl $<span class="number">4</span>, %eax    # <span class="number">4</span>在<span class="number">32b</span>it代表为sys_write </span><br><span class="line">        movl $<span class="number">1</span>, %ebx    # <span class="number">1</span>为标准输出</span><br><span class="line">        <span class="keyword">int</span> $<span class="number">0x80</span>   <span class="meta"># syscall中断</span></span><br><span class="line"></span><br><span class="line">        jmp vnext    #解析下一个参数</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span>:</span><br><span class="line">        movl $<span class="number">1</span>, %eax  # sys_exit, <span class="number">32</span> bit</span><br><span class="line">        xorl %ebx, %ebx   # 退出状态值</span><br><span class="line">        <span class="keyword">int</span> $<span class="number">0x80</span></span><br><span class="line"></span><br><span class="line">        ret</span><br></pre></td></tr></table></figure></details><h5 id="正确的编译方式"><a href="#正确的编译方式" class="headerlink" title="正确的编译方式"></a>正确的编译方式</h5><p>编译和验证如下</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="number">1</span>-args git:(master) ✗ as --gstabs -<span class="number">-32</span> -o args.o args.s</span><br><span class="line">➜  <span class="number">1</span>-args git:(master) ✗ ld -m elf_i386 -o args args.o</span><br><span class="line">➜  <span class="number">1</span>-args git:(master) ✗ file args </span><br><span class="line">args: ELF <span class="number">32</span>-bit LSB executable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), statically linked, <span class="keyword">not</span> stripped</span><br><span class="line">➜  <span class="number">1</span>-args git:(master) ✗ ./args test1 tes2 </span><br><span class="line">./args</span><br><span class="line">test1</span><br><span class="line">tes2</span><br></pre></td></tr></table></figure><p>针对X86和X64，as可选的处理器架构参数如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-<span class="number">-32</span> | --x32 | -<span class="number">-64</span></span><br><span class="line">   Select the word size, either <span class="number">32</span> bits <span class="keyword">or</span> <span class="number">64</span> bits.  -<span class="number">-32</span> implies Intel i386 architecture, <span class="keyword">while</span> --x32 <span class="keyword">and</span> -<span class="number">-64</span> imply AMD x86<span class="number">-64</span> architecture with <span class="number">32</span>-bit <span class="keyword">or</span> <span class="number">64</span>-bit word-size respectively.</span><br></pre></td></tr></table></figure><p>ld可选的处理器架构参数如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="number">1</span>-args git:(master) ✗ ld -V</span><br><span class="line">GNU ld (GNU Binutils for Ubuntu) 2.26.1</span><br><span class="line">  支持的仿真：</span><br><span class="line">   elf_x86_64</span><br><span class="line">   elf32_x86_64</span><br><span class="line">   elf_i386</span><br><span class="line">   elf_iamcu</span><br><span class="line">   i386linux</span><br><span class="line">   elf_l1om</span><br><span class="line">   elf_k1om</span><br><span class="line">   i386pep</span><br><span class="line">   i386pe</span><br></pre></td></tr></table></figure><p>as –x32会报错，可能amd 32位下应该用这个参数</p><p>–gstabs对gdb的预览调试还是有影响的，正如-g中描述的一样，为每一行汇编源代码生成调试，gdb调试和objdump -dS都有定位到行。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//as -g --32 -o args.o args.s </span></span><br><span class="line">➜  <span class="number">1</span>-args git:(master) ✗ gdb args</span><br><span class="line">(gdb) b _start</span><br><span class="line">Breakpoint <span class="number">1</span> at <span class="number">0x8048054</span>: file args.s, line <span class="number">7.</span></span><br><span class="line">(gdb) run</span><br><span class="line">Breakpoint <span class="number">1</span>, _start () at args.s:<span class="number">7</span></span><br><span class="line"><span class="number">7</span>               popl %ecx</span><br><span class="line"></span><br><span class="line"><span class="comment">//objdump</span></span><br><span class="line"><span class="number">08048054</span> &lt;_start&gt;:</span><br><span class="line"> <span class="number">8048054</span>:       <span class="number">59</span>                      pop    %ecx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//as --32 -o args.o args.s</span></span><br><span class="line">➜  <span class="number">1</span>-args git:(master) ✗ gdb args</span><br><span class="line">(gdb) b _strt</span><br><span class="line">Breakpoint <span class="number">1</span> at <span class="number">0x8048054</span></span><br><span class="line">(gdb) run</span><br><span class="line">Breakpoint <span class="number">1</span>, <span class="number">0x08048054</span> in _start ()</span><br><span class="line"></span><br><span class="line"><span class="comment">//objdump</span></span><br><span class="line">_start: </span><br><span class="line">        popl %ecx</span><br><span class="line"> <span class="number">8048054</span>:       <span class="number">59</span>                      pop    %ecx</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="错误实践"><a href="#错误实践" class="headerlink" title="错误实践"></a>错误实践</h5><p>起初我使用默认的选项去进行链接和汇编，但是执行会coredump, 下面是我的实践和分析</p><ol><li><p>我本地环境为64位，汇编实际为32位，elf结果是64位的，发现链接不过，因此开头增加标记<code>.code32</code>,不然链接失败，但我并没有意识到问题的严重性</p></li><li><p>strlen 下的 movb (%ebx), %al导致coredump，因为如下</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line"><span class="built_in">strlen</span> () at args.s:<span class="number">19</span></span><br><span class="line"><span class="number">19</span>              movb (%ebx), %al</span><br><span class="line">(gdb) info <span class="keyword">register</span></span><br><span class="line">rax            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rbx            <span class="number">0xffffdeab</span>          <span class="number">4294958763</span></span><br><span class="line">rcx            <span class="number">0x7fffffffdeab</span>      <span class="number">140737488346795</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">(gdb) x/s <span class="number">0x7fffffffdeab</span></span><br><span class="line"><span class="number">0x7fffffffdeab</span>: <span class="string">&quot;/github/linux-driver/linux-assembly/1-args/args&quot;</span></span><br><span class="line">(gdb) x/s <span class="number">0xffffdeab</span></span><br><span class="line"><span class="number">0xffffdeab</span>:     &lt;error: Cannot access memory at address <span class="number">0xffffdeab</span>&gt;</span><br><span class="line"><span class="comment">//发现寄存器都是64位的，64位的如果去寻址32位的有问题</span></span><br></pre></td></tr></table></figure></li><li><p>gdb调试分析发现实际流程和汇编代码不一致，objdump反汇编发现和汇编代码不一致，<br><code>test %al, %al</code>被忽略 导致ZF 标记异常，流程出现异常，如下</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="number">1</span>-args git:(master) ✗ objdump -dS args</span><br><span class="line">args：     文件格式 elf64-x86<span class="number">-64</span>    &gt;&gt;注意到文件格式为<span class="number">64</span>位，和汇编语言增加.code32申明不一致</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    test %al, %al   &gt;&gt;并没有真正执行</span><br><span class="line">    jnz <span class="built_in">strlen</span></span><br><span class="line">  <span class="number">400088</span>:       <span class="number">75</span> f8                   jne    <span class="number">400082</span> &lt;<span class="built_in">strlen</span>&gt;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure></li></ol><h4 id="64位汇编代码"><a href="#64位汇编代码" class="headerlink" title="64位汇编代码"></a>64位汇编代码</h4><details><summary>解析命令行参数-64位汇编</summary><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    popq %rsi</span><br><span class="line">vnext:</span><br><span class="line">    popq %rsi</span><br><span class="line">    testq %rsi, %rsi </span><br><span class="line">    jz <span class="built_in">exit</span></span><br><span class="line">    movq %rsi, %rbx </span><br><span class="line">    xorq %rdx, %rdx</span><br><span class="line"><span class="built_in">strlen</span>:</span><br><span class="line">    movb (%rbx), %al</span><br><span class="line">    incq %rdx</span><br><span class="line">    incq %rbx</span><br><span class="line">    testb %al, %al</span><br><span class="line">    jnz <span class="built_in">strlen</span></span><br><span class="line">    movb $<span class="number">10</span>, <span class="number">-1</span>(%rbx) #<span class="number">10</span>是换行键</span><br><span class="line">    movq $<span class="number">1</span>, %rax # 系统调用号(sys_write) </span><br><span class="line">    movq $<span class="number">1</span>, %rdi # 文件描述符(<span class="built_in">stdout</span>) </span><br><span class="line">    syscall</span><br><span class="line">    jmp vnext</span><br><span class="line"><span class="built_in">exit</span>:</span><br><span class="line">    movq $<span class="number">60</span>,%rax</span><br><span class="line">    movq $<span class="number">0</span>,%rdi</span><br><span class="line">    syscall</span><br></pre></td></tr></table></figure></details><p>64位代码运行如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="number">1</span>-args git:(master) ✗ as -g -<span class="number">-64</span> -o args-x86_64.o args-x86_64.s</span><br><span class="line">➜  <span class="number">1</span>-args git:(master) ✗ ld -m elf_x86_64 -o args-x86_64 args-x86_64.o</span><br><span class="line">➜  <span class="number">1</span>-args git:(master) ✗ ./args-x86_64 test1 test2</span><br><span class="line">./args-x86_64</span><br><span class="line">test1</span><br><span class="line">test2</span><br></pre></td></tr></table></figure><details><summary>gdb分析64位代码运行</summary><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="number">1</span>-args git:(master) ✗ gdb args-x86_64</span><br><span class="line">(gdb) b _start</span><br><span class="line">Breakpoint <span class="number">1</span> at <span class="number">0x400078</span>: file args-x86_64.s, line <span class="number">5.</span></span><br><span class="line">(gdb) b vnext</span><br><span class="line">Breakpoint <span class="number">2</span> at <span class="number">0x400079</span>: file args-x86_64.s, line <span class="number">7.</span></span><br><span class="line">(gdb) b <span class="built_in">strlen</span></span><br><span class="line">Breakpoint <span class="number">3</span> at <span class="number">0x400085</span>: file args-x86_64.s, line <span class="number">13.</span></span><br><span class="line">(gdb) run test1</span><br><span class="line">Starting program: /github/linux-driver/linux-assembly/<span class="number">1</span>-args/args-x86_64 test1</span><br><span class="line">Breakpoint <span class="number">1</span>, _start () at args-x86_64.s:<span class="number">5</span></span><br><span class="line"><span class="number">5</span>           popq %rsi</span><br><span class="line">(gdb) info <span class="keyword">register</span></span><br><span class="line">rax            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rbx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rcx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rdx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rsi            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rdi            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rbp            <span class="number">0x0</span>                 <span class="number">0x0</span></span><br><span class="line">rsp            <span class="number">0x7fffffffdac0</span>      <span class="number">0x7fffffffdac0</span></span><br><span class="line">r8             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r9             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r10            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r11            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r12            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r13            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r14            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r15            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rip            <span class="number">0x400078</span>            <span class="number">0x400078</span> &lt;_start&gt;</span><br><span class="line">eflags         <span class="number">0x202</span>               [ IF ]</span><br><span class="line">cs             <span class="number">0x33</span>                <span class="number">51</span></span><br><span class="line">ss             <span class="number">0x2b</span>                <span class="number">43</span></span><br><span class="line">ds             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">es             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">fs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">gs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">(gdb) n</span><br><span class="line">Breakpoint <span class="number">2</span>, vnext () at args-x86_64.s:<span class="number">7</span></span><br><span class="line"><span class="number">7</span>           popq %rsi</span><br><span class="line">(gdb) info <span class="keyword">register</span></span><br><span class="line">rax            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rbx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rcx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rdx            <span class="number">0x0</span>                 <span class="number">0</span> </span><br><span class="line">rsi            <span class="number">0x2</span>                 <span class="number">2</span>   &gt;&gt;argc为<span class="number">2</span></span><br><span class="line">rdi            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rbp            <span class="number">0x0</span>                 <span class="number">0x0</span></span><br><span class="line">rsp            <span class="number">0x7fffffffdac8</span>      <span class="number">0x7fffffffdac8</span>  &gt;&gt;popq一次，栈指针下移</span><br><span class="line">r8             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r9             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r10            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r11            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r12            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r13            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r14            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r15            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rip            <span class="number">0x400079</span>            <span class="number">0x400079</span> &lt;vnext&gt;</span><br><span class="line">eflags         <span class="number">0x202</span>               [ IF ]</span><br><span class="line">cs             <span class="number">0x33</span>                <span class="number">51</span></span><br><span class="line">ss             <span class="number">0x2b</span>                <span class="number">43</span></span><br><span class="line">ds             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">es             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">fs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">gs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">(gdb) n</span><br><span class="line">vnext () at args-x86_64.s:<span class="number">8</span></span><br><span class="line"><span class="number">8</span>           testq %rsi, %rsi </span><br><span class="line">(gdb) info <span class="keyword">register</span></span><br><span class="line">rax            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rbx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rcx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rdx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rsi            <span class="number">0x7fffffffde96</span>      <span class="number">140737488346774</span>  &gt;&gt;argv[<span class="number">0</span>]地址</span><br><span class="line">rdi            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rbp            <span class="number">0x0</span>                 <span class="number">0x0</span></span><br><span class="line">rsp            <span class="number">0x7fffffffdad0</span>      <span class="number">0x7fffffffdad0</span>   &gt;&gt;popq一次，栈指针下移</span><br><span class="line">r8             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r9             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r10            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r11            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r12            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r13            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r14            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r15            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rip            <span class="number">0x40007a</span>            <span class="number">0x40007a</span> &lt;vnext+<span class="number">1</span>&gt;</span><br><span class="line">eflags         <span class="number">0x202</span>               [ IF ]</span><br><span class="line">cs             <span class="number">0x33</span>                <span class="number">51</span></span><br><span class="line">ss             <span class="number">0x2b</span>                <span class="number">43</span></span><br><span class="line">ds             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">es             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">fs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">gs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">(gdb) n</span><br><span class="line"><span class="number">9</span>           jz <span class="built_in">exit</span></span><br><span class="line">(gdb) info <span class="keyword">register</span></span><br><span class="line">rax            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rbx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rcx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rdx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rsi            <span class="number">0x7fffffffde96</span>      <span class="number">140737488346774</span></span><br><span class="line">rdi            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rbp            <span class="number">0x0</span>                 <span class="number">0x0</span></span><br><span class="line">rsp            <span class="number">0x7fffffffdad0</span>      <span class="number">0x7fffffffdad0</span></span><br><span class="line">r8             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r9             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r10            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r11            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r12            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r13            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r14            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r15            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rip            <span class="number">0x40007d</span>            <span class="number">0x40007d</span> &lt;vnext+<span class="number">4</span>&gt;</span><br><span class="line">eflags         <span class="number">0x206</span>               [ PF IF ]</span><br><span class="line">cs             <span class="number">0x33</span>                <span class="number">51</span></span><br><span class="line">ss             <span class="number">0x2b</span>                <span class="number">43</span></span><br><span class="line">ds             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">es             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">fs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">gs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">(gdb) n</span><br><span class="line"><span class="number">10</span>          movq %rsi, %rbx </span><br><span class="line">(gdb) info <span class="keyword">register</span></span><br><span class="line">rax            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rbx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rcx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rdx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rsi            <span class="number">0x7fffffffde96</span>      <span class="number">140737488346774</span></span><br><span class="line">rdi            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rbp            <span class="number">0x0</span>                 <span class="number">0x0</span></span><br><span class="line">rsp            <span class="number">0x7fffffffdad0</span>      <span class="number">0x7fffffffdad0</span></span><br><span class="line">r8             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r9             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r10            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r11            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r12            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r13            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r14            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r15            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rip            <span class="number">0x40007f</span>            <span class="number">0x40007f</span> &lt;vnext+<span class="number">6</span>&gt;</span><br><span class="line">eflags         <span class="number">0x206</span>               [ PF IF ]</span><br><span class="line">cs             <span class="number">0x33</span>                <span class="number">51</span></span><br><span class="line">ss             <span class="number">0x2b</span>                <span class="number">43</span></span><br><span class="line">ds             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">es             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">fs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">gs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">(gdb) n</span><br><span class="line"><span class="number">11</span>          xorq %rdx, %rdx</span><br><span class="line">(gdb) info <span class="keyword">register</span></span><br><span class="line">rax            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rbx            <span class="number">0x7fffffffde96</span>      <span class="number">140737488346774</span></span><br><span class="line">rcx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rdx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rsi            <span class="number">0x7fffffffde96</span>      <span class="number">140737488346774</span></span><br><span class="line">rdi            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rbp            <span class="number">0x0</span>                 <span class="number">0x0</span></span><br><span class="line">rsp            <span class="number">0x7fffffffdad0</span>      <span class="number">0x7fffffffdad0</span></span><br><span class="line">r8             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r9             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r10            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r11            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r12            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r13            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r14            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r15            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rip            <span class="number">0x400082</span>            <span class="number">0x400082</span> &lt;vnext+<span class="number">9</span>&gt;</span><br><span class="line">eflags         <span class="number">0x206</span>               [ PF IF ]</span><br><span class="line">cs             <span class="number">0x33</span>                <span class="number">51</span></span><br><span class="line">ss             <span class="number">0x2b</span>                <span class="number">43</span></span><br><span class="line">ds             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">es             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">fs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">gs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">(gdb) n</span><br><span class="line">Breakpoint <span class="number">3</span>, <span class="built_in">strlen</span> () at args-x86_64.s:<span class="number">13</span></span><br><span class="line"><span class="number">13</span>          movb (%rbx), %al</span><br><span class="line">(gdb) info <span class="keyword">register</span></span><br><span class="line">rax            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rbx            <span class="number">0x7fffffffde96</span>      <span class="number">140737488346774</span></span><br><span class="line">rcx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rdx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rsi            <span class="number">0x7fffffffde96</span>      <span class="number">140737488346774</span></span><br><span class="line">rdi            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rbp            <span class="number">0x0</span>                 <span class="number">0x0</span></span><br><span class="line">rsp            <span class="number">0x7fffffffdad0</span>      <span class="number">0x7fffffffdad0</span></span><br><span class="line">r8             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r9             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r10            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r11            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r12            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r13            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r14            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r15            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rip            <span class="number">0x400085</span>            <span class="number">0x400085</span> &lt;<span class="built_in">strlen</span>&gt;</span><br><span class="line">eflags         <span class="number">0x246</span>               [ PF ZF IF ]</span><br><span class="line">cs             <span class="number">0x33</span>                <span class="number">51</span></span><br><span class="line">ss             <span class="number">0x2b</span>                <span class="number">43</span></span><br><span class="line">ds             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">es             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">fs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">gs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">(gdb) n</span><br><span class="line"><span class="number">14</span>          incq %rdx</span><br><span class="line">(gdb) info <span class="keyword">register</span></span><br><span class="line">rax            <span class="number">0x2f</span>                <span class="number">47</span>                 &gt;&gt; `/`的ASCII是<span class="number">0x2f</span></span><br><span class="line">rbx            <span class="number">0x7fffffffde96</span>      <span class="number">140737488346774</span></span><br><span class="line">rcx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rdx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rsi            <span class="number">0x7fffffffde96</span>      <span class="number">140737488346774</span></span><br><span class="line">rdi            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rbp            <span class="number">0x0</span>                 <span class="number">0x0</span></span><br><span class="line">rsp            <span class="number">0x7fffffffdad0</span>      <span class="number">0x7fffffffdad0</span></span><br><span class="line">r8             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r9             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r10            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r11            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r12            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r13            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r14            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r15            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rip            <span class="number">0x400087</span>            <span class="number">0x400087</span> &lt;<span class="built_in">strlen</span>+<span class="number">2</span>&gt;</span><br><span class="line">eflags         <span class="number">0x246</span>               [ PF ZF IF ]</span><br><span class="line">cs             <span class="number">0x33</span>                <span class="number">51</span></span><br><span class="line">ss             <span class="number">0x2b</span>                <span class="number">43</span></span><br><span class="line">ds             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">es             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">fs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">gs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">(gdb) x/s <span class="number">0x7fffffffde96</span>         &gt;&gt;打印第一个参数</span><br><span class="line"><span class="number">0x7fffffffde96</span>: <span class="string">&quot;/github/linux-driver/linux-assembly/1-args/args-x86_64&quot;</span></span><br><span class="line">(gdb) x/x <span class="number">0x7fffffffde96</span></span><br><span class="line"><span class="number">0x7fffffffde96</span>: <span class="number">0x2f</span></span><br><span class="line">(gdb) x/c <span class="number">0x7fffffffde96</span></span><br><span class="line"><span class="number">0x7fffffffde96</span>: <span class="number">47</span> <span class="string">&#x27;/&#x27;</span></span><br><span class="line">(gdb) x/<span class="number">55</span>c <span class="number">0x7fffffffde96</span></span><br><span class="line"><span class="number">0x7fffffffde96</span>: <span class="number">47</span> <span class="string">&#x27;/&#x27;</span>  <span class="number">103</span> <span class="string">&#x27;g&#x27;</span> <span class="number">105</span> <span class="string">&#x27;i&#x27;</span> <span class="number">116</span> <span class="string">&#x27;t&#x27;</span> <span class="number">104</span> <span class="string">&#x27;h&#x27;</span> <span class="number">117</span> <span class="string">&#x27;u&#x27;</span> <span class="number">98</span> <span class="string">&#x27;b&#x27;</span>  <span class="number">47</span> <span class="string">&#x27;/&#x27;</span></span><br><span class="line"><span class="number">0x7fffffffde9e</span>: <span class="number">108</span> <span class="string">&#x27;l&#x27;</span> <span class="number">105</span> <span class="string">&#x27;i&#x27;</span> <span class="number">110</span> <span class="string">&#x27;n&#x27;</span> <span class="number">117</span> <span class="string">&#x27;u&#x27;</span> <span class="number">120</span> <span class="string">&#x27;x&#x27;</span> <span class="number">45</span> <span class="string">&#x27;-&#x27;</span>  <span class="number">100</span> <span class="string">&#x27;d&#x27;</span> <span class="number">114</span> <span class="string">&#x27;r&#x27;</span></span><br><span class="line"><span class="number">0x7fffffffdea6</span>: <span class="number">105</span> <span class="string">&#x27;i&#x27;</span> <span class="number">118</span> <span class="string">&#x27;v&#x27;</span> <span class="number">101</span> <span class="string">&#x27;e&#x27;</span> <span class="number">114</span> <span class="string">&#x27;r&#x27;</span> <span class="number">47</span> <span class="string">&#x27;/&#x27;</span>  <span class="number">108</span> <span class="string">&#x27;l&#x27;</span> <span class="number">105</span> <span class="string">&#x27;i&#x27;</span> <span class="number">110</span> <span class="string">&#x27;n&#x27;</span></span><br><span class="line"><span class="number">0x7fffffffdeae</span>: <span class="number">117</span> <span class="string">&#x27;u&#x27;</span> <span class="number">120</span> <span class="string">&#x27;x&#x27;</span> <span class="number">45</span> <span class="string">&#x27;-&#x27;</span>  <span class="number">97</span> <span class="string">&#x27;a&#x27;</span>  <span class="number">115</span> <span class="string">&#x27;s&#x27;</span> <span class="number">115</span> <span class="string">&#x27;s&#x27;</span> <span class="number">101</span> <span class="string">&#x27;e&#x27;</span> <span class="number">109</span> <span class="string">&#x27;m&#x27;</span></span><br><span class="line"><span class="number">0x7fffffffdeb6</span>: <span class="number">98</span> <span class="string">&#x27;b&#x27;</span>  <span class="number">108</span> <span class="string">&#x27;l&#x27;</span> <span class="number">121</span> <span class="string">&#x27;y&#x27;</span> <span class="number">47</span> <span class="string">&#x27;/&#x27;</span>  <span class="number">49</span> <span class="string">&#x27;1&#x27;</span>  <span class="number">45</span> <span class="string">&#x27;-&#x27;</span>  <span class="number">97</span> <span class="string">&#x27;a&#x27;</span>  <span class="number">114</span> <span class="string">&#x27;r&#x27;</span></span><br><span class="line"><span class="number">0x7fffffffdebe</span>: <span class="number">103</span> <span class="string">&#x27;g&#x27;</span> <span class="number">115</span> <span class="string">&#x27;s&#x27;</span> <span class="number">47</span> <span class="string">&#x27;/&#x27;</span>  <span class="number">97</span> <span class="string">&#x27;a&#x27;</span>  <span class="number">114</span> <span class="string">&#x27;r&#x27;</span> <span class="number">103</span> <span class="string">&#x27;g&#x27;</span> <span class="number">115</span> <span class="string">&#x27;s&#x27;</span> <span class="number">45</span> <span class="string">&#x27;-&#x27;</span></span><br><span class="line"><span class="number">0x7fffffffdec6</span>: <span class="number">120</span> <span class="string">&#x27;x&#x27;</span> <span class="number">56</span> <span class="string">&#x27;8&#x27;</span>  <span class="number">54</span> <span class="string">&#x27;6&#x27;</span>  <span class="number">95</span> <span class="string">&#x27;_&#x27;</span>  <span class="number">54</span> <span class="string">&#x27;6&#x27;</span>  <span class="number">52</span> <span class="string">&#x27;4&#x27;</span>  <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span></span><br><span class="line">&gt;&gt;注意最后一个是ASCII <span class="number">0</span></span><br><span class="line">(gdb) c </span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="number">3</span>, <span class="built_in">strlen</span> () at args-x86_64.s:<span class="number">13</span></span><br><span class="line"><span class="number">13</span>          movb (%rbx), %al</span><br><span class="line">(gdb) info <span class="keyword">register</span></span><br><span class="line">rax            <span class="number">0x2f</span>                <span class="number">47</span></span><br><span class="line">rbx            <span class="number">0x7fffffffde97</span>      <span class="number">140737488346775</span>  &gt;&gt;指向参数的下一个字符</span><br><span class="line">rcx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rdx            <span class="number">0x1</span>                 <span class="number">1</span>          &gt;&gt;长度计数已经为<span class="number">1</span></span><br><span class="line">rsi            <span class="number">0x7fffffffde96</span>      <span class="number">140737488346774</span></span><br><span class="line">rdi            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rbp            <span class="number">0x0</span>                 <span class="number">0x0</span></span><br><span class="line">rsp            <span class="number">0x7fffffffdad0</span>      <span class="number">0x7fffffffdad0</span></span><br><span class="line">r8             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r9             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r10            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r11            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r12            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r13            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r14            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r15            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rip            <span class="number">0x400085</span>            <span class="number">0x400085</span> &lt;<span class="built_in">strlen</span>&gt;</span><br><span class="line">eflags         <span class="number">0x202</span>               [ IF ]</span><br><span class="line">cs             <span class="number">0x33</span>                <span class="number">51</span></span><br><span class="line">ss             <span class="number">0x2b</span>                <span class="number">43</span></span><br><span class="line">ds             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">es             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">fs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">gs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">(gdb) disable <span class="number">3</span></span><br><span class="line">(gdb) b args-x86_64.s:<span class="number">18</span></span><br><span class="line">Breakpoint <span class="number">4</span> at <span class="number">0x400091</span>: file args-x86_64.s, line <span class="number">18.</span>   &gt;&gt;想要结束第一个参数的解析</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="number">4</span>, <span class="built_in">strlen</span> () at args-x86_64.s:<span class="number">18</span></span><br><span class="line"><span class="number">18</span>          movb $<span class="number">10</span>, <span class="number">-1</span>(%rbx) #<span class="number">10</span>是换行键</span><br><span class="line">(gdb) info registers </span><br><span class="line">rax            <span class="number">0x0</span>                 <span class="number">0</span>         &gt;&gt;此时为尾部的ASCII <span class="number">0</span></span><br><span class="line">rbx            <span class="number">0x7fffffffdecd</span>      <span class="number">140737488346829</span>   &gt;&gt;指向参数尾部ASCII <span class="number">0</span>的下一个字符地址</span><br><span class="line">rcx            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rdx            <span class="number">0x37</span>                <span class="number">55</span>          &gt;&gt;长度计数为<span class="number">55</span>,包括尾部的ASCII <span class="number">0</span></span><br><span class="line">rsi            <span class="number">0x7fffffffde96</span>      <span class="number">140737488346774</span></span><br><span class="line">rdi            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rbp            <span class="number">0x0</span>                 <span class="number">0x0</span></span><br><span class="line">rsp            <span class="number">0x7fffffffdad0</span>      <span class="number">0x7fffffffdad0</span></span><br><span class="line">r8             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r9             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r10            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r11            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r12            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r13            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r14            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r15            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rip            <span class="number">0x400091</span>            <span class="number">0x400091</span> &lt;<span class="built_in">strlen</span>+<span class="number">12</span>&gt;</span><br><span class="line">eflags         <span class="number">0x246</span>               [ PF ZF IF ]  &gt;&gt;注意此时ZF=<span class="number">1</span>, 因为testb %al, %al 结果为<span class="number">0</span>,所以ZF置位</span><br><span class="line">cs             <span class="number">0x33</span>                <span class="number">51</span></span><br><span class="line">ss             <span class="number">0x2b</span>                <span class="number">43</span></span><br><span class="line">ds             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">es             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">fs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">gs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">(gdb) x/<span class="number">2</span>c <span class="number">0x7fffffffdecb</span> </span><br><span class="line"><span class="number">0x7fffffffdecb</span>: <span class="number">52</span> <span class="string">&#x27;4&#x27;</span>  <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span> &gt;&gt;确认一致</span><br><span class="line">(gdb) info b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line"><span class="number">1</span>       breakpoint     keep y   <span class="number">0x0000000000400078</span> args-x86_64.s:<span class="number">5</span></span><br><span class="line">        breakpoint already hit <span class="number">1</span> time</span><br><span class="line"><span class="number">2</span>       breakpoint     keep y   <span class="number">0x0000000000400079</span> args-x86_64.s:<span class="number">7</span></span><br><span class="line">        breakpoint already hit <span class="number">1</span> time</span><br><span class="line"><span class="number">3</span>       breakpoint     keep n   <span class="number">0x0000000000400085</span> args-x86_64.s:<span class="number">13</span></span><br><span class="line">        breakpoint already hit <span class="number">2</span> times</span><br><span class="line"><span class="number">4</span>       breakpoint     keep y   <span class="number">0x0000000000400091</span> args-x86_64.s:<span class="number">18</span></span><br><span class="line">        breakpoint already hit <span class="number">1</span> time</span><br><span class="line">(gdb) disable <span class="number">4</span>  &gt;&gt;想要跳出第一个参数的解析</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">/github/linux-driver/linux-assembly/<span class="number">1</span>-args/args-x86_64</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="number">2</span>, vnext () at args-x86_64.s:<span class="number">7</span></span><br><span class="line"><span class="number">7</span>           popq %rsi   &gt;&gt;开始要解析test1这个参数</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">test1</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="number">2</span>, vnext () at args-x86_64.s:<span class="number">7</span></span><br><span class="line"><span class="number">7</span>           popq %rsi</span><br><span class="line">(gdb) info registers </span><br><span class="line">rax            <span class="number">0x6</span>                 <span class="number">6</span>            &gt;&gt;write函数返回值，上一次成功写入<span class="number">6</span>个字符</span><br><span class="line">rbx            <span class="number">0x7fffffffded3</span>      <span class="number">140737488346835</span></span><br><span class="line">rcx            <span class="number">0x4000a5</span>            <span class="number">4194469</span></span><br><span class="line">rdx            <span class="number">0x6</span>                 <span class="number">6</span>   &gt;&gt;第二个参数计数为<span class="number">6</span></span><br><span class="line">rsi            <span class="number">0x7fffffffdecd</span>      <span class="number">140737488346829</span></span><br><span class="line">rdi            <span class="number">0x1</span>                 <span class="number">1</span></span><br><span class="line">rbp            <span class="number">0x0</span>                 <span class="number">0x0</span></span><br><span class="line">rsp            <span class="number">0x7fffffffdad8</span>      <span class="number">0x7fffffffdad8</span></span><br><span class="line">r8             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r9             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r10            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r11            <span class="number">0x246</span>               <span class="number">582</span></span><br><span class="line">r12            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r13            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r14            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r15            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rip            <span class="number">0x400079</span>            <span class="number">0x400079</span> &lt;vnext&gt;</span><br><span class="line">eflags         <span class="number">0x246</span>               [ PF ZF IF ]</span><br><span class="line">cs             <span class="number">0x33</span>                <span class="number">51</span></span><br><span class="line">ss             <span class="number">0x2b</span>                <span class="number">43</span></span><br><span class="line">ds             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">es             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">fs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">gs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">(gdb) b args-x86_64.s:<span class="number">8</span>                     &gt;&gt;想要检查rsi的值</span><br><span class="line">Breakpoint <span class="number">5</span> at <span class="number">0x40007a</span>: file args-x86_64.s, line <span class="number">8.</span> </span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="number">5</span>, vnext () at args-x86_64.s:<span class="number">8</span></span><br><span class="line"><span class="number">8</span>           testq %rsi, %rsi </span><br><span class="line">(gdb) info registers </span><br><span class="line">rax            <span class="number">0x6</span>                 <span class="number">6</span> </span><br><span class="line">rbx            <span class="number">0x7fffffffded3</span>      <span class="number">140737488346835</span></span><br><span class="line">rcx            <span class="number">0x4000a5</span>            <span class="number">4194469</span></span><br><span class="line">rdx            <span class="number">0x6</span>                 <span class="number">6</span></span><br><span class="line">rsi            <span class="number">0x0</span>                 <span class="number">0</span>          &gt;&gt;rsi为空</span><br><span class="line">rdi            <span class="number">0x1</span>                 <span class="number">1</span></span><br><span class="line">rbp            <span class="number">0x0</span>                 <span class="number">0x0</span></span><br><span class="line">rsp            <span class="number">0x7fffffffdae0</span>      <span class="number">0x7fffffffdae0</span></span><br><span class="line">r8             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r9             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r10            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r11            <span class="number">0x246</span>               <span class="number">582</span></span><br><span class="line">r12            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r13            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r14            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">r15            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rip            <span class="number">0x40007a</span>            <span class="number">0x40007a</span> &lt;vnext+<span class="number">1</span>&gt;</span><br><span class="line">eflags         <span class="number">0x246</span>               [ PF ZF IF ]</span><br><span class="line">cs             <span class="number">0x33</span>                <span class="number">51</span></span><br><span class="line">ss             <span class="number">0x2b</span>                <span class="number">43</span></span><br><span class="line">ds             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">es             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">fs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">gs             <span class="number">0x0</span>                 <span class="number">0</span></span><br></pre></td></tr></table></figure></details><h2 id="内联汇编"><a href="#内联汇编" class="headerlink" title="内联汇编"></a>内联汇编</h2><p>内联汇编在<a href="https://sholck.top/archives/18.html#more">cmpxchg kernel-api学习</a>这一部分已经有过描述，下面一部分主要是系统的介绍</p><p>为了针对关键代码进行控制和优化，因此在c代码中引入汇编，称为内联汇编，我们需要按照规则进行编写，内联汇编则会由gcc进行解析。</p><p>汇编与c之间的联系，问题有：</p><ol><li>变量如何分配给寄存器</li><li>变量是否分配给寄存器，或是直接通过指令直接进行内存操作</li><li>如果变量传给寄存器进行运算，之后是否需要回写到变量内存</li><li>…</li></ol><p>内联汇编基本格式为<code>__asm__(&quot;asm statements&quot; : outputs : inputs : registers-modified);</code></p><p>其编写规则分为如下4个部分，解决了以上问题</p><ol><li>指令部分(内联模板)：描述汇编指令，用%0, %1描述将用第几个操作数传递到寄存器或者直接操作内存进行运算<br>因为AT&amp;T寄存器也是使用%描述，因此使用%%来描述寄存器</li><li>输出部分：操作数约束条件 + 输出操作数，约束条件前加=或者+，之后回写到内存变量</li><li>输入部分：操作数约束条件 + 输入操作数</li><li>clobbers：对内存变量/寄存器/编译优化的规则描述,一般设置如下：<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">寄存器: 指的是非输出输入部分列出的，在指令部分显示和隐式使用的寄存器说明，比如保存中间结果寄存器，指的是我们破坏了这些寄存器原本的数值</span><br><span class="line">memory: 不要将这段指令和内嵌汇编前的指令重新排序，也就是在执行内嵌汇编代码之前，它前面的指令都执行完毕</span><br><span class="line">        不要将内存变量缓存到寄存器，因为指令中可能用到了内存变量，而这些内存变量可能会因为其他原因改变</span><br><span class="line">        在内嵌汇编之后再使用内嵌汇编中的变量，应该从内存重新装载，而不是使用寄存器的值，因为寄存器的值可能已经发生改变</span><br></pre></td></tr></table></figure></li></ol><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://baijiahao.baidu.com/s?id=1722268508697136684&wfr=spider&for=pc">嵌入式汇编（内联汇编）</a>同样对这部分有很好的描述</p><h3 id="实践-copy"><a href="#实践-copy" class="headerlink" title="实践-copy"></a>实践-copy</h3><details><summary>将c copy到a和b</summary><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> asm __asm__    </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> volatile __volatile__ </span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * 将c复制到a和b</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">1</span>, b = <span class="number">2</span>, c = <span class="number">3</span>, d = <span class="number">4</span>;    </span><br><span class="line">        <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;movl %2, %%ebx \n\t&quot;</span>    </span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="string">&quot;movl %%ebx, %1 \n\t&quot;</span>    </span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="string">&quot;movl %%ebx, %3&quot;</span>    </span></span></span><br><span class="line"><span class="function"><span class="params">                     : <span class="string">&quot;=a&quot;</span> (a), <span class="string">&quot;=r&quot;</span> (b)    </span></span></span><br><span class="line"><span class="function"><span class="params">                     : <span class="string">&quot;0&quot;</span> (c), <span class="string">&quot;r&quot;</span> (d)    </span></span></span><br><span class="line"><span class="function"><span class="params">                     : <span class="string">&quot;%ebx&quot;</span>)</span></span>;    </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;a is %d, b is %d, c is %d, d is%d \n&quot;</span>, a, b, c, d);    </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; </span><br></pre></td></tr></table></figure></details><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="keyword">inline</span>-assembly git:(master) ✗ gcc -o copy2.o copy2.c </span><br><span class="line">➜  <span class="keyword">inline</span>-assembly git:(master) ✗ ./copy2.o </span><br><span class="line">    a is <span class="number">3</span>, b is <span class="number">3</span>, c is <span class="number">3</span>, d is4 </span><br><span class="line">    c copy到a 是通过将c绑定到eax，之后输出时eax回写到a</span><br><span class="line">    c copy到b 是通过将中间寄存器ebx 复制到b</span><br><span class="line">    d不变是因为d对应的寄存器参与了运算，但是没有回写到b</span><br></pre></td></tr></table></figure><h3 id="实践-cmpxchgl"><a href="#实践-cmpxchgl" class="headerlink" title="实践-cmpxchgl"></a>实践-cmpxchgl</h3><details><summary>cmpxchgl</summary><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> asm __asm__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> volatile __volatile__</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*    </span></span><br><span class="line"><span class="comment"> * 比较并交换，见指令cmpxchg</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> A = <span class="number">1</span>, old = <span class="number">2</span>, <span class="keyword">new</span> = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">int</span> *ptr = &amp;A;</span><br><span class="line"> 	<span class="keyword">int</span> ret;</span><br><span class="line">        <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;lock;&quot;</span> <span class="string">&quot;cmpxchgl %2,%1&quot;</span>               \</span></span></span><br><span class="line"><span class="function"><span class="params">                     : <span class="string">&quot;=a&quot;</span> (ret), <span class="string">&quot;+m&quot;</span> (*ptr)              \</span></span></span><br><span class="line"><span class="function"><span class="params">                     : <span class="string">&quot;r&quot;</span> (<span class="keyword">new</span>), <span class="string">&quot;0&quot;</span> (old)                 \</span></span></span><br><span class="line"><span class="function"><span class="params">                     : <span class="string">&quot;memory&quot;</span>)</span></span>; </span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;ret is %d, A is %d, old is %d\n&quot;</span>, ret, A, old);</span><br><span class="line">        A = <span class="number">2</span>;</span><br><span class="line">        <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;lock;&quot;</span> <span class="string">&quot;cmpxchgl %2,%1&quot;</span>               \</span></span></span><br><span class="line"><span class="function"><span class="params">                     : <span class="string">&quot;=a&quot;</span> (ret), <span class="string">&quot;+m&quot;</span> (*ptr)              \</span></span></span><br><span class="line"><span class="function"><span class="params">                     : <span class="string">&quot;r&quot;</span> (<span class="keyword">new</span>), <span class="string">&quot;0&quot;</span> (old)                 \</span></span></span><br><span class="line"><span class="function"><span class="params">                     : <span class="string">&quot;memory&quot;</span>)</span></span>; </span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;ret is %d, A is %d, old is %d\n&quot;</span>, ret, A, old);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="keyword">inline</span>-assembly git:(master) ✗ gcc -o cmpxchgl cmpxchgl.c</span><br><span class="line">➜  <span class="keyword">inline</span>-assembly git:(master) ✗ ./cmpxchgl </span><br><span class="line">ret is <span class="number">1</span>, A is <span class="number">1</span>, old is <span class="number">2</span></span><br><span class="line">ret is <span class="number">2</span>, A is <span class="number">3</span>, old is <span class="number">2</span></span><br><span class="line"><span class="comment">//A !=old， ret = A</span></span><br><span class="line"><span class="comment">//A == old, ret不变， A=new</span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol><li>Linux 汇编语言开发指南</li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jianshu.com/p/a679c250dbfc">在Linux虚拟机上写汇编-2.处理命令行参数</a></li></ol></div><div class="popular-posts-header">推荐文章</div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/13.html" rel="bookmark">linux-likely学习</a></div></li></ul><footer class="post-footer"><div class="post-tags"><a href="/tags/%E6%B1%87%E7%BC%96/" rel="tag"># 汇编</a></div><div class="post-nav"><div class="post-nav-item"><a href="/archives/18.html" rel="prev" title="cmpxchg kernel-api学习"><i class="fa fa-chevron-left"></i> cmpxchg kernel-api学习</a></div><div class="post-nav-item"><a href="/archives/20.html" rel="next" title="x86下系统调用">x86下系统调用 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#linux-assembly%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0"><span class="nav-number">1.</span> <span class="nav-text">linux-assembly入门学习</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E7%9A%84"><span class="nav-number">1.1.</span> <span class="nav-text">学习目的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B1%87%E7%BC%96%E7%89%B9%E7%82%B9"><span class="nav-number">1.2.</span> <span class="nav-text">汇编特点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B1%87%E7%BC%96%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.3.</span> <span class="nav-text">汇编介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B1%87%E7%BC%96%E8%AF%AD%E6%B3%95"><span class="nav-number">1.3.1.</span> <span class="nav-text">汇编语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B1%87%E7%BC%96%E5%B7%A5%E5%85%B7"><span class="nav-number">1.3.2.</span> <span class="nav-text">汇编工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B1%87%E7%BC%96%E5%99%A8"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">汇编器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%93%BE%E6%8E%A5%E5%99%A8"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">链接器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E5%99%A8"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">调试器</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B1%87%E7%BC%96%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.4.</span> <span class="nav-text">汇编实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%E5%89%8D%E6%8F%90-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E7%9A%84%E7%90%86%E8%A7%A3"><span class="nav-number">1.4.1.</span> <span class="nav-text">实践前提-系统调用的理解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hello-world"><span class="nav-number">1.4.2.</span> <span class="nav-text">hello-world</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0"><span class="nav-number">1.4.3.</span> <span class="nav-text">解析命令行参数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#32%E4%BD%8D%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">32位汇编代码</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%AD%A3%E7%A1%AE%E7%9A%84%E7%BC%96%E8%AF%91%E6%96%B9%E5%BC%8F"><span class="nav-number">1.4.3.1.1.</span> <span class="nav-text">正确的编译方式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.4.3.1.2.</span> <span class="nav-text">错误实践</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#64%E4%BD%8D%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">64位汇编代码</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E8%81%94%E6%B1%87%E7%BC%96"><span class="nav-number">1.5.</span> <span class="nav-text">内联汇编</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5-copy"><span class="nav-number">1.5.1.</span> <span class="nav-text">实践-copy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5-cmpxchgl"><span class="nav-number">1.5.2.</span> <span class="nav-text">实践-cmpxchgl</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">1.6.</span> <span class="nav-text">参考</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">Sholck</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">20</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">6</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">61</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/xiaer1921" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiaer1921" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:xiaer1921@aliyun.com" title="E-Mail → mailto:xiaer1921@aliyun.com" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/sholck222" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;sholck222" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa-fw"></i>CSDN</a></span></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://hackret.com/" title="https:&#x2F;&#x2F;hackret.com&#x2F;" rel="noopener external nofollow noreferrer" target="_blank">RedHat Kairui</a></li><li class="links-of-blogroll-item"><a href="https://linux-kernel-labs.github.io/refs/heads/master/index.html#" title="https:&#x2F;&#x2F;linux-kernel-labs.github.io&#x2F;refs&#x2F;heads&#x2F;master&#x2F;index.html#" rel="noopener external nofollow noreferrer" target="_blank">Linux Kernel Teaching</a></li><li class="links-of-blogroll-item"><a href="https://tding.top/" title="https:&#x2F;&#x2F;tding.top&#x2F;" rel="noopener external nofollow noreferrer" target="_blank">小丁</a></li><li class="links-of-blogroll-item"><a href="https://xiaozhou.net/" title="https:&#x2F;&#x2F;xiaozhou.net&#x2F;" rel="noopener external nofollow noreferrer" target="_blank">iTimpthy</a></li><li class="links-of-blogroll-item"><a href="https://consen.github.io/" title="https:&#x2F;&#x2F;consen.github.io&#x2F;" rel="noopener external nofollow noreferrer" target="_blank">Consen</a></li></ul></div><div><canvas id="canvas" style="width:60%">当前浏览器不支持canvas，请更换浏览器后再试</canvas></div><script>!function(){var o,a,r,f,t,i=[[[0,0,1,1,1,0,0],[0,1,1,0,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,0,1,1,0],[0,0,1,1,1,0,0]],[[0,0,0,1,1,0,0],[0,1,1,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[1,1,1,1,1,1,1]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,1,1,0,0,0],[0,1,1,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,0,0,1,1],[1,1,1,1,1,1,1]],[[1,1,1,1,1,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,1,1,0],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,0,0,0,1,1,0],[0,0,0,1,1,1,0],[0,0,1,1,1,1,0],[0,1,1,0,1,1,0],[1,1,0,0,1,1,0],[1,1,1,1,1,1,1],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,1,1,1,1]],[[1,1,1,1,1,1,1],[1,1,0,0,0,0,0],[1,1,0,0,0,0,0],[1,1,1,1,1,1,0],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,0,0,0,1,1,0],[0,0,1,1,0,0,0],[0,1,1,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[1,1,1,1,1,1,1],[1,1,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,1,1,0,0,0,0]],[[0,0,0,0,0,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,0,0,0]]],e=document.getElementById("canvas");function h(t,e){for(var n=[1,2,3],l=["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"],o=0;o<i[e].length;o++)for(var a,h=0;h<i[e][o].length;h++){1==i[e][o][h]&&(a={x:14*(f+2)*t+2*h*(f+1)+(f+1),y:2*o*(f+1)+(f+1),stepX:Math.floor(4*Math.random()-2),stepY:-2*n[Math.floor(Math.random()*n.length)],color:l[Math.floor(Math.random()*l.length)],disY:1},r.push(a))}}function n(){e.height=100;for(var t=0;t<a.length;t++)!function(t,e){for(var n=0;n<i[e].length;n++)for(var l=0;l<i[e][n].length;l++)1==i[e][n][l]&&(o.beginPath(),o.arc(14*(f+2)*t+2*l*(f+1)+(f+1),2*n*(f+1)+(f+1),f,0,2*Math.PI),o.closePath(),o.fill())}(t,a[t]);for(t=0;t<r.length;t++)o.beginPath(),o.arc(r[t].x,r[t].y,f,0,2*Math.PI),o.fillStyle=r[t].color,o.closePath(),o.fill()}e.getContext&&(o=e.getContext("2d"),e.height=100,e.width=700,o.fillStyle="#f00",o.fillRect(10,10,50,50),a=[],r=[],f=e.height/20-1,t=/(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date),a.push(t[1],t[2],10,t[3],t[4],10,t[5],t[6]),clearInterval(void 0),setInterval(function(){!function(){var t=[],e=/(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date),n=[];n.push(e[1],e[2],10,e[3],e[4],10,e[5],e[6]);for(var l=a.length-1;0<=l;l--)n[l]!==a[l]&&t.push(l+"_"+(Number(a[l])+1)%10);for(l=0;l<t.length;l++)h.apply(this,t[l].split("_"));a=n.concat()}(),function(){for(var t=0;t<r.length;t++)r[t].stepY+=r[t].disY,r[t].x+=r[t].stepX,r[t].y+=r[t].stepY,(r[t].x>700+f||r[t].y>100+f)&&(r.splice(t,1),t--)}(),n()},50))}()</script><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-history fa-" aria-hidden="true"></i> 近期文章</div><ul class="links-of-blogroll-list"><li><a href="/archives/20.html" title="x86下系统调用" target="_blank">x86下系统调用</a></li><li><a href="/archives/19.html" title="linux-assembly入门学习" target="_blank">linux-assembly入门学习</a></li><li><a href="/archives/18.html" title="cmpxchg kernel-api学习" target="_blank">cmpxchg kernel-api学习</a></li><li><a href="/archives/17.html" title="linux模块初始化分析" target="_blank">linux模块初始化分析</a></li><li><a href="/archives/16.html" title="Kbuild-Makefile学习" target="_blank">Kbuild-Makefile学习</a></li></ul></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2020 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="user"></i> </span><span class="author" itemprop="copyrightHolder">Sholck</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-chart-area"></i> </span><span class="post-meta-item-text">站点总字数：</span> <span title="站点总字数">227k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">3:26</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener external nofollow noreferrer" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener external nofollow noreferrer" target="_blank">NexT.Muse</a> 强力驱动</div><script src="/lib/mermaid/mermaid.min.js"></script><script>window.mermaid&&mermaid.initialize({theme:"forest"})</script></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><script async src="/js/cursor/fireworks.js"></script><script src="/js/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,document.body.addEventListener("input",POWERMODE)</script></body></html>