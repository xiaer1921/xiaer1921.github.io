<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/sholck2.jfif"><link rel="icon" type="image/png" sizes="32x32" href="/images/sholck2.jfif"><link rel="icon" type="image/png" sizes="16x16" href="/images/sholck2.jfif"><link rel="mask-icon" href="/images/sholck2.jfif" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Noto Serif SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"sholck.top",root:"/",scheme:"Muse",version:"7.8.0",exturl:!1,sidebar:{position:"right",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="Feature2当我们想要去实现特定功能的时候，我们需要使用FGM管理实现feature功能的各类组件 并根据feature拓扑创建对应的pipeline去实现，这些组件包括FGS,FPM,线程池，TBM。本篇文章将从feature组件的创建以及各组件的功能组合如何实现特定feature来描述，而关联底层的pipeline建立和node处理，PCR逻辑已经在其他文章详细描述，本文不再重新描述。"><meta property="og:type" content="article"><meta property="og:title" content="Camx-Feature2"><meta property="og:url" content="http://sholck.top/archives/8a2ade18.html"><meta property="og:site_name" content="Sholck"><meta property="og:description" content="Feature2当我们想要去实现特定功能的时候，我们需要使用FGM管理实现feature功能的各类组件 并根据feature拓扑创建对应的pipeline去实现，这些组件包括FGS,FPM,线程池，TBM。本篇文章将从feature组件的创建以及各组件的功能组合如何实现特定feature来描述，而关联底层的pipeline建立和node处理，PCR逻辑已经在其他文章详细描述，本文不再重新描述。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://sholck.top/images/feature2/feature2-frame.png"><meta property="og:image" content="http://sholck.top/images/feature2/feature2-initialize.png"><meta property="og:image" content="http://sholck.top/images/feature2/feature2-configure-finalize.png"><meta property="article:published_time" content="2021-03-23T17:03:00.000Z"><meta property="article:modified_time" content="2021-04-15T07:47:35.362Z"><meta property="article:author" content="Sholck"><meta property="article:tag" content="Camera-Camx"><meta property="article:tag" content="Feature2"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://sholck.top/images/feature2/feature2-frame.png"><link rel="canonical" href="http://sholck.top/archives/8a2ade18.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>Camx-Feature2 | Sholck</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="Sholck" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">Sholck</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">不积跬步,无以至千里.不积小流,无以成江海</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">13</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">3</span></a></li><li class="menu-item menu-item-project"><a href="/project/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>项目</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://sholck.top/archives/8a2ade18.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="Sholck"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Sholck"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Camx-Feature2</h1><div class="post-meta"><i class="fa fa-thumb-tack"></i> <font color="7D26CD">置顶</font> <span class="post-meta-divider">|</span> <span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-03-24 01:03:00" itemprop="dateCreated datePublished" datetime="2021-03-24T01:03:00+08:00">2021-03-24</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-04-15 15:47:35" itemprop="dateModified" datetime="2021-04-15T15:47:35+08:00">2021-04-15</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Camera-Driver/" itemprop="url" rel="index"><span itemprop="name">Camera-Driver</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>21k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>19 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="Feature2"><a href="#Feature2" class="headerlink" title="Feature2"></a>Feature2</h1><p>当我们想要去实现特定功能的时候，我们需要使用FGM管理实现feature功能的各类组件 并根据feature拓扑创建对应的pipeline去实现，这些组件包括FGS,FPM,线程池，TBM。本篇文章将从feature组件的创建以及各组件的功能组合如何实现特定feature来描述，而关联<a href="https://sholck.top/archives/8a2ade15.html">底层的pipeline建立和node处理</a>，<a href="https://sholck.top/archives/8a2ade14.html">PCR逻辑</a>已经在其他文章详细描述，本文不再重新描述。</p><p><a id="0"></a></p><ul><li><a href="#1">feature2框架介绍</a></li><li><a href="#2">configure_stream</a></li><li><a href="#3">feature instance连接</a></li><li><a href="#4">feature-PCR</a></li><li><a href="#5">TBM详解</a></li><li><a href="#6">TM详解</a></li></ul><p><a id="1"></a></p><h2 id="feature2框架介绍"><a href="#feature2框架介绍" class="headerlink" title="feature2框架介绍"></a>feature2框架介绍</h2><p>下图feature2大致的组件框架。</p><p><img src="/images/feature2/feature2-frame.png" alt="alt"></p><a id="more"></a><p><a id="2"></a></p><h2 id="configure-stream"><a href="#configure-stream" class="headerlink" title="configure_stream"></a>configure_stream</h2><p>在configure_stream阶段，主要为</p><ol><li>Feature2Wrapper的创建</li><li>Feature2GraphManager（FGM）和TargetBufferManager（TBM）的创建</li></ol><p>大致流程如下，不包括feature instance的initialize到finalized.</p><p><img src="/images/feature2/feature2-initialize.png" alt="alt"></p><h3 id="Feature2Wrapper的创建"><a href="#Feature2Wrapper的创建" class="headerlink" title="Feature2Wrapper的创建"></a>Feature2Wrapper的创建</h3><ol><li>针对部分usecase,根据下发的opMode，选择对应的feature场景，比如快拍支持</li></ol><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="function"><span class="params">(StreamConfigModeFastShutter == ExtensionModule::GetInstance()-&gt;GetOpMode(m_cameraId))</span></span></span><br><span class="line"><span class="function">&#123;    </span></span><br><span class="line"><span class="function">    <span class="title">enabledAdvanceFeatures</span> = <span class="title">AdvanceFeatureSWMF</span>|<span class="title">AdvanceFeatureMFNR</span>|<span class="title">AdvanceFeatureAIDE</span>;</span></span><br><span class="line"><span class="function">&#125;    </span></span><br><span class="line"><span class="function"></span></span><br></pre></td></tr></table></figure><p>log如下</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">chxadvancedcamerausecase</span><span class="selector-class">.cpp</span><span class="selector-pseudo">:6513</span> <span class="selector-tag">SelectFeatures</span>() <span class="selector-tag">SelectFeatures</span>(), <span class="selector-tag">enabled</span> <span class="selector-tag">feature</span> <span class="selector-tag">mask</span><span class="selector-pseudo">:40</span></span><br><span class="line"><span class="selector-tag">chxadvancedcamerausecase</span><span class="selector-class">.cpp</span><span class="selector-pseudo">:6585</span> <span class="selector-tag">SelectFeatures</span>() <span class="selector-tag">num</span> <span class="selector-tag">features</span> <span class="selector-tag">selected</span><span class="selector-pseudo">:1</span>, <span class="selector-tag">FeatureType</span> <span class="selector-tag">for</span> <span class="selector-tag">preview</span><span class="selector-pseudo">:7</span></span><br></pre></td></tr></table></figure><ol start="2"><li>针对单双摄设置Fk stream,双摄额外设置主辅摄的internalInputStream，包括RDI和FD，这两个stream已经在mc usecase申请资源CreateMultiCameraResource中空间申请并填充。</li><li>Feature2Wrapper初始化<br>a. m_internalInputStreamMap 映射usecase内部的output stream到feature内部external stream,比如双摄的RDI stream<br>b. m_pFrameworkStreams 管理fk stream</li></ol><h3 id="FGM和TBM的创建"><a href="#FGM和TBM的创建" class="headerlink" title="FGM和TBM的创建"></a>FGM和TBM的创建</h3><ul><li><a href="#0">返回主目录</a></li></ul><h4 id="FGM创建"><a href="#FGM创建" class="headerlink" title="FGM创建"></a>FGM创建</h4><ol><li>设置该feature2wrapper的cb，用来处理PCR的处理</li><li>feature 的input stream指针空间单独copy，CloneStreamConfig申请空间过大，需check 并告知qcom</li><li>设置该FGMd的cb，处理chi的notify和feature的message</li><li>依次创建FGS，FPM，线程管理</li><li>pGetFGDListForConfig对FGS拿到的FGD和FPM从all feature instance中hook中拿到的cap中match和过滤</li><li>CreateVirtualSuperGraph对single feature graph进行过滤并整合为VirtualSuperGraph，同时确定包含的feature instance</li><li>对feature instance进行create,configure,Finalized</li></ol><h5 id="FGS创建"><a href="#FGS创建" class="headerlink" title="FGS创建"></a>FGS创建</h5><ol><li><p>通过LoadFeatureGraphSelectorOps和FGS库挂hook，hook为ChiFeature2GraphSelectorOpsEntry<br>，回调对象指针为m_feature2GraphSelectorOps。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">chifeature2graphmanager</span>.cpp:<span class="number">345</span> LoadFeatureGraphSelectorOps() No graph selector library files found in the path /vendor/lib<span class="number">64</span>/camera/components/feature<span class="number">2</span>/oem</span><br><span class="line"><span class="attribute">chifeature2graphmanager</span>.cpp:<span class="number">365</span> LoadFeatureGraphSelectorOps() Loading from:/vendor/lib<span class="number">64</span>/com.qti.feature<span class="number">2</span>.gs.mannar.so, size:<span class="number">72</span>, pCreateOps:<span class="number">0</span>x<span class="number">736644</span>f<span class="number">658</span>K</span><br></pre></td></tr></table></figure></li><li><p>通过pCreate进行FGS的create</p></li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a. BuildCameraIdSet根据全部逻辑id的类型分类，由m_cameraIdMap管理  cameraID<span class="comment">-----type</span></span><br><span class="line"></span><br><span class="line">b. 设置FGD Table的描述GraphDescriptorTables ，主要为三部分构成。 </span><br><span class="line">pCameraIdDescriptorNameSet  camera <span class="keyword">set</span> <span class="keyword">type</span>对应的一个FGDescriptorName集合</span><br><span class="line">pFeatureGraphDescriptorsMap  FGD <span class="keyword">name</span>到FDG 的映射</span><br><span class="line">pFeatureGraphDescKeysMap  包含camera <span class="keyword">set</span> <span class="keyword">type</span>和FDGnam等，用来表示该平台支持的feature <span class="keyword">instance</span>。</span><br><span class="line"></span><br><span class="line">c. rFeatureDescNameSet featureDescName集合的设置，根据<span class="keyword">memory</span>分别设置。  </span><br><span class="line">这三部分都是由两部分组成，OEM赋值和PopulateAllTables插入</span><br></pre></td></tr></table></figure><ol start="3"><li>FGS的initialze 通过AssignStreamIntentPerFwkStream针对FGS的输出流进行stream intent判定。enum ChiStreamIntent</li></ol><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">chifeature2graphselector</span>.cpp:<span class="number">8565</span> AssignStreamIntentPerFwkStream() Feature<span class="number">2</span>Mapping: Stream Intent CHI_STREAM_INTENT_PREVIEW for <span class="number">0</span>xb<span class="number">400007402</span>c<span class="number">56488</span> format: <span class="number">0</span>x<span class="number">22</span> width: <span class="number">1440</span> height: <span class="number">1080</span> usage: <span class="number">0</span>x<span class="number">900</span></span><br><span class="line"><span class="attribute">chifeature2graphselector</span>.cpp:<span class="number">8565</span> AssignStreamIntentPerFwkStream() Feature<span class="number">2</span>Mapping: Stream Intent CHI_STREAM_INTENT_STILL_CAPTURE for <span class="number">0</span>xb<span class="number">400007402</span>c<span class="number">81</span>c<span class="number">48</span> format: <span class="number">0</span>x<span class="number">21</span> width: <span class="number">4160</span> height: <span class="number">3120</span> usage: <span class="number">0</span>x<span class="number">3</span></span><br></pre></td></tr></table></figure><h5 id="FPM创建-参数传入FGS设置的m-featureDescNameSet"><a href="#FPM创建-参数传入FGS设置的m-featureDescNameSet" class="headerlink" title="FPM创建 参数传入FGS设置的m_featureDescNameSet"></a>FPM创建 参数传入FGS设置的m_featureDescNameSet</h5><ol><li>ProbeChiFeature2Features获取所有feature instance的hook,hook为ChiFeature2OpsEntry，打印并将每一个feature的cap和m_featureDescNameSet进行匹配，那么匹配成功的代表运行功能支持。同时将这个cap和所对应的feature instance 的回调指针ops插入到m_featureVersionToOpsMap.<br>下面是sm4350feature instance支持的cap</li></ol><table><thead><tr><th>anchorsync</th><th>demux</th><th>derivedoffline</th><th>frameselect</th><th>fusion</th><th>mcreprocrt</th></tr></thead><tbody><tr><td>AnchorSync</td><td>Demux</td><td>Yuv2Yuv</td><td>FrameSelect</td><td>FUSION</td><td>MultiCameraReprocessRealtime</td></tr></tbody></table><table><thead><tr><th>realtimeserializer</th><th>rtmcx</th><th>serializer</th><th>statsregeneration</th><th>rawhdr</th></tr></thead><tbody><tr><td>RealTimeSerializer</td><td>RealTimeMCX</td><td>Serializer</td><td>StatsRegeneratio</td><td>RawHDR</td></tr></tbody></table><table><thead><tr><th>fusion</th><th>mfsr</th></tr></thead><tbody><tr><td>FUSION</td><td>MFSR</td></tr><tr><td>BOKEH</td><td>MFNR</td></tr></tbody></table><table><thead><tr><th>hdr</th><th>rt</th></tr></thead><tbody><tr><td>HDR</td><td>RealTime</td></tr><tr><td>ThreeFrameMFHDR</td><td>RealTimeNZSL</td></tr><tr><td>TwoFrameMFHDR</td><td>RealTimeWithSWRemosaic</td></tr></tbody></table><p>下面是 generic 的Cap:</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Bayer2Yuv</span> JPEG  FormatConvertor YUVReprocess  RealtimePostProcessor Yuv<span class="number">2</span>Yuv  SWRemosaic  Y<span class="number">2</span>YRTDiffDimen Y<span class="number">2</span>YMultiPreview  PostFusionIPE </span><br></pre></td></tr></table></figure><p>对feature具体的描述在<br>chi-cdk/oem/qcom/feature2/chifeature2graphselector/descriptors/generated/features</p><h5 id="TM（CHIThreadManage）创建"><a href="#TM（CHIThreadManage）创建" class="headerlink" title="TM（CHIThreadManage）创建"></a>TM（CHIThreadManage）创建</h5><p>通过StartThreads对线程池管理的16个线程进行触发设置，触发WorkerThreadBody</p><h5 id="FGD匹配"><a href="#FGD匹配" class="headerlink" title="FGD匹配"></a>FGD匹配</h5><p>pGetFGDListForConfig通过m_featureVersionToOpsMap和FGD Table去进行整合。匹配规则如下</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. 该camera逻辑id必须在m_cameraIdMap存在，且cameraType和pCameraIdDescriptorNameSet中一致,这样可以确定到一个FGD <span class="keyword">name</span> set集合，都是该cameraType对应的</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> ((std::find(rCameraIdSet.begin(), rCameraIdSet.end(), cameraId) == rCameraIdSet.end()) || (rPair.first != cameraType))</span><br><span class="line">              &#123;    </span><br><span class="line">                  continue;</span><br><span class="line">              &#125;</span><br><span class="line">              </span><br><span class="line"><span class="number">2</span>. 对FGDname set进行遍历，确定对应的FGD</span><br><span class="line">                  const ChiFeature2GraphDesc&amp; rFeatureGraphDesc =</span><br><span class="line">                      <span class="function"><span class="title">pGraphDescriptorTables</span>-&gt;</span><span class="function"><span class="title">pFeatureGraphDescriptorsMap</span>-&gt;</span><span class="built_in">at</span>(pDescriptorName); </span><br><span class="line">                </span><br><span class="line"><span class="number">3</span>. 针对单双摄FGD 对过滤，规则为IsSkipFeatureGraph，对FGD下的所有feature instance检查，匹配cap,cap所属的Ops,FGD下有多个instance的比如：MultiCameraFusionFeatureGraphFeatureInstanceDescs</span><br><span class="line">    a.低内存设备不走cds graph.</span><br><span class="line">    b.ChiFeature2Type判断，设置在feature instance中，比如SWMFFeatureDescriptor和SWMFAIDenoiserInstanceProps的组成在部分平台不支持</span><br><span class="line">    c.feature2掩码进行过滤的，比如IsSWMFEnabled()和IsAIDEEnabled()</span><br><span class="line">    d.每一个feature instance <span class="keyword">name</span>去和我们从feature动态库中拿到的去匹配</span><br><span class="line">    e.非rawinput的，不处理Bayer2YUVJPEG和Bayer2YUV这两个graph</span><br><span class="line">    </span><br><span class="line">下面是普通预览不开MFNR的过滤</span><br><span class="line">IsSkipFeatureGraph() Skip Raw reprocess graph: Bayer2YUV</span><br><span class="line">GetAllFeatureGraphDescriptors() Removing feature graph Bayer2YUV</span><br><span class="line">GetAllFeatureGraphDescriptors() Removing feature graph RTBayer2YUVSWMFJPEG</span><br><span class="line">IsSkipFeatureGraph() Skip Raw reprocess graph: Bayer2YUVJPEG</span><br><span class="line">GetAllFeatureGraphDescriptors() Removing feature graph Bayer2YUVJPEG</span><br><span class="line">GetAllFeatureGraphDescriptors() Removing feature graph RTBayer2YUVSWMFAIDenoiserJPEG</span><br><span class="line">GetAllFeatureGraphDescriptors() Removing feature graph RTBayer2YUVSWMF</span><br><span class="line">GetAllFeatureGraphDescriptors() Removing feature graph RTBayer2YUVSWMFAIDenoiser</span><br><span class="line"></span><br><span class="line">用到的single garph有</span><br><span class="line">I<span class="function"><span class="title">nsert</span> single graph:cameraID 0-&gt;</span>R<span class="function"><span class="title">ealtimeFG</span>-&gt;</span><span class="number">0</span></span><br><span class="line">I<span class="function"><span class="title">nsert</span> single graph:cameraID 0-&gt;</span>RTM<span class="function"><span class="title">emcpyYUV</span>-&gt;</span><span class="number">0</span></span><br><span class="line">I<span class="function"><span class="title">nsert</span> single graph:cameraID 0-&gt;</span>RTB<span class="function"><span class="title">ayer2YUVHDRT1JPEG</span>-&gt;</span><span class="number">0</span></span><br><span class="line">I<span class="function"><span class="title">nsert</span> single graph:cameraID 0-&gt;</span>RTB<span class="function"><span class="title">ayer2YUVJPEG</span>-&gt;</span><span class="number">0</span></span><br><span class="line">I<span class="function"><span class="title">nsert</span> single graph:cameraID 0-&gt;</span>RTB<span class="function"><span class="title">ayer2YUV</span>-&gt;</span><span class="number">0</span></span><br><span class="line">I<span class="function"><span class="title">nsert</span> single graph:cameraID 0-&gt;</span>RTB<span class="function"><span class="title">ayer2YUVCDSJPEG</span>-&gt;</span><span class="number">0</span></span><br><span class="line">I<span class="function"><span class="title">nsert</span> single graph:cameraID 0-&gt;</span>RTR<span class="function"><span class="title">awHDRBayer2YUVJPEGOEM</span>-&gt;</span><span class="number">0</span></span><br><span class="line">I<span class="function"><span class="title">nsert</span> single graph:cameraID 0-&gt;</span>RTR<span class="function"><span class="title">awHDRBayer2YUVOEM</span>-&gt;</span><span class="number">0</span></span><br><span class="line">I<span class="function"><span class="title">nsert</span> single graph:cameraID 0-&gt;</span>RTB<span class="function"><span class="title">ayer2YUVCDS</span>-&gt;</span><span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="number">4</span>. CallCloneGraphDescriptor对匹配成功的graph进行clone并插入到m_clonedFeatureGraphDescriptorsMap和push到m_pFeature2GraphDescs vector中</span><br><span class="line"><span class="number">5</span>. UpdateInstancePropsForGraph 对该graph下的所有feature instance ， ExtSrcLinks, ExtSinkLinks,InternalLinks进行instanceProps设置，默认设置为该逻辑id下的物理id.</span><br><span class="line">针对有input stream为yuv或者预览格式的，且输出为YUV的，增加YUVReprocessFeatureGraphDescriptor，如果输出为JPEG的，增加YUVJPEGReprocessFeatureGraphDescriptor。</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Feature-Instance整合"><a href="#Feature-Instance整合" class="headerlink" title="Feature Instance整合"></a>Feature Instance整合</h5><p>该整合为所匹配到的graph下的所有fature instance, extSrcLinks，extSinkLinks,internalLinks的整合</p><ol><li>CreateVirtualSuperGraph创建，通过MergeFeatureGraphs进行整合，单摄命名为VirtualSuperGraph，双摄命名为MultiCameraVirtualSuperGraph，整合规则即feature instance和links的合并，见feature instance connect小节理解<br>整合完毕的feature instance打印如下：</li></ol><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">CreateFeatureInstances</span>() <span class="selector-pseudo">:VirtualSuperGraph</span>, <span class="selector-tag">numFeatureInstances</span><span class="selector-pseudo">:7</span>, <span class="selector-tag">logicalCameraId</span><span class="selector-pseudo">:0</span></span><br></pre></td></tr></table></figure><p>到目前为止，我们已经拿到了全部我们需要的feature instance，links规则,之后通过FPM去管理。</p><h5 id="feature-instance-create–-gt-Finalized"><a href="#feature-instance-create–-gt-Finalized" class="headerlink" title="feature instance create–&gt;Finalized"></a>feature instance create–&gt;Finalized</h5><ul><li><a href="#0">返回主目录</a><br>下面是一份详细的流程处理</li></ul><p><img src="/images/feature2/feature2-configure-finalize.png" alt="alt"></p><h5 id="feature-instace-create"><a href="#feature-instace-create" class="headerlink" title="feature instace create"></a>feature instace create</h5><p>这部分主要由CreateFeatureInstances去实现<br>遍历virtualGraph的成员feature instance,下面以RealTime去描述</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> DoStreamNegotiation 将feature instance name去和m_featureVersionToOpsMap(包含instance对应的hook Ops)match,然后进行stramNegotiation.</span><br><span class="line"></span><br><span class="line">chifeature2featurepool.cpp:<span class="number">217</span> DoStreamNegotiation() feature:RealTime, pStreamNegotiation:<span class="number">0x736685b998</span>K</span><br><span class="line"></span><br><span class="line">假如为ZSL snapshot negotiation,</span><br><span class="line">    a. clone RDI stream，这个RDI stream定义在chifeature2utils.h，</span><br><span class="line">    b. 通过GetSensorOutputDimension去获取RDI stream的witdh,high,bpp，方便设置格式,默认bpp为<span class="number">10</span>,那么格式为RAW10</span><br><span class="line">    c. MapStreamPerFeature对feature input stream(fk stream/RDI+FD)进行流类型判定，并添加对应的ChiFeature2Type映射。</span><br><span class="line">    </span><br><span class="line"> chifeature2utils.cpp:<span class="number">339</span> MapStreamPerFeature() Enter :numStreams:<span class="number">2</span>                                                                                       </span><br><span class="line"> chifeature2utils.cpp:<span class="number">351</span> MapStreamPerFeature() Classify: <span class="number">0xb400007402c56488</span> format: <span class="number">34</span> width: <span class="number">1440</span> height: <span class="number">1080</span> gralloc:<span class="number">0x900</span></span><br><span class="line"> chifeature2utils.cpp:<span class="number">357</span> MapStreamPerFeature() Identified Preview</span><br><span class="line"> chifeature2utils.cpp:<span class="number">351</span> MapStreamPerFeature() Classify: <span class="number">0xb400007402c81c48</span> format: <span class="number">33</span> width: <span class="number">4160</span> height: <span class="number">3120</span> gralloc:<span class="number">0x3</span></span><br><span class="line"> chifeature2utils.cpp:<span class="number">417</span> MapStreamPerFeature() Identified JPEG</span><br><span class="line"> chifeature2utils.cpp:<span class="number">457</span> MapStreamPerFeature() Map Streams Scan:</span><br><span class="line"> chifeature2utils.cpp:<span class="number">458</span> MapStreamPerFeature()     numPreview: <span class="number">1</span></span><br><span class="line"> chifeature2utils.cpp:<span class="number">459</span> MapStreamPerFeature()     numVideo: <span class="number">0</span></span><br><span class="line"> chifeature2utils.cpp:<span class="number">460</span> MapStreamPerFeature()     numAllYUV: <span class="number">0</span></span><br><span class="line"> chifeature2utils.cpp:<span class="number">461</span> MapStreamPerFeature()     num4kYUV: <span class="number">0</span></span><br><span class="line"> chifeature2utils.cpp:<span class="number">462</span> MapStreamPerFeature()     numJPEG: <span class="number">1</span></span><br><span class="line"> chifeature2utils.cpp:<span class="number">463</span> MapStreamPerFeature()     numRAW: <span class="number">0</span></span><br><span class="line"> chifeature2utils.cpp:<span class="number">464</span> MapStreamPerFeature()     numZSL: <span class="number">0</span></span><br><span class="line"> chifeature2utils.cpp:<span class="number">465</span> MapStreamPerFeature()     ThumbnailYUV: <span class="number">0</span></span><br><span class="line"> chifeature2utils.cpp:<span class="number">466</span> MapStreamPerFeature()     numB2YOut: <span class="number">1</span></span><br><span class="line"> chifeature2utils.cpp:<span class="number">603</span> MapStreamPerFeature() Final classification: Stream:<span class="number">0xb400007402c56488</span> feature:<span class="number">0</span> format: <span class="number">34</span> width: <span class="number">1440</span> height: <span class="number">1080</span> gralloc: <span class="number">0x900</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>通过对流类型判断，根据streamIntent去clone对应类型的stream,如果没有该streamIntent(CHI_STREAM_INTENT_POSTVIEW)的stream，那么按照chifeature2utils.h设置的PostViewStreamsOutput来clone.</span><br><span class="line"></span><br><span class="line">DoStreamNegotiation() <span class="number">0</span></span><br><span class="line">DoStreamNegotiation() Accepting_Streams_REALTIME Stream Stream:<span class="number">0xb400007402c56488</span> Format: <span class="number">34</span> width: <span class="number">1440</span> height: <span class="number">1080</span> gralloc: <span class="number">0x900</span></span><br><span class="line">DoStreamNegotiation() <span class="number">1</span></span><br><span class="line">DoStreamNegotiation() Rejecting_Streams_REALTIME Stream Stream:<span class="number">0xb400007402c81c48</span> Format: <span class="number">33</span> width: <span class="number">4160</span> height: <span class="number">3120</span> gralloc: <span class="number">0x3</span></span><br><span class="line">DoStreamNegotiation() Cloning Video Stream</span><br><span class="line">DoStreamNegotiation() numStream:<span class="number">6</span>    &lt;&lt;可见协商该feature instance 的<span class="keyword">out</span> stream为<span class="number">6</span>条</span><br><span class="line"></span><br><span class="line">这<span class="number">6</span>条应该是preview,postview,RDI,IdeaRaw,video,yuv(部分平台为fd),之后可以通过ClassifyStream 函数log中的streamIntent来判断</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 通过UpdateInstancePropsInGraphDesc更新feature instance和links(针对多摄feature instance ).</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>创建feature instance</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">DoFeatureCreate最终调用ChiFeature2Base::Initialize进行feature instance父类的初始化</span><br><span class="line"></span><br><span class="line">a.注册线程ProcessAsyncFeatureJobs。</span><br><span class="line"></span><br><span class="line">chithreadmanager.cpp:<span class="number">178</span> RegisterJobFamily() Async Job Registered isSync: <span class="number">1</span>, m_numThreads: <span class="number">16</span></span><br><span class="line">chithreadmanager.cpp:<span class="number">187</span> RegisterJobFamily() Registered Fn. Async_RealTime_Create (<span class="number">0x736b27f618</span>) RegJobHandle <span class="number">4294967296</span>, NumOfRegisteredJob <span class="number">1</span></span><br><span class="line"></span><br><span class="line">b. ClassifyStream 根据流的streamType，决定push到pInputStreams还是pOutputStreams</span><br><span class="line">chifeature2base.cpp:<span class="number">4664</span> ClassifyStream() Name = RealTime: Res: <span class="number">1440</span> X <span class="number">1080</span> Format = <span class="number">0x22</span> Usage = <span class="number">0x900</span> Type = <span class="number">0</span> STREAM = <span class="number">0xb400007402c56488</span> (<span class="built_in">int</span>ent =<span class="number">1</span> bpp = <span class="number">0</span>) PhyCamId = </span><br><span class="line">chifeature2base.cpp:<span class="number">4664</span> ClassifyStream() Name = RealTime: Res: <span class="number">320</span> X <span class="number">240</span> Format = <span class="number">0x23</span> Usage = <span class="number">0x0</span> Type = <span class="number">0</span> STREAM = <span class="number">0xb4000073e2c95710</span> (<span class="built_in">int</span>ent = <span class="number">6</span> bpp = <span class="number">0</span>) PhyCamId = (<span class="literal">null</span>)</span><br><span class="line">chifeature2base.cpp:<span class="number">4664</span> ClassifyStream() Name = RealTime: Res: <span class="number">4208</span> X <span class="number">3120</span> Format = <span class="number">0x25</span> Usage = <span class="number">0x20002</span> Type = <span class="number">0</span> STREAM = <span class="number">0xb4000073e2c96580</span> (<span class="built_in">int</span>ent = <span class="number">8</span> bpp = <span class="number">10</span>) PhyCamId = (<span class="literal">null</span>)</span><br><span class="line">chifeature2base.cpp:<span class="number">4664</span> ClassifyStream() Name = RealTime: Res: <span class="number">4096</span> X <span class="number">3072</span> Format = <span class="number">0x20</span> Usage = <span class="number">0x20002</span> Type = <span class="number">0</span> STREAM = <span class="number">0xb4000073e2c95780</span> (<span class="built_in">int</span>ent = <span class="number">2</span> bpp = <span class="number">0</span>) PhyCamId = (<span class="literal">null</span>)</span><br><span class="line">chifeature2base.cpp:<span class="number">4664</span> ClassifyStream() Name = RealTime: Res: <span class="number">1440</span> X <span class="number">1080</span> Format = <span class="number">0x23</span> Usage = <span class="number">0x0</span> Type = <span class="number">0</span> STREAM = <span class="number">0xb4000073e2c95630</span> (<span class="built_in">int</span>ent = <span class="number">3</span> bpp = <span class="number">0</span>) PhyCamId = (<span class="literal">null</span>)</span><br><span class="line">chifeature2base.cpp:<span class="number">4664</span> ClassifyStream() Name = RealTime: Res: <span class="number">640</span> X <span class="number">480</span> Format = <span class="number">0x23</span> Usage = <span class="number">0x0</span> Type = <span class="number">0</span> STREAM = <span class="number">0xb4000073e2c97700</span> (<span class="built_in">int</span>ent = <span class="number">7</span> bpp = <span class="number">0</span>) PhyCamId = (<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">c.设置最大的m_maxFeatureExecutionTime,判断是否超时处理。</span><br><span class="line"></span><br><span class="line">d.创建的全部feature instance如下</span><br><span class="line">CreateFeatureInstances() RealTime(<span class="number">0xb400007472ce27f0</span>) &#123;featureId, instanceId, cameraId, flags&#125;: &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;</span><br><span class="line">CreateFeatureInstances() RawHDR(<span class="number">0xb400007472c52f10</span>) &#123;featureId, instanceId, cameraId, flags&#125;: &#123;<span class="number">10</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;</span><br><span class="line">CreateFeatureInstances() Bayer2Yuv(<span class="number">0xb400007472c83f70</span>) &#123;featureId, instanceId, cameraId, flags&#125;: &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125; </span><br><span class="line">CreateFeatureInstances() Bayer2Yuv(<span class="number">0xb400007472cd5050</span>) &#123;featureId, instanceId, cameraId, flags&#125;: &#123;<span class="number">1</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">16384</span>&#125;</span><br><span class="line">CreateFeatureInstances() HDR(<span class="number">0xb400007472c96530</span>) &#123;featureId, instanceId, cameraId, flags&#125;: &#123;<span class="number">6</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125; </span><br><span class="line">CreateFeatureInstances() JPEG(<span class="number">0xb400007472c8acd0</span>) &#123;featureId, instanceId, cameraId, flags&#125;: &#123;<span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;</span><br><span class="line">CreateFeatureInstances() Yuv2Yuv(<span class="number">0xb400007472cb5c50</span>) &#123;featureId, instanceId, cameraId, flags&#125;: &#123;<span class="number">33</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line">总共<span class="number">7</span>个instance，对应</span><br><span class="line">CreateFeatureInstances() :VirtualSuperGraph, numFeatureInstances:<span class="number">7</span>, logicalCameraId:<span class="number">0</span></span><br></pre></td></tr></table></figure><p>CDS feature enable要求：</p><ol><li>feature instance type 为B2Y</li><li>instanceFlags.isCDSSnapshot 为1</li><li>该feature下的output流尺寸必须为4的倍数</li><li>针对QCFA，必须为instanceFlags.isCDSSnapshot &amp;&amp; instanceFlags.isNZSLSnapshot</li></ol><h5 id="feature-instance-configure-amp-finialize"><a href="#feature-instance-configure-amp-finialize" class="headerlink" title="feature instance configure&amp;finialize"></a>feature instance configure&amp;finialize</h5><p>先针对enable feature vector（有自己的排序规则）进行反向遍历处理</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> negotiationsMap对OutputPortRequirement的映射规则<span class="comment">//todo negotiationsMap未满足条件映射</span></span><br><span class="line"><span class="number">2.</span> 通过.ConfigureFeature在feature instance中去初始化pipeline. 一条pipeline是在feature 拓扑中定义的  </span><br><span class="line">    a.从feature instance中获取定义的session number和 pipeline number</span><br><span class="line">    比如我们已经知道一个feature instance的name为RealTime， 那么可以知道对应的cap也为RealTime，</span><br><span class="line">    对应的ChiFeature2Descriptor 类型ChiFeature2Descriptor 定义在feature2/chifeature2graphselector/descriptors/generated/features/g_chifeature2realtimedescriptor.cpp下</span><br><span class="line">    </span><br><span class="line">      CDK_VISIBILITY_PUBLIC extern <span class="keyword">const</span> ChiFeature2Descriptor RealTimeFeatureDescriptor =</span><br><span class="line">  &#123;                                                        </span><br><span class="line">      <span class="number">0</span>,                                                                               <span class="comment">// Feature Id</span></span><br><span class="line">      <span class="string">&quot;RealTime&quot;</span>,                                                                      <span class="comment">// Feature Name</span></span><br><span class="line">      <span class="number">1</span>,                                                                               <span class="comment">// Num Stage Descriptors</span></span><br><span class="line">      &amp;RealTime_StageDescriptors[<span class="number">0</span>],                                                   <span class="comment">// Stage Descriptors</span></span><br><span class="line">      <span class="number">1</span>,                                                                               <span class="comment">// Num Session Descriptors</span></span><br><span class="line">      &amp;RealTime_SessionDescriptors[<span class="number">0</span>],                                                 <span class="comment">// Session Descriptors</span></span><br><span class="line">      <span class="number">5</span>,                                                                               <span class="comment">// Num Internal Links</span></span><br><span class="line">      &amp;RealTime_InternalLinks[<span class="number">0</span>],                                                      <span class="comment">// Internal Link Descriptors</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">    PrepareFeatureData() Feature2Mapping: FeatureName = RealTime, numSessions = <span class="number">1</span>, numPipelines = <span class="number">14</span> numPorts = <span class="number">280</span></span><br><span class="line">    RealTime feature instance下一共有<span class="number">14</span>条pipeline中，定义在RealTime_Session0_PipelineDescs。但这个时候pipeline拓扑我们是不知道的</span><br><span class="line">    </span><br><span class="line">    下面从b到e，将根据session和pipeline desc填充pSessionData和pSessionData-&gt;pPipelineData</span><br><span class="line">    b.针对每一个session，设置对应的session回调，针对session下的每一个pipeline，feature instance 通过OnPipelineSelect判断是否支持。</span><br><span class="line">    </span><br><span class="line">    chifeature2realtime.cpp:<span class="number">2851</span> OnPipelineSelect() featureName:RealTime, pipelineName:ZSLPreviewRaw_LT1080p, instanceFlags &#123;nzsl:<span class="number">0</span>, swremosaic:<span class="number">0</span>, hwremosaic:<span class="number">0</span>, bpscam:<span class="number">0</span>, shdr <span class="number">0</span>, mfhdr <span class="number">0</span>&#125; isPipelineSupported <span class="number">1</span> Screengrab:<span class="number">0</span>, platformSocId <span class="number">454</span></span><br><span class="line">    </span><br><span class="line">    c.拿到m_pChiUsecase，并通过pipeline name确定pipelne index，方便之后CloneUsecase和PruneUsecaseDescriptor确定pipeline拓扑</span><br><span class="line">    </span><br><span class="line">    PrepareFeatureData() session: <span class="number">0</span>, name: RealTime, pipeline: <span class="number">0</span>, name: ZSLPreviewRaw_LT1080p</span><br><span class="line">    </span><br><span class="line">    d.根据pipeline中input和output的描述，在pipeline的pInputPortData和pOutputPortData分别增加对于的描述，针对InternalLinks，将sinkport的描述也增加到对应pipeline的pInputPortData描述中</span><br><span class="line">    </span><br><span class="line">    e.拿到pInternalLinkDesc中的sink port对在的pipeline data,并给pInputPortData添加对应sink port描述的pSinkPortData。</span><br><span class="line">    </span><br><span class="line">    f.通过CloneUsecase和PruneUsecaseDescriptor确定pipeline拓扑</span><br><span class="line">    </span><br><span class="line">    g.通过PopulateDisabledStatus检查pipelineData中的input和output data的targetName是否在usecae拓扑中source Target和 sink Target的targetName match.</span><br><span class="line">    </span><br><span class="line">   *pSinkPortData push_back(pInternalLinkDesc[linkPortIdx].pSinkPort)---&gt; pInputPortData ----- sourceTarget</span><br><span class="line">   </span><br><span class="line">                                                                          pOutputPortData ----- sinkTarget</span><br><span class="line">                                                                          </span><br><span class="line">    PopulateDisabledStatus() RealTime : ZSLPreviewRaw_LT1080p:ZSL_In_Raw : Port Status : <span class="number">1</span> = &gt; <span class="number">0</span> SrcPort : (Raw_Out)</span><br><span class="line">    PopulateDisabledStatus() RealTime : ZSLPreviewRaw_LT1080p:ZSL_In_FD : Port Status : <span class="number">1</span> = &gt; <span class="number">1</span> SrcPort : (Fd_Out)</span><br><span class="line">    PopulateDisabledStatus() RealTime : ZSLPreviewRaw_LT1080p:MFHDR_long_raw_In : Port Status : <span class="number">1</span> = &gt; <span class="number">1</span> SrcPort : (MFHDR_ZSL_In_Long_Raw_out))</span><br><span class="line">    PopulateDisabledStatus() RealTime : ZSLPreviewRaw_LT1080p:MFHDR_short_raw_In : Port Status : <span class="number">1</span> = &gt; <span class="number">1</span> SrcPort : (MFHDR_ZSL_In_Short_Raw_out)</span><br><span class="line">    </span><br><span class="line">    h.针对pSinkTarget和pSrcTarget，进行AssignStreams和AssignTargets，这个时候会有一个对应关系。匹配规则如下</span><br><span class="line">        <span class="number">1.</span>对应关系   pInputPortData ----- sourceTarget</span><br><span class="line">                     pOutputPortData ----- sinkTarget</span><br><span class="line">        <span class="number">2.</span>从PortData中找到和Single Target 中target name一致的port（但是Raw_Out 和 Raw_Callback pTargetName一致，会造成共享一个result stream ），然后针对这个target进行流分配，调用AssignStreams，先申请result stream空间，然后将feature instance 要处理的stream <span class="built_in">int</span>ent和port 支持的stream <span class="built_in">int</span>ent匹配，将匹配成功的stream用pStreamMatched数组标记。将匹配的stream地址赋值给target stream,同时将target stream指向的空间复制到result stream申请的空间</span><br><span class="line">        </span><br><span class="line">        GetTargetStreamWithIntent() MATCHED: CHI_STREAM_INTENT_PREVIEW <span class="keyword">for</span> Target: TARGET_BUFFER_DISPLAY ChiStream: <span class="number">0xb400007402c56488</span> format: <span class="number">34</span> width: <span class="number">1440</span> height: <span class="number">1080</span></span><br><span class="line">        </span><br><span class="line">        GetTargetStreamWithIntent() Feature2Mapping: Target Stream: TARGET_BUFFER_DISPLAY <span class="number">0xb400007402c56488</span> Intent: CHI_STREAM_INTENT_PREVIEW Resolution: <span class="number">1440</span> X <span class="number">1080</span> Format = <span class="number">34</span></span><br><span class="line">        </span><br><span class="line">        GetTargetStreamWithIntent() FeatureStreamMapping: TargetName = TARGET_BUFFER_DISPLAY StreamPtr:<span class="number">0xb4000073e2c91110</span> Intent: CHI_STREAM_INTENT_PREVIEW Resolution = <span class="number">1440</span>X1080 Format = <span class="number">34</span> Direction = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        InitializeTargetStream() Add feature <span class="number">0</span> Target TARGET_BUFFER_DISPLAY instance <span class="number">0</span> stream <span class="number">0xb400007402c56488</span>, cameraId <span class="number">0</span></span><br><span class="line">        InitializeTargetStream() RealTime: Target:TARGET_BUFFER_DISPLAY, PortKey:Display_Out:<span class="number">0</span>:<span class="number">0</span>:<span class="number">0</span>:<span class="number">3</span> stream:target:<span class="number">0xb4000073e2c91110</span>:<span class="number">0xb400007402c56488</span>Stream: <span class="number">1440</span> X <span class="number">1080</span>:<span class="number">0x22</span>:<span class="number">0</span>:<span class="number">0x900</span>:<span class="number">1</span></span><br><span class="line">        chifeature2base.cpp:<span class="number">8289</span> AssignStreams() RealTime: Assign Stream (<span class="number">0xb4000073e2c91110</span>): Target = TARGET_BUFFER_DISPLAY resolution <span class="number">1440</span>x1080 format <span class="number">0x22</span> usage <span class="number">900</span> type <span class="number">0</span></span><br><span class="line">        <span class="number">3.</span>AssignTargets针对rDstPortData.pTarget为空且target name相同的，同步pTargetDesc的pTarget和pTarget-&gt;pChiStream（用来buffer回调的result stream）到rDstPortData</span><br><span class="line">        </span><br><span class="line">        RealTime: Output Port: (<span class="number">0</span>:<span class="number">0</span>:<span class="number">0</span>) : Display_Out : target: TARGET_BUFFER_DISPLAY stream:<span class="number">0xb4000073e2c91110</span> targetStream:<span class="number">0xb4000073e2c91110</span>Res:<span class="number">1440</span>X1080</span><br><span class="line">        </span><br><span class="line">    i. OnInitialize注册feature instance PCR处理函数SubmitRequestJob</span><br><span class="line">    j. OnConfigureOutputPorts <span class="comment">//配置规则todo，未见log打印</span></span><br><span class="line">    k. ConfigurePipelineData <span class="comment">//创建pipeline并OnConfigureInputPorts 配置规则todo，未见配置log打印。</span></span><br><span class="line">    l. 此时feature instance实例 状态机设置为ChiFeature2Status::Configured</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 基于feature input requirement更新 feature output requirement <span class="comment">//规则todo log未见打印</span></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> 调用FinalizeInitialization</span><br><span class="line">   FinalizeInitialization() finalize initialization RealTime</span><br><span class="line">   </span><br><span class="line">   这里通过rFinalizedInputs和finalizedOutputs， InternalLinks来实现不同feature pipeline相连端口的Assgin stream尺寸的一致性。</span><br><span class="line">   </span><br><span class="line">    chifeature2featurepool.cpp:<span class="number">1006</span> FinalizeFeatureInstances() [RealTime:<span class="number">0</span>] Output Port &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&#125; influences [Bayer2Yuv:<span class="number">0</span>] Input Port &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;(Fmt: <span class="number">0x25</span> [<span class="number">4208</span> x <span class="number">3120</span>])</span><br><span class="line">    chifeature2featurepool.cpp:<span class="number">1006</span> FinalizeFeatureInstances() [RealTime:<span class="number">0</span>] Output Port &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&#125; influences [Bayer2Yuv:<span class="number">8</span>] Input Port &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;(Fmt: <span class="number">0x25</span> [<span class="number">4208</span> x <span class="number">3120</span>])</span><br><span class="line">    chifeature2featurepool.cpp:<span class="number">1006</span> FinalizeFeatureInstances() [RealTime:<span class="number">0</span>] Output Port &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&#125; influences [RawHDR:<span class="number">0</span>] Input Port &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;(Fmt: <span class="number">0x25</span> [<span class="number">4208</span> x <span class="number">3120</span>])</span><br><span class="line">    chifeature2featurepool.cpp:<span class="number">1006</span> FinalizeFeatureInstances() [Bayer2Yuv:<span class="number">0</span>] Output Port &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125; influences [JPEG:<span class="number">0</span>] Input Port &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;(Fmt: <span class="number">0x23</span> [<span class="number">4160</span> x <span class="number">3120</span>])</span><br><span class="line">    chifeature2featurepool.cpp:<span class="number">1006</span> FinalizeFeatureInstances() [Bayer2Yuv:<span class="number">0</span>] Output Port &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125; influences [HDR:<span class="number">0</span>] Input Port &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;(Fmt: <span class="number">0x23</span> [<span class="number">4160</span> x <span class="number">3120</span>])</span><br><span class="line"></span><br><span class="line">   a.通过FinalizeSessionData 创建 非defer session </span><br><span class="line">   camxsession.cpp:<span class="number">2345</span> Initialize() Session (<span class="number">0xb40000732e345040</span>) Initialized ZSLPreviewRaw_L     T1080p</span><br><span class="line">   </span><br><span class="line">   b.给每一条pipeline的OutputMeta和SettingMeta,pipeline上port创建TBM. 正好对应<span class="number">6</span>条stream的<span class="number">6</span>个port</span><br><span class="line">   CreateTargetBufferManagers() metamanagerName:SettingTargetBuffer_ZSLPreviewRaw_LT1080p pSettingMetaTbm:<span class="number">0xb400007472cc78b0</span></span><br><span class="line">   CreateTargetBufferManagers() Pipeline[ZSLPreviewRaw_LT1080p][<span class="number">0</span>], port:Display_Out port idx:<span class="number">0</span>, Create CHI buffers, chistream:<span class="number">0xb4000073e2c91110</span>, format:<span class="number">34</span>, w x h: <span class="number">1440</span> x <span class="number">1080</span> usage <span class="number">20900</span> prd flags <span class="number">20000</span> cons flags <span class="number">40000</span>Min:<span class="number">0</span> Max:</span><br><span class="line">   CreateTargetBufferManagers() isChiFenceEnabled:<span class="number">0</span>, RealTime: PortTargetBuffer_RealTime:Display_Out_0: Res: <span class="number">1440</span>X1080 Format = <span class="number">0X22</span>, Min Buffer = <span class="number">0</span>, Max Buffer = <span class="number">8</span>, isChiGrallocBufferUsed=<span class="number">0</span></span><br><span class="line">   CreateTargetBufferManagers() Pipeline[ZSLPreviewRaw_LT1080p][<span class="number">0</span>], port:Raw_Out port idx:<span class="number">1</span>, Create CHI buffers, chistream:<span class="number">0xb4000073e2c926f0</span>, format:<span class="number">37</span>, w x h: <span class="number">4208</span> x <span class="number">3120</span> usage <span class="number">20002</span> prd flags <span class="number">20000</span> cons flags <span class="number">40000</span>Min:<span class="number">9</span> Max:<span class="number">64</span></span><br><span class="line">   CreateTargetBufferManagers() isChiFenceEnabled:<span class="number">0</span>, RealTime: PortTargetBuffer_RealTime:Raw_Out_0: Res: <span class="number">4208</span>X3120 Format = <span class="number">0X25</span>, Min Buffer = <span class="number">9</span>, Max Buffer = <span class="number">64</span>, isChiGrallocBufferUsed=</span><br><span class="line">   CreateTargetBufferManagers() Pipeline[ZSLPreviewRaw_LT1080p][<span class="number">0</span>], port:Video_Out port idx:<span class="number">3</span>, Create CHI buffers, chistream:<span class="number">0xb4000073e2c92680</span>, format:<span class="number">35</span>, w x h: <span class="number">1440</span> x <span class="number">1080</span> usage <span class="number">20000</span> prd flags <span class="number">20000</span> cons flags <span class="number">40000</span>Min:<span class="number">0</span> Max:<span class="number">8</span></span><br><span class="line">   CreateTargetBufferManagers() isChiFenceEnabled:<span class="number">0</span>, RealTime: PortTargetBuffer_RealTime:Video_Out_0: Res: <span class="number">1440</span>X1080 Format = <span class="number">0X23</span>, Min Buffer = <span class="number">0</span>, Max Buffer = <span class="number">8</span>, isChiGrallocBufferUsed=<span class="number">0</span></span><br><span class="line">   CreateTargetBufferManagers() Pipeline[ZSLPreviewRaw_LT1080p][<span class="number">0</span>], port:Yuv_Out port idx:<span class="number">6</span>, Create CHI buffers, chistream:<span class="number">0xb4000073e2c91340</span>, format:<span class="number">35</span>, w x h: <span class="number">640</span> x <span class="number">480</span> usage <span class="number">20000</span> prd flags <span class="number">20000</span> cons flags <span class="number">40000</span>Min:<span class="number">0</span> Max:<span class="number">8</span></span><br><span class="line">   CreateTargetBufferManagers() isChiFenceEnabled:<span class="number">0</span>, RealTime: PortTargetBuffer_RealTime:Yuv_Out_0: Res: <span class="number">640</span>X480 Format = <span class="number">0X23</span>, Min Buffer = <span class="number">0</span>, Max Buffer = <span class="number">8</span>, isChiGrallocBufferUsed=<span class="number">0</span></span><br><span class="line">   CreateTargetBufferManagers() Pipeline[ZSLPreviewRaw_LT1080p][<span class="number">0</span>], port:PostView_Out port idx:<span class="number">7</span>, Create CHI buffers, chistream:<span class="number">0xb4000073e2c95c50</span>, format:<span class="number">35</span>, w x h: <span class="number">320</span> x <span class="number">240</span> usage <span class="number">20000</span> prd flags <span class="number">20000</span> cons flags <span class="number">40000</span>Min:<span class="number">0</span> Max:<span class="number">8</span></span><br><span class="line">   CreateTargetBufferManagers() isChiFenceEnabled:<span class="number">0</span>, RealTime: PortTargetBuffer_RealTime:PostView_Out_0: Res: <span class="number">320</span>X240 Format = <span class="number">0X23</span>, Min Buffer = <span class="number">0</span>, Max Buffer = <span class="number">8</span>, isChiGrallocBufferUsed=<span class="number">0</span></span><br><span class="line">   CreateTargetBufferManagers() Pipeline[ZSLPreviewRaw_LT1080p][<span class="number">0</span>], port:IDEALRaw_Out port idx:<span class="number">14</span>, Create CHI buffers, chistream:<span class="number">0xb4000073e2c93870</span>, format:<span class="number">32</span>, w x h: <span class="number">4096</span> x <span class="number">3072</span> usage <span class="number">20002</span> prd flags <span class="number">20000</span> cons flags <span class="number">40000</span>Min:<span class="number">0</span> Max:<span class="number">8</span></span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   Raw_Out 和 Raw_Callback pTargetName一致，会造成共享一个result stream，一个TBM</span><br><span class="line">   </span><br><span class="line">   FinalizeSessionData() RealTime Raw_Out pushing back output stream(<span class="number">0xb4000073e2c926f0</span>) fmt <span class="number">0x25</span> dims <span class="keyword">from</span> [<span class="number">4208</span> x <span class="number">3120</span>]</span><br><span class="line">   FinalizeSessionData() RealTime Raw_Callback pushing back output stream(<span class="number">0xb4000073e2c926f0</span>) fmt <span class="number">0x25</span> dims <span class="keyword">from</span> [<span class="number">4208</span> x <span class="number">3120</span>]</span><br><span class="line">   CreateTargetBufferManagers() Linking port Raw_Out -&gt; Raw_Callback</span><br><span class="line">   CreateTargetBufferManagers() Feature: RealTime Sharing TBM <span class="keyword">for</span> port Raw_Callback</span><br><span class="line">   BuildLinkedPortListForPort() LinkedPort:pPort_Raw_Out:(<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>)-&gt;rPort_Raw_Callback[<span class="number">4</span>]:(<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>)</span><br><span class="line">   BuildLinkedPortListForPort() LinkedPort:pPort_Raw_Callback:(<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>)-&gt;rPort_Raw_Out[<span class="number">1</span>]:(<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   c.PrepareStageData<span class="comment">//其实并没有做实际性的工作，根据Feature Instance Desc和Stage Desc，已经建立好的SessionData，PipelineData匹配检查</span></span><br><span class="line">   </span><br><span class="line">   d.PostJob m_hAsyncFeatureJob 建立defer session</span><br><span class="line">   e. m_pStreamData的构建 见图</span><br><span class="line"></span><br><span class="line">   f.创建RequestThread线程 flush wait feature instance.</span><br><span class="line">   g.feature instance 状态机设置为ChiFeature2Status::Finalized</span><br></pre></td></tr></table></figure><h4 id="TBM的创建"><a href="#TBM的创建" class="headerlink" title="TBM的创建"></a>TBM的创建</h4><p>对F2W的input stream（双摄的RDI.FD）和 fk stream 和metadata TBM绑定</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chifeature2wrapper.cpp:1804 CreateTargetBufferManagers() Framework Target Buffer Manager [<span class="string">FWK_34_TBM</span>][<span class="symbol">0xb400007472c8e1f0</span>] created. stream=0xb400007402c56488 type=0 format=34</span><br><span class="line"></span><br><span class="line">chifeature2wrapper.cpp:1804 CreateTargetBufferManagers() Framework Target Buffer Manager [<span class="string">FWK_33_TBM</span>][<span class="symbol">0xb400007472c99730</span>] created. stream=0xb400007402c81c48 type=0 format=33</span><br><span class="line"></span><br><span class="line">chifeature2wrapper.cpp:1842 CreateTargetBufferManagers() Wrapper meta target buffer created 0xb400007472cdaaf0 ,physicalCamIdx:0 </span><br></pre></td></tr></table></figure><p><a id="3"></a></p><h3 id="feature-instance连接"><a href="#feature-instance连接" class="headerlink" title="feature instance连接"></a>feature instance连接</h3><ul><li><a href="#0">返回主目录</a><br><a href="https://sholck.top/archives/8a2ade19.html">feature instance connect</a></li></ul><p><a id="4"></a></p><h3 id="feature-PCR"><a href="#feature-PCR" class="headerlink" title="feature-PCR"></a>feature-PCR</h3><ul><li><a href="#0">返回主目录</a><br><a href="https://sholck.top/archives/8a2ade1a.html">feature2-PCR</a></li></ul><p><a id="5"></a></p><h3 id="TBM详解"><a href="#TBM详解" class="headerlink" title="TBM详解"></a>TBM详解</h3><ul><li><a href="#0">返回主目录</a></li></ul><p><a id="6"></a></p><h3 id="TM详解"><a href="#TM详解" class="headerlink" title="TM详解"></a>TM详解</h3><ul><li><a href="#0">返回主目录</a></li></ul></div><div class="popular-posts-header">推荐文章</div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/8a2ade19.html" rel="bookmark">Camx-Feature2-featureInstanceConnect</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/8a2ade1a.html" rel="bookmark">Feature2-PCR</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/8a2ade16.html" rel="bookmark">session flush timeout学习</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/8a2ade15.html" rel="bookmark">单&双摄configure stream流程</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/8a2ade14.html" rel="bookmark">单&双摄预览控制流详解</a></div></li></ul><footer class="post-footer"><div class="post-tags"><a href="/tags/Camera-Camx/" rel="tag"># Camera-Camx</a> <a href="/tags/Feature2/" rel="tag"># Feature2</a></div><div class="post-nav"><div class="post-nav-item"><a href="/archives/8a2ade17.html" rel="prev" title="生产力工具记录"><i class="fa fa-chevron-left"></i> 生产力工具记录</a></div><div class="post-nav-item"><a href="/archives/8a2ade1a.html" rel="next" title="Feature2-PCR">Feature2-PCR <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Feature2"><span class="nav-number">1.</span> <span class="nav-text">Feature2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#feature2%E6%A1%86%E6%9E%B6%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.1.</span> <span class="nav-text">feature2框架介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#configure-stream"><span class="nav-number">1.2.</span> <span class="nav-text">configure_stream</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Feature2Wrapper%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="nav-number">1.2.1.</span> <span class="nav-text">Feature2Wrapper的创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FGM%E5%92%8CTBM%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="nav-number">1.2.2.</span> <span class="nav-text">FGM和TBM的创建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#FGM%E5%88%9B%E5%BB%BA"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">FGM创建</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#FGS%E5%88%9B%E5%BB%BA"><span class="nav-number">1.2.2.1.1.</span> <span class="nav-text">FGS创建</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#FPM%E5%88%9B%E5%BB%BA-%E5%8F%82%E6%95%B0%E4%BC%A0%E5%85%A5FGS%E8%AE%BE%E7%BD%AE%E7%9A%84m-featureDescNameSet"><span class="nav-number">1.2.2.1.2.</span> <span class="nav-text">FPM创建 参数传入FGS设置的m_featureDescNameSet</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#TM%EF%BC%88CHIThreadManage%EF%BC%89%E5%88%9B%E5%BB%BA"><span class="nav-number">1.2.2.1.3.</span> <span class="nav-text">TM（CHIThreadManage）创建</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#FGD%E5%8C%B9%E9%85%8D"><span class="nav-number">1.2.2.1.4.</span> <span class="nav-text">FGD匹配</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Feature-Instance%E6%95%B4%E5%90%88"><span class="nav-number">1.2.2.1.5.</span> <span class="nav-text">Feature Instance整合</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#feature-instance-create%E2%80%93-gt-Finalized"><span class="nav-number">1.2.2.1.6.</span> <span class="nav-text">feature instance create–&gt;Finalized</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#feature-instace-create"><span class="nav-number">1.2.2.1.7.</span> <span class="nav-text">feature instace create</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#feature-instance-configure-amp-finialize"><span class="nav-number">1.2.2.1.8.</span> <span class="nav-text">feature instance configure&amp;finialize</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TBM%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">TBM的创建</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#feature-instance%E8%BF%9E%E6%8E%A5"><span class="nav-number">1.2.3.</span> <span class="nav-text">feature instance连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#feature-PCR"><span class="nav-number">1.2.4.</span> <span class="nav-text">feature-PCR</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TBM%E8%AF%A6%E8%A7%A3"><span class="nav-number">1.2.5.</span> <span class="nav-text">TBM详解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TM%E8%AF%A6%E8%A7%A3"><span class="nav-number">1.2.6.</span> <span class="nav-text">TM详解</span></a></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">Sholck</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">8</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">3</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">13</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/xiaer1921" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiaer1921" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:xiaer1921@aliyun.com" title="E-Mail → mailto:xiaer1921@aliyun.com" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/sholck222" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;sholck222" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa-fw"></i>CSDN</a></span></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://hackret.com/" title="https:&#x2F;&#x2F;hackret.com&#x2F;" rel="noopener external nofollow noreferrer" target="_blank">RedHat Kairui</a></li><li class="links-of-blogroll-item"><a href="https://linux-kernel-labs.github.io/refs/heads/master/index.html#" title="https:&#x2F;&#x2F;linux-kernel-labs.github.io&#x2F;refs&#x2F;heads&#x2F;master&#x2F;index.html#" rel="noopener external nofollow noreferrer" target="_blank">Linux Kernel Teaching</a></li><li class="links-of-blogroll-item"><a href="https://tding.top/" title="https:&#x2F;&#x2F;tding.top&#x2F;" rel="noopener external nofollow noreferrer" target="_blank">小丁</a></li><li class="links-of-blogroll-item"><a href="https://xiaozhou.net/" title="https:&#x2F;&#x2F;xiaozhou.net&#x2F;" rel="noopener external nofollow noreferrer" target="_blank">iTimpthy</a></li></ul></div><div><canvas id="canvas" style="width:60%">当前浏览器不支持canvas，请更换浏览器后再试</canvas></div><script>!function(){var o,a,r,f,t,i=[[[0,0,1,1,1,0,0],[0,1,1,0,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,0,1,1,0],[0,0,1,1,1,0,0]],[[0,0,0,1,1,0,0],[0,1,1,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[1,1,1,1,1,1,1]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,1,1,0,0,0],[0,1,1,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,0,0,1,1],[1,1,1,1,1,1,1]],[[1,1,1,1,1,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,1,1,0],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,0,0,0,1,1,0],[0,0,0,1,1,1,0],[0,0,1,1,1,1,0],[0,1,1,0,1,1,0],[1,1,0,0,1,1,0],[1,1,1,1,1,1,1],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,1,1,1,1]],[[1,1,1,1,1,1,1],[1,1,0,0,0,0,0],[1,1,0,0,0,0,0],[1,1,1,1,1,1,0],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,0,0,0,1,1,0],[0,0,1,1,0,0,0],[0,1,1,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[1,1,1,1,1,1,1],[1,1,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,1,1,0,0,0,0]],[[0,0,0,0,0,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,0,0,0]]],e=document.getElementById("canvas");function h(t,e){for(var n=[1,2,3],l=["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"],o=0;o<i[e].length;o++)for(var a,h=0;h<i[e][o].length;h++){1==i[e][o][h]&&(a={x:14*(f+2)*t+2*h*(f+1)+(f+1),y:2*o*(f+1)+(f+1),stepX:Math.floor(4*Math.random()-2),stepY:-2*n[Math.floor(Math.random()*n.length)],color:l[Math.floor(Math.random()*l.length)],disY:1},r.push(a))}}function n(){e.height=100;for(var t=0;t<a.length;t++)!function(t,e){for(var n=0;n<i[e].length;n++)for(var l=0;l<i[e][n].length;l++)1==i[e][n][l]&&(o.beginPath(),o.arc(14*(f+2)*t+2*l*(f+1)+(f+1),2*n*(f+1)+(f+1),f,0,2*Math.PI),o.closePath(),o.fill())}(t,a[t]);for(t=0;t<r.length;t++)o.beginPath(),o.arc(r[t].x,r[t].y,f,0,2*Math.PI),o.fillStyle=r[t].color,o.closePath(),o.fill()}e.getContext&&(o=e.getContext("2d"),e.height=100,e.width=700,o.fillStyle="#f00",o.fillRect(10,10,50,50),a=[],r=[],f=e.height/20-1,t=/(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date),a.push(t[1],t[2],10,t[3],t[4],10,t[5],t[6]),clearInterval(void 0),setInterval(function(){!function(){var t=[],e=/(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date),n=[];n.push(e[1],e[2],10,e[3],e[4],10,e[5],e[6]);for(var l=a.length-1;0<=l;l--)n[l]!==a[l]&&t.push(l+"_"+(Number(a[l])+1)%10);for(l=0;l<t.length;l++)h.apply(this,t[l].split("_"));a=n.concat()}(),function(){for(var t=0;t<r.length;t++)r[t].stepY+=r[t].disY,r[t].x+=r[t].stepX,r[t].y+=r[t].stepY,(r[t].x>700+f||r[t].y>100+f)&&(r.splice(t,1),t--)}(),n()},50))}()</script><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-history fa-" aria-hidden="true"></i> 近期文章</div><ul class="links-of-blogroll-list"><li><a href="/archives/8a2ade1b.html" title="内核实践1-linux5.12.0-rc8" target="_blank">内核实践1-linux5.12.0-rc8</a></li><li><a href="/archives/8a2ade1a.html" title="Feature2-PCR" target="_blank">Feature2-PCR</a></li><li><a href="/archives/8a2ade18.html" title="Camx-Feature2" target="_blank">Camx-Feature2</a></li><li><a href="/archives/8a2ade17.html" title="生产力工具记录" target="_blank">生产力工具记录</a></li><li><a href="/archives/8a2ade16.html" title="session flush timeout学习" target="_blank">session flush timeout学习</a></li></ul></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2020 – <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="user"></i> </span><span class="author" itemprop="copyrightHolder">Sholck</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-chart-area"></i> </span><span class="post-meta-item-text">站点总字数：</span> <span title="站点总字数">93k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">1:25</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener external nofollow noreferrer" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener external nofollow noreferrer" target="_blank">NexT.Muse</a> 强力驱动</div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><script async src="/js/cursor/fireworks.js"></script><script src="/js/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,document.body.addEventListener("input",POWERMODE)</script></body></html>